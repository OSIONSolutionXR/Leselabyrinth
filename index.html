<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leselabyrinth ‚Äì OSION Solution XR</title>

  <style>
    :root{
      /* Hintergrund bleibt ‚ÄúMuseum‚Äù-m√§√üig, Board wird kinderfreundlich */
      --bg1:#0b1020;
      --bg2:#0c1330;

      /* Kinder-Palette */
      --kidBlue:#2fd9ff;
      --kidYellow:#ffd33d;
      --kidGreen:#7cff6b;
      --kidPink:#ff5dd8;
      --kidPurple:#7a3cff;
      --kidRed:#ff5a7a;

      --txt:#f4f8ff;
      --muted:#c7d3ff;

      --panel: rgba(18, 26, 56, .78);
      --panel2: rgba(10, 16, 40, .50);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.22);

      --good:#43e08b;
      --bad:#ff5a7a;

      --radius: 22px;
      --radius2: 18px;

      --shadow: 0 18px 60px rgba(0,0,0,.30);
      --shadowIn: 0 18px 45px rgba(0,0,0,.25) inset;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:
        radial-gradient(1000px 600px at 14% 10%, rgba(122,60,255,.25), transparent 60%),
        radial-gradient(1000px 600px at 90% 12%, rgba(255,93,216,.18), transparent 60%),
        radial-gradient(1000px 600px at 55% 120%, rgba(47,217,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* dezente Sternchen-Textur */
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.20;
      background-image:
        radial-gradient(circle, rgba(255,255,255,.14) 1px, transparent 1.5px),
        radial-gradient(circle, rgba(255,255,255,.10) 1px, transparent 1.5px);
      background-size: 86px 86px, 140px 140px;
      background-position: 10px 15px, 40px 60px;
      filter: blur(.2px);
    }

    header{
      position:sticky; top:0; z-index:50;
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      background: rgba(11,16,32,.86);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .brand b{
      font-size:14px; letter-spacing:.8px;
      background: linear-gradient(90deg, #ff2d55, #7a3cff);
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
      font-weight:950;
    }
    .brand span{ font-size:12px; color:var(--muted); opacity:.95; }

    .top-actions{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-end; align-items:center;
    }
    button{
      appearance:none;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
    }
    button:hover{ border-color: rgba(255,255,255,.24); transform: translateY(-1px); }
    button:active{ transform: translateY(0px) scale(.99); filter: brightness(.98); }
    button.primary{
      border:none;
      background: linear-gradient(90deg, rgba(255,45,85,.95), rgba(122,60,255,.95));
      box-shadow: 0 14px 32px rgba(122,60,255,.18);
    }

    main{
      padding:16px;
      max-width:1120px;
      margin:0 auto;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }

    .layout{
      display:grid;
      grid-template-rows:auto 1fr;
      gap:14px;
    }

    /* =======================
       TOP BAR (Guide + Stats + Map)
       ======================= */
    .guidebar{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1.7fr;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .guidebar{ grid-template-columns: 1fr; }
    }

    .box{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background:
        radial-gradient(350px 100px at 15% 15%, rgba(47,217,255,.10), transparent 60%),
        radial-gradient(350px 100px at 85% 25%, rgba(255,211,61,.08), transparent 60%),
        rgba(12,18,44,.55);
      padding:12px;
    }

    .guide{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .avatar{
      width:62px; height:62px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 50%),
        linear-gradient(135deg, rgba(47,217,255,.40), rgba(255,211,61,.28)),
        linear-gradient(135deg, rgba(255,93,216,.35), rgba(122,60,255,.35));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      letter-spacing:.5px;
      color:rgba(255,255,255,.96);
      flex:0 0 auto;
      box-shadow: 0 12px 28px rgba(0,0,0,.22);
    }
    .speech{
      flex:1;
      padding:12px 12px;
      border-radius: var(--radius2);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      line-height:1.35;
      font-size:14px;
      min-height:62px;
    }

    .pills{
      margin-top:10px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 11px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size:12.5px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* Sterne-Anzeige: Ziel f√ºr Animation */
    .pill.stars{
      border-color: rgba(255,211,61,.32);
      background:
        radial-gradient(220px 48px at 30% 30%, rgba(255,211,61,.20), transparent 60%),
        rgba(255,255,255,.05);
      position:relative;
      overflow:hidden;
    }
    .pill.stars.pulse{ animation: starPulse .45s ease; }
    @keyframes starPulse{
      0%{ transform: scale(1); }
      45%{ transform: scale(1.10); }
      100%{ transform: scale(1); }
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      min-height:62px;
    }
    .stat b{
      display:block;
      font-size:12.5px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
      font-weight:950;
    }
    .stat span{ color:var(--muted); font-size:12.5px; }

    .mapwrap{ display:flex; flex-direction:column; gap:10px; }
    .maphead{
      display:flex; justify-content:space-between;
      gap:10px; align-items:center; flex-wrap:wrap;
    }
    .maphead b{ font-size:13px; }
    .maphead span{ font-size:12px; color:var(--muted); }

    .map{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
      -webkit-overflow-scrolling: touch;
    }
    .node{
      min-width: 190px;
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background:
        radial-gradient(260px 70px at 12% 22%, rgba(47,217,255,.12), transparent 60%),
        radial-gradient(260px 70px at 85% 65%, rgba(255,211,61,.10), transparent 60%),
        rgba(255,255,255,.03);
      padding:10px 12px;
      cursor:pointer;
      flex:0 0 auto;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    }
    .node:hover{ border-color: rgba(255,255,255,.26); transform: translateY(-1px); }
    .node.locked{ opacity:.45; cursor:not-allowed; filter: grayscale(.08); }
    .node.done{
      border-color: rgba(67,224,139,.35);
      background:
        radial-gradient(260px 70px at 12% 22%, rgba(124,255,107,.14), transparent 60%),
        rgba(67,224,139,.10);
    }
    .node small{ color:var(--muted); display:block; margin-bottom:4px; }
    .node b{ display:block; font-size:13px; font-weight:950; }

    /* =======================
       BOTTOM CONTENT
       ======================= */
    .content{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .titleRow{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; flex-wrap:wrap;
    }
    .titleRow h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      font-weight:950;
    }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(10,16,40,.52);
      padding:14px;
      position:relative;
      overflow:hidden;
    }

    .scene{
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .scene .meta{ display:flex; flex-direction:column; gap:2px; }
    .scene .meta small{ color:var(--muted); font-size:12.5px; }
    .scene .meta b{ font-size:18px; font-weight:1000; }

    /* Leseblock: sehr gro√ü + Fokus */
    .readingBox{
      border-radius: var(--radius);
      border:2px solid rgba(255,255,255,.20);
      background:
        radial-gradient(900px 220px at 0% 0%, rgba(47,217,255,.20), transparent 55%),
        radial-gradient(900px 220px at 100% 0%, rgba(255,211,61,.18), transparent 55%),
        rgba(255,255,255,.04);
      padding:18px;
      margin:12px 0 14px;
      box-shadow: var(--shadowIn);
      position:relative;
      overflow:hidden;
    }
    .readingBox:after{
      content:"";
      position:absolute;
      top:-40%;
      left:-60%;
      width:60%;
      height:180%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent);
      transform: rotate(18deg);
      animation: gentleShine 6.2s linear infinite;
      opacity:.55;
      pointer-events:none;
    }
    @keyframes gentleShine{
      0%{ transform: translateX(0) rotate(18deg); }
      100%{ transform: translateX(260%) rotate(18deg); }
    }

    .readingLabel{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .readingLabel b{
      font-size:13px;
      letter-spacing:.35px;
      text-transform:uppercase;
      color:rgba(255,255,255,.92);
      display:flex; align-items:center; gap:8px;
      font-weight:1000;
    }
    .readingLabel b:before{ content:"üìñ"; }
    .readingHint{
      color:var(--muted);
      font-size:12.5px;
    }

    /* Gr√∂√üer f√ºr Desktop, weil du genau das willst */
    .text{
      font-size:30px;
      line-height:1.75;
      font-weight:1000;
      letter-spacing:.15px;
      text-shadow: 0 10px 24px rgba(0,0,0,.22);
    }
    @media (max-width: 700px){
      .text{ font-size:22px; }
    }

    .question{
      font-weight:1000;
      margin:12px 0 12px;
      font-size:22px;
      display:flex;
      align-items:center;
      gap:10px;
      color: rgba(255,255,255,.97);
    }
    .question .qicon{
      width:28px; height:28px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
    }

    /* Antwort-Buttons: bunter + kindgerecht + animiert */
    .answers{
      display:grid;
      gap:12px;
      margin-top:10px;
    }

    .option{
      position:relative;
      width:100%;
      text-align:left;
      padding:16px 16px;
      border-radius: 20px;
      font-size:18px;
      font-weight:950;
      border:2px solid rgba(255,255,255,.14);
      background:
        radial-gradient(260px 70px at 12% 22%, rgba(47,217,255,.20), transparent 60%),
        radial-gradient(260px 70px at 85% 65%, rgba(255,211,61,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      overflow:hidden;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    }
    .option:before{
      content:"";
      position:absolute;
      top:-60%;
      left:-80%;
      width:60%;
      height:220%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: rotate(20deg);
      animation: shimmer 3.5s linear infinite;
      opacity:.45;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ transform: translateX(0) rotate(20deg); }
      100%{ transform: translateX(320%) rotate(20deg); }
    }
    .option:hover{
      border-color: rgba(255,255,255,.26);
      transform: translateY(-1px);
      filter: brightness(1.05);
    }
    .option:active{
      transform: translateY(0px) scale(.99);
      filter: brightness(.98);
    }

    /* Feedback Effekte */
    .option.correctFlash{
      border-color: rgba(67,224,139,.70);
      background:
        radial-gradient(260px 70px at 12% 22%, rgba(124,255,107,.26), transparent 60%),
        linear-gradient(180deg, rgba(67,224,139,.18), rgba(255,255,255,.02));
      animation: popGood .28s ease;
    }
    @keyframes popGood{
      0%{ transform: scale(1); }
      60%{ transform: scale(1.02); }
      100%{ transform: scale(1); }
    }

    .option.wrongFlash{
      border-color: rgba(255,90,122,.80);
      background:
        radial-gradient(260px 70px at 12% 22%, rgba(255,90,122,.26), transparent 60%),
        linear-gradient(180deg, rgba(255,90,122,.14), rgba(255,255,255,.02));
      animation: shake .28s ease;
    }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-6px); }
      50%{ transform: translateX(6px); }
      75%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }

    /* Helpers: nur ‚ÄúNochmal lesen‚Äù (Hinweis ist komplett raus) */
    .helpers{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }
    .helpers button{
      font-size:12.5px;
      padding:10px 12px;
      border-radius:999px;
      font-weight:950;
    }

    .hr{ height:1px; background:var(--stroke); margin:12px 0; }

    .feedback{
      padding:12px 14px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }

    .hidden{ display:none !important; }

    /* Diagnose */
    .table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      color:var(--txt);
    }
    .table td, .table th{
      border-bottom:1px solid var(--stroke);
      padding:8px 6px;
      text-align:left;
    }
    .table th{ color:var(--muted); font-weight:1000; }

    .good{ color:var(--good); font-weight:1000; }
    .bad{ color:var(--bad); font-weight:1000; }

    /* =======================
       MEGA STAR OVERLAY (Wow-Effekt)
       ======================= */
    .starOverlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index:9999;
      opacity:0;
      transition: opacity .10s ease;
    }
    .starOverlay.show{ opacity:1; }

    .megaStar{
      position:relative;
      font-size: 150px;
      transform: scale(.2) rotate(-12deg);
      opacity:0;
      filter: drop-shadow(0 22px 40px rgba(0,0,0,.35));
      animation: none;
    }
    .megaStar.play{
      animation: megaStarPop .62s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes megaStarPop{
      0%{ transform: scale(.2) rotate(-12deg); opacity:0; }
      55%{ transform: scale(1.12) rotate(6deg); opacity:1; }
      100%{ transform: scale(1) rotate(0deg); opacity:1; }
    }

    .sparkles{
      position:absolute;
      inset:-60px;
      pointer-events:none;
    }
    .sparkle{
      position:absolute;
      width:10px; height:10px;
      border-radius:999px;
      background: radial-gradient(circle, rgba(255,255,255,.95), rgba(255,255,255,0));
      filter: drop-shadow(0 12px 18px rgba(255,255,255,.18));
      opacity:0;
      animation: sparklePop .60s ease forwards;
    }
    @keyframes sparklePop{
      0%{ transform: translate(0,0) scale(.2); opacity:0; }
      40%{ opacity:1; }
      100%{ transform: translate(var(--dx), var(--dy)) scale(1.3); opacity:0; }
    }

    /* Stern fliegt danach zur Sterne-Pill */
    .flyStar{
      position:fixed;
      z-index:10000;
      font-size: 28px;
      pointer-events:none;
      filter: drop-shadow(0 14px 26px rgba(0,0,0,.35));
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      transition:
        transform .60s cubic-bezier(.2,.9,.2,1),
        left .60s cubic-bezier(.2,.9,.2,1),
        top .60s cubic-bezier(.2,.9,.2,1),
        opacity .60s ease;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <b>OSION Solution XR</b>
    <span>Leselabyrinth ¬∑ Adventure + AdaptiV + Diagnose</span>
  </div>
  <div class="top-actions">
    <button id="btnPlay" class="primary">Adventure</button>
    <button id="btnDash">Diagnose</button>
    <button id="btnReset">Reset</button>
  </div>
</header>

<!-- Mega Star Overlay -->
<div class="starOverlay" id="starOverlay" aria-hidden="true">
  <div class="megaStar" id="megaStar">‚≠ê
    <div class="sparkles" id="sparkles"></div>
  </div>
</div>

<main>
  <div class="layout">

    <!-- TOP -->
    <section class="panel">
      <div class="guidebar">

        <div class="box">
          <div class="guide">
            <div class="avatar" id="monsterAvatar">M</div>
            <div class="speech" id="monsterSpeech"></div>
          </div>

          <div class="pills">
            <span class="pill" id="uiHelp"></span>
            <span class="pill" id="uiProgress"></span>
            <span class="pill stars" id="uiStarsPill">‚≠ê Sterne: <b id="uiStarsCount" style="color:var(--txt)">0</b></span>
          </div>
        </div>

        <div class="box">
          <div class="stats">
            <div class="stat">
              <b>Stufe</b>
              <span id="uiLevel"></span>
            </div>
            <div class="stat">
              <b>Serie</b>
              <span id="uiStreak"></span>
            </div>
            <div class="stat">
              <b>Status</b>
              <span id="uiStatus"></span>
            </div>
            <div class="stat">
              <b>Fokus</b>
              <span id="uiFocusTop"></span>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="mapwrap">
            <div class="maphead">
              <b>Kapitel: Der Wald</b>
              <span>Tippe einen Knoten an. Neue Knoten werden freigeschaltet.</span>
            </div>
            <div class="map" id="map"></div>
          </div>
        </div>

      </div>
    </section>

    <!-- BOTTOM -->
    <section class="panel">
      <div class="content">

        <!-- PLAY VIEW -->
        <div id="viewPlay">
          <div class="titleRow">
            <h2>Lesekarte</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill" id="uiNodeState"></span>
              <span class="pill" id="uiNodeId"></span>
            </div>
          </div>

          <div class="card" id="card"></div>
        </div>

        <!-- COMPLETE VIEW -->
        <div id="viewComplete" class="hidden">
          <div class="titleRow">
            <h2>Kapitel abgeschlossen</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill"><span class="good">Stark</span></span>
              <span class="pill">‚≠ê Sterne: <b id="completeStars" style="color:var(--txt)">0</b></span>
            </div>
          </div>

          <div class="card">
            <div class="feedback" id="completeText"></div>
            <div class="hr"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button id="btnGoDash">Diagnose √∂ffnen</button>
              <button id="btnReplay" class="primary">Kapitel neu spielen</button>
            </div>
          </div>
        </div>

        <!-- DASH VIEW -->
        <div id="viewDash" class="hidden">
          <div class="titleRow">
            <h2>Diagnose-Dashboard</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill" id="dDone"></span>
              <span class="pill" id="dAcc"></span>
              <span class="pill" id="dTime"></span>
            </div>
          </div>

          <div class="card">
            <b style="display:block;margin-bottom:8px;">Fehlmuster (Top)</b>
            <table class="table">
              <thead><tr><th>Kategorie</th><th>Anzahl</th><th>Beispiel</th></tr></thead>
              <tbody id="dPatterns"></tbody>
            </table>

            <div class="hr"></div>

            <b style="display:block;margin-bottom:8px;">St√§rken & Fokus</b>
            <div class="feedback" id="dCoach"></div>
          </div>
        </div>

      </div>
    </section>

  </div>
</main>

<script>
/* =========================
   KONFIG
   ========================= */
const APP = {
  CHAPTER_ID: "wald_v1",
  MONSTER_NAME: "Momo",
  LEVEL_MIN: 1,
  LEVEL_MAX: 3,
  TARGET_STREAK_UP: 3
};

const STORE_KEY = "leselabyrinth_state_v4";

/* Fokus -> Icon (Hinweis ist raus, stattdessen Icon passend zur Frage) */
const FOCUS_ICON = {
  "W-Frage": "‚ùì",
  "Detail": "üëÄ",
  "Wortverwechslung": "üî§",
  "Satzverst√§ndnis": "üß†",
  "Ursache/Wirkung": "üîÅ"
};

/* Hilfen: Hinweis ist raus. Nur ‚ÄúNochmal lesen‚Äù bleibt als sanfte F√ºhrung. */
const HELP_RULES = {
  1: { rereadButton: true },
  2: { rereadButton: true },
  3: { rereadButton: true }
};

/* =========================
   CONTENT (IM CODE)
   - Jede Frage muss aus dem Text l√∂sbar sein.
   ========================= */
const CARDS = [
  {
    id:"n1",
    nodeTitle:"Start am Waldweg",
    focus:"W-Frage",
    textByLevel:{
      1:["Momo geht in den Wald.","Ein Vogel singt im Baum."],
      2:["Momo geht in den Wald.","Ein kleiner Vogel singt laut im Baum."],
      3:["Momo geht in den Wald.","Ein kleiner Vogel singt laut im Baum.","Momo bleibt kurz stehen."]
    },
    questionByLevel:{ 1:"Wo geht Momo hin?", 2:"Wo geht Momo hin?", 3:"Wo geht Momo hin?" },
    answersByLevel:{
      1:["In den Wald.","In die Stadt.","Ins Meer."],
      2:["In den Wald.","In die Stadt.","Ins Meer."],
      3:["In den Wald.","In die Stadt.","Ins Meer."]
    },
    correctIndex:0,
    hintText:"Im Text steht: Momo geht in den Wald."
  },
  {
    id:"n2",
    nodeTitle:"Die Holzbr√ºcke",
    focus:"Detail",
    textByLevel:{
      1:["Vor Momo ist eine Br√ºcke.","Die Br√ºcke ist aus Holz."],
      2:["Vor Momo ist eine kleine Br√ºcke.","Die Br√ºcke ist aus Holz."],
      3:["Vor Momo ist eine kleine Br√ºcke.","Die Br√ºcke ist aus Holz und wackelt leicht."]
    },
    questionByLevel:{ 1:"Woraus ist die Br√ºcke?", 2:"Woraus ist die Br√ºcke?", 3:"Woraus ist die Br√ºcke?" },
    answersByLevel:{
      1:["Aus Holz.","Aus Eis.","Aus Papier."],
      2:["Aus Holz.","Aus Eis.","Aus Papier."],
      3:["Aus Holz.","Aus Eis.","Aus Papier."]
    },
    correctIndex:0,
    hintText:"Im Text steht: Die Br√ºcke ist aus Holz."
  },
  {
    id:"n3",
    nodeTitle:"Der Apfelbaum",
    focus:"Wortverwechslung",
    textByLevel:{
      1:["Ein gr√ºner Apfel f√§llt runter.","Momo schaut nach oben."],
      2:["Ein gr√ºner Apfel f√§llt runter.","Momo schaut nach oben und l√§chelt."],
      3:["Ein gr√ºner Apfel f√§llt runter.","Momo schaut nach oben und l√§chelt.","Der Apfel rollt ins Gras."]
    },
    questionByLevel:{ 1:"Welche Farbe hat der Apfel?", 2:"Welche Farbe hat der Apfel?", 3:"Welche Farbe hat der Apfel?" },
    answersByLevel:{
      1:["Gr√ºn.","Blau.","Schwarz."],
      2:["Gr√ºn.","Blau.","Schwarz."],
      3:["Gr√ºn.","Blau.","Schwarz."]
    },
    correctIndex:0,
    hintText:"Im Text steht: gr√ºner Apfel."
  },
  {
    id:"n4",
    nodeTitle:"Der Schl√ºsselstein",
    focus:"Satzverst√§ndnis",
    textByLevel:{
      1:["Momo findet einen Stein.","Auf dem Stein ist ein Stern.","Der Stern glitzert."],
      2:["Momo findet einen Stein.","Auf dem Stein ist ein Stern.","Der Stern glitzert hell."],
      3:["Momo findet einen Stein.","Auf dem Stein ist ein Stern.","Der Stern glitzert hell im Licht."]
    },
    questionByLevel:{ 1:"Was ist auf dem Stein?", 2:"Was ist auf dem Stein?", 3:"Was ist auf dem Stein?" },
    answersByLevel:{
      1:["Ein Stern.","Ein Auto.","Ein Haus."],
      2:["Ein Stern.","Ein Auto.","Ein Haus."],
      3:["Ein Stern.","Ein Auto.","Ein Haus."]
    },
    correctIndex:0,
    hintText:"Im Text steht: Auf dem Stein ist ein Stern."
  },
  {
    id:"n5",
    nodeTitle:"Die Boss-T√ºr",
    focus:"Ursache/Wirkung",
    textByLevel:{
      1:["Vor Momo ist eine gro√üe T√ºr.","Momo braucht einen Schl√ºssel."],
      2:["Vor Momo ist eine gro√üe T√ºr.","Momo braucht einen Schl√ºssel.","Die T√ºr bleibt zu."],
      3:["Vor Momo ist eine gro√üe T√ºr.","Momo braucht einen Schl√ºssel.","Die T√ºr bleibt zu.","Momo sucht den Schl√ºsselstein."]
    },
    questionByLevel:{ 1:"Was braucht Momo?", 2:"Was braucht Momo?", 3:"Was braucht Momo?" },
    answersByLevel:{
      1:["Den Schl√ºssel.","Eine Leiter.","Einen Ball."],
      2:["Den Schl√ºssel.","Eine Leiter.","Einen Ball."],
      3:["Den Schl√ºssel.","Eine Leiter.","Einen Ball."]
    },
    correctIndex:0,
    hintText:"Im Text steht: Momo braucht einen Schl√ºssel."
  }
];

const MAP = {
  nodes: [
    { id:"n1", unlockFrom:null },
    { id:"n2", unlockFrom:"n1" },
    { id:"n3", unlockFrom:"n2" },
    { id:"n4", unlockFrom:"n3" },
    { id:"n5", unlockFrom:"n4" }
  ]
};

/* =========================
   STATE
   ========================= */
const defaultState = () => ({
  level: 1,
  stars: 0,
  currentNodeId: "n1",
  done: {},
  streakCorrect: 0,
  streakWrong: 0,
  chapterComplete: false,
  logs: []
});

let state = loadState();

/* pro Karte: merkt sich, ob schon ein Fehler passiert ist (f√ºr ‚Äûzweite Chance‚Äú Verhalten) */
let cardLocal = {
  attempts: 0,
  options: null,
  locked: false
};

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    return { ...defaultState(), ...s };
  }catch(e){
    return defaultState();
  }
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

const $ = (id) => document.getElementById(id);
function getCard(id){ return CARDS.find(c=>c.id===id); }
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function isUnlocked(nodeId){
  const node = MAP.nodes.find(n=>n.id===nodeId);
  if(!node) return false;
  if(node.unlockFrom===null) return true;
  return !!state.done[node.unlockFrom];
}
function allNodesDone(){
  return MAP.nodes.every(n=>!!state.done[n.id]);
}
function nextUnlockedUndoneNode(){
  for(const n of MAP.nodes){
    if(isUnlocked(n.id) && !state.done[n.id]) return n.id;
  }
  return null;
}

/* =========================
   Guide / Monster
   ========================= */
function setMonster(text, mood="neutral"){
  $("monsterAvatar").textContent = (APP.MONSTER_NAME || "M").slice(0,1).toUpperCase();
  const prefix =
    mood==="good" ? "Yes! " :
    mood==="bad"  ? "Oh! "  : "";
  $("monsterSpeech").innerHTML = `<b>${APP.MONSTER_NAME}</b><br>${prefix}${text}`;
}

function helpSummary(level){
  const h = HELP_RULES[level];
  const parts = [];
  if(h.rereadButton) parts.push("Nochmal lesen");
  return parts.length ? parts.join(" ¬∑ ") : "keine";
}

function focusIcon(focus){
  return FOCUS_ICON[focus] || "üéØ";
}

/* =========================
   Mega Star Animation (Center + Sparkles + Fly)
   ========================= */
function spawnSparkles(){
  const box = $("sparkles");
  box.innerHTML = "";
  const count = 14;
  for(let i=0;i<count;i++){
    const s = document.createElement("div");
    s.className = "sparkle";
    const angle = (Math.PI*2) * (i/count);
    const r = 70 + Math.random()*80;
    const dx = Math.cos(angle) * r;
    const dy = Math.sin(angle) * r;
    s.style.left = (50 + (Math.random()*12-6)) + "%";
    s.style.top = (50 + (Math.random()*12-6)) + "%";
    s.style.setProperty("--dx", dx.toFixed(1) + "px");
    s.style.setProperty("--dy", dy.toFixed(1) + "px");
    s.style.animationDelay = (Math.random()*0.08) + "s";
    box.appendChild(s);
  }
}

function playMegaStarThenFly(){
  const overlay = $("starOverlay");
  const mega = $("megaStar");
  overlay.classList.add("show");
  mega.classList.remove("play");
  void mega.offsetWidth;

  spawnSparkles();
  mega.classList.add("play");
  mega.style.opacity = "1";

  // nach Pop: Stern fliegt zur Sterne-Pill
  setTimeout(()=>{
    overlay.classList.remove("show");
    flyStarToPill();
  }, 520);
}

function flyStarToPill(){
  const toEl = $("uiStarsPill");
  const b = toEl.getBoundingClientRect();
  const endX = b.left + b.width * 0.22;
  const endY = b.top + b.height * 0.55;

  // Start: Screen Center
  const startX = window.innerWidth * 0.5;
  const startY = window.innerHeight * 0.44;

  const star = document.createElement("div");
  star.className = "flyStar";
  star.textContent = "‚≠ê";
  star.style.left = startX + "px";
  star.style.top  = startY + "px";
  document.body.appendChild(star);

  requestAnimationFrame(()=>{
    star.style.left = endX + "px";
    star.style.top  = endY + "px";
    star.style.transform = "translate(-50%, -50%) scale(.55)";
    star.style.opacity = "0.85";
  });

  setTimeout(()=>{
    star.style.opacity = "0";
  }, 420);

  setTimeout(()=>{
    star.remove();
    toEl.classList.remove("pulse");
    void toEl.offsetWidth;
    toEl.classList.add("pulse");
  }, 600);
}

/* =========================
   RENDER TOP + MAP
   ========================= */
function renderTop(){
  $("uiHelp").textContent = `Hilfen: ${helpSummary(state.level)}`;
  $("uiProgress").textContent = `Abgeschlossen: ${Object.keys(state.done).length} / ${MAP.nodes.length}`;
  $("uiStarsCount").textContent = String(state.stars);

  $("uiLevel").textContent = `Stufe ${state.level}`;
  const streakText =
    state.streakCorrect > 0 ? `${state.streakCorrect} richtig in Folge` :
    state.streakWrong > 0   ? `${state.streakWrong} falsch in Folge` :
                              "keine Serie";
  $("uiStreak").textContent = streakText;

  $("uiStatus").textContent = state.chapterComplete ? "Kapitel abgeschlossen" : "l√§uft";

  const c = state.currentNodeId ? getCard(state.currentNodeId) : null;
  $("uiFocusTop").textContent = c ? `${focusIcon(c.focus)} ${c.focus}` : "-";

  $("uiNodeState").textContent = (c && state.done[c.id]) ? "Status: erledigt" : "Status: offen";
  $("uiNodeId").textContent = state.currentNodeId ? `Knoten: ${state.currentNodeId.toUpperCase()}` : "Knoten: -";
}

function renderMap(){
  const wrap = $("map");
  wrap.innerHTML = "";
  MAP.nodes.forEach(n=>{
    const card = getCard(n.id);
    const unlocked = isUnlocked(n.id);
    const done = !!state.done[n.id];

    const el = document.createElement("div");
    el.className = "node" + (unlocked ? "" : " locked") + (done ? " done":"");
    el.innerHTML = `
      <small>${done ? "erledigt" : unlocked ? "bereit" : "gesperrt"}</small>
      <b>${card?.nodeTitle ?? n.id}</b>
    `;
    el.onclick = () => {
      if(!unlocked || state.chapterComplete) return;
      state.currentNodeId = n.id;
      saveState();
      showPlay();
      renderAll();
    };
    wrap.appendChild(el);
  });
}

/* =========================
   SILBEN (Demo)
   ========================= */
function syllabifySimple(word){
  return word.replace(/([aeiou√§√∂√ºy]{1,2})([^aeiou√§√∂√ºy])/gi, "$1-$2");
}
function applySyllables(lines){
  return lines.map(line=>{
    return line.split(" ").map(w=>{
      const clean=w.replace(/[.,!?]/g,"");
      if(clean.length>=7) return w.replace(clean, syllabifySimple(clean));
      return w;
    }).join(" ");
  });
}

/* =========================
   CARD RENDERING
   ========================= */
let cardStartTs = null;

function buildOptions(card, level){
  const answers = card.answersByLevel[level] || card.answersByLevel[1];
  const correctIdx = card.correctIndex;

  const base = answers.map((t, idx)=>({
    text:t,
    isCorrect: idx === correctIdx
  }));
  return shuffle([...base]);
}

function renderCard(){
  const nodeId = state.currentNodeId;
  const c = nodeId ? getCard(nodeId) : null;

  if(state.chapterComplete || !c){
    $("card").innerHTML = `<div class="feedback">Kein aktiver Knoten. √ñffne die Diagnose oder starte neu.</div>`;
    return;
  }

  // Local reset pro Karte
  cardLocal.attempts = 0;
  cardLocal.locked = false;

  const level = state.level;
  const lines = c.textByLevel[level] || c.textByLevel[1];
  const question = c.questionByLevel[level] || c.questionByLevel[1];

  const helps = HELP_RULES[level];
  const renderedLines = (level===1) ? applySyllables(lines) : lines;

  cardLocal.options = buildOptions(c, level);

  $("card").innerHTML = `
    <div class="scene">
      <div class="meta">
        <small>Szene</small>
        <b>${c.nodeTitle}</b>
      </div>
      <span class="pill">${focusIcon(c.focus)} ${c.focus}</span>
    </div>

    <div class="readingBox" id="readingBox">
      <div class="readingLabel">
        <b>Lesetext</b>
        <div class="readingHint">Lies zuerst den Text. Dann beantworte die Frage.</div>
      </div>
      <div class="text">
        ${renderedLines.map(x=>`<div>${x}</div>`).join("")}
      </div>
    </div>

    <div class="question">
      <span class="qicon">${focusIcon(c.focus)}</span>
      <span>${question}</span>
    </div>

    <div class="answers" id="answers"></div>

    <div class="helpers">
      ${helps.rereadButton ? `<button id="btnReread">Nochmal lesen</button>` : ""}
      <span class="pill">Versuche: <b id="tryCount" style="color:var(--txt)">0</b></span>
    </div>

    <div class="hr"></div>
    <div class="feedback" id="feedback">W√§hle eine Antwort.</div>
  `;

  const ansWrap = $("answers");

  cardLocal.options.forEach((opt, idx)=>{
    const b = document.createElement("button");
    b.className = "option";
    b.textContent = opt.text;
    b.onclick = () => submitAnswer(idx, b);
    ansWrap.appendChild(b);
  });

  if(helps.rereadButton){
    $("btnReread").onclick = () => {
      setMonster("Lies den Text noch einmal. Du findest die L√∂sung im Satz.");
      $("feedback").textContent = "Nochmal lesen aktiviert.";
      const box = $("readingBox");
      box.style.borderColor = "rgba(255,255,255,.40)";
      setTimeout(()=> box.style.borderColor = "rgba(255,255,255,.20)", 520);
    };
  }

  cardStartTs = performance.now();
}

/* =========================
   ADAPTIV
   ========================= */
function adaptAfterAnswer(correct){
  if(correct){
    state.streakCorrect += 1;
    state.streakWrong = 0;

    if(state.streakCorrect >= APP.TARGET_STREAK_UP && state.level < APP.LEVEL_MAX){
      state.level += 1;
      state.streakCorrect = 0;
      setMonster(`Stufe erh√∂ht: ${state.level}.`, "good");
    } else {
      setMonster("Richtig. Weiter.", "good");
    }
  } else {
    state.streakWrong += 1;
    state.streakCorrect = 0;
    setMonster("Noch nicht. Lies den Text noch einmal.", "bad");
  }
}

/* =========================
   BUGFIX: Nach falsch darf man weiter klicken
   - Keine globale Deaktivierung
   - Falscher Button wird kurz ‚Äúgeshaked‚Äù, bleibt klickbar oder optional deaktiviert
   ========================= */
function submitAnswer(optionIdx, btnEl){
  const nodeId = state.currentNodeId;
  const c = getCard(nodeId);
  if(!c || state.chapterComplete || !cardLocal.options || cardLocal.locked) return;

  const timeMs = Math.max(1, Math.round(performance.now() - (cardStartTs ?? performance.now())));
  const chosen = cardLocal.options[optionIdx];
  const correct = !!chosen?.isCorrect;

  // Logging pro Versuch
  state.logs.push({
    ts: Date.now(),
    nodeId,
    level: state.level,
    correct,
    timeMs,
    focus: c.focus,
    chosenText: chosen?.text ?? ""
  });

  cardLocal.attempts += 1;
  const tryCount = $("tryCount");
  if(tryCount) tryCount.textContent = String(cardLocal.attempts);

  if(correct){
    // Lock nur beim Erfolg (damit kein Doppelklick ‚Äúmehr Sterne‚Äù erzeugt)
    cardLocal.locked = true;

    state.stars += 1;
    state.done[nodeId] = true;

    if(btnEl) btnEl.classList.add("correctFlash");

    // MEGA STAR: Mitte -> Glitzer -> Fly
    playMegaStarThenFly();

    $("uiStarsCount").textContent = String(state.stars);
    $("feedback").innerHTML = `<span class="good">Richtig.</span> ‚≠ê 1 Stern.`;

    adaptAfterAnswer(true);

    if(allNodesDone()){
      state.chapterComplete = true;
      state.currentNodeId = null;
      saveState();
      showComplete();
      renderAll();
      return;
    }

    state.currentNodeId = nextUnlockedUndoneNode();
    saveState();

    // Mini Delay f√ºr Gef√ºhl, dann n√§chste Karte
    setTimeout(()=> renderAll(), 520);
    return;
  }

  // FALSCH: NICHT festh√§ngen. Keine globale Sperre.
  if(btnEl){
    btnEl.classList.add("wrongFlash");
    // Optional: denselben falschen Button kurz deaktivieren, damit nicht gespammt wird
    btnEl.disabled = true;
    setTimeout(()=>{
      btnEl.disabled = false;
      btnEl.classList.remove("wrongFlash");
    }, 520);
  }

  $("feedback").innerHTML = `<span class="bad">Noch nicht.</span> Lies den Text noch einmal.`;
  adaptAfterAnswer(false);
  saveState();
}

/* =========================
   DIAGNOSE
   ========================= */
function renderDashboard(){
  const logs = state.logs;
  const doneCount = Object.keys(state.done).length;

  const total = logs.length;
  const correct = logs.filter(x=>x.correct).length;
  const acc = total ? Math.round((correct/total)*100) : 0;

  const avgTime = total ? Math.round(logs.reduce((a,b)=>a+b.timeMs,0)/total) : 0;

  $("dDone").textContent = `Abgeschlossen: ${doneCount} / ${MAP.nodes.length}`;
  $("dAcc").textContent = `Trefferquote: ${acc}%`;
  $("dTime").textContent = `√ò Zeit: ${Math.round(avgTime/1000)} s`;

  const wrong = logs.filter(x=>!x.correct);
  const byFocus = {};
  wrong.forEach(x=>{
    byFocus[x.focus] = byFocus[x.focus] || { count:0, exampleNodeId:x.nodeId };
    byFocus[x.focus].count++;
  });

  const rows = Object.entries(byFocus)
    .sort((a,b)=>b[1].count - a[1].count)
    .slice(0,5);

  const tbody = $("dPatterns");
  tbody.innerHTML = "";
  if(rows.length===0){
    tbody.innerHTML = `<tr><td colspan="3" style="color:var(--muted)">Noch keine Fehlmuster.</td></tr>`;
  }else{
    rows.forEach(([focus, data])=>{
      const card = getCard(data.exampleNodeId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${focusIcon(focus)} ${focus}</td>
        <td>${data.count}</td>
        <td>${card ? card.nodeTitle : data.exampleNodeId}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  const strengths = [];
  if(acc >= 80) strengths.push("Trefferquote ist hoch.");
  if(avgTime && avgTime < 6000) strengths.push("Tempo ist stabil.");
  if(doneCount >= 3) strengths.push("Viele Karten geschafft.");
  if(strengths.length===0) strengths.push("Startphase: weiter spielen, dann wird die Diagnose pr√§ziser.");

  const focus = rows.length ? rows[0][0] : "Aufmerksamkeit";
  const mission =
    acc >= 80 ? "8 Minuten pro Tag. Schwierigkeit stabil halten." :
    acc >= 60 ? "8 Minuten pro Tag. Text zuerst, dann Frage." :
                "8 Minuten pro Tag. Text langsam lesen. Dann Frage.";

  $("dCoach").innerHTML = `
    <b>St√§rken</b>
    <ul style="margin:6px 0 12px 18px;">
      ${strengths.slice(0,3).map(s=>`<li>${s}</li>`).join("")}
    </ul>
    <b>Fokus</b>
    <div style="margin-top:6px;">
      <span class="pill">Top-Fokus: <b style="color:var(--txt)">${focusIcon(focus)} ${focus}</b></span>
    </div>
    <div style="margin-top:12px;"><b>Empfohlene Mission</b></div>
    <div style="margin-top:6px;color:var(--muted)">${mission}</div>
  `;
}

/* =========================
   VIEWS
   ========================= */
function showPlay(){
  $("viewPlay").classList.remove("hidden");
  $("viewDash").classList.add("hidden");
  $("viewComplete").classList.add("hidden");
  $("btnPlay").classList.add("primary");
  $("btnDash").classList.remove("primary");
}
function showDash(){
  $("viewDash").classList.remove("hidden");
  $("viewPlay").classList.add("hidden");
  $("viewComplete").classList.add("hidden");
  $("btnDash").classList.add("primary");
  $("btnPlay").classList.remove("primary");
  renderDashboard();
}
function showComplete(){
  $("viewComplete").classList.remove("hidden");
  $("viewPlay").classList.add("hidden");
  $("viewDash").classList.add("hidden");
  $("btnPlay").classList.remove("primary");
  $("btnDash").classList.remove("primary");
}

function renderComplete(){
  $("completeStars").textContent = String(state.stars);
  $("completeText").innerHTML = `
    Kapitel abgeschlossen.<br>
    Abgeschlossene Knoten: <b>${Object.keys(state.done).length}</b> / <b>${MAP.nodes.length}</b><br>
    Stufe am Ende: <b>${state.level}</b><br>
    √ñffne die Diagnose, um Fehlmuster und Fokus zu sehen.
  `;
}

/* =========================
   RENDER ALL
   ========================= */
function renderAll(){
  renderTop();
  renderMap();

  if(state.chapterComplete){
    setMonster("Kapitel ist abgeschlossen. Diagnose zeigt die Auswertung.");
    renderComplete();
    return;
  }

  // Standard-Guide
  if(state.logs.length === 0){
    setMonster("Willkommen. Lies den Text. Beantworte die Frage. Sammle Sterne.");
  }

  renderCard();
}

/* =========================
   BUTTONS
   ========================= */
$("btnPlay").onclick = () => { showPlay(); renderAll(); };
$("btnDash").onclick = () => { showDash(); };

$("btnReset").onclick = () => {
  const ok = confirm("Alles zur√ºcksetzen? Sterne, Fortschritt und Diagnose werden gel√∂scht.");
  if(!ok) return;
  state = defaultState();
  saveState();
  showPlay();
  setMonster("Reset durchgef√ºhrt. Starte neu.");
  renderAll();
};

$("btnReplay").onclick = () => {
  state = defaultState();
  saveState();
  showPlay();
  setMonster("Neu gestartet. Los geht es.");
  renderAll();
};

$("btnGoDash").onclick = () => showDash();

/* INIT */
showPlay();
renderAll();
</script>
</body>
</html>

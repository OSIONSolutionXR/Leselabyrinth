<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leselabyrinth ‚Äì OSION Solution XR</title>

  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#0c1330;

      --panel: rgba(17, 26, 51, .78);
      --panel2: rgba(15, 23, 48, .62);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.20);

      --txt:#edf3ff;
      --muted:#b6c2e6;

      --good:#43e08b;
      --bad:#ff5a7a;

      --accent1:#ff2d55;
      --accent2:#7a3cff;

      --kid1:#2fd9ff;
      --kid2:#ffd33d;
      --kid3:#7cff6b;

      --radius: 20px;
      --radius2: 16px;

      --shadow: 0 18px 60px rgba(0,0,0,.30);
      --shadowIn: 0 18px 40px rgba(0,0,0,.20) inset;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(122,60,255,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 12%, rgba(255,45,85,.22), transparent 60%),
        radial-gradient(700px 400px at 50% 120%, rgba(47,217,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Kleine ‚ÄúSternchen‚Äù-Textur */
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.22;
      background-image:
        radial-gradient(circle, rgba(255,255,255,.14) 1px, transparent 1.5px),
        radial-gradient(circle, rgba(255,255,255,.10) 1px, transparent 1.5px);
      background-size: 80px 80px, 120px 120px;
      background-position: 10px 15px, 40px 60px;
      filter: blur(.2px);
    }

    header{
      position:sticky; top:0; z-index:20;
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      background: rgba(11,16,32,.85);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .brand b{
      font-size:14px; letter-spacing:.8px;
      background: linear-gradient(90deg,var(--accent1),var(--accent2));
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
      font-weight:900;
    }
    .brand span{
      font-size:12px;
      color:var(--muted);
      opacity:.95;
    }

    .top-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    button{
      appearance:none;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
      user-select:none;
    }
    button:hover{ border-color: rgba(255,255,255,.22); transform: translateY(-1px); }
    button:active{ transform: translateY(0px) scale(.99); filter: brightness(.98); }

    button.primary{
      border:none;
      background: linear-gradient(90deg, rgba(255,45,85,.95), rgba(122,60,255,.95));
      box-shadow: 0 12px 32px rgba(122,60,255,.16);
    }

    main{
      padding:16px;
      max-width:1100px;
      margin:0 auto;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      position:relative;
    }

    .layout{
      display:grid;
      grid-template-rows:auto 1fr;
      gap:14px;
    }

    /* --- Guidebar oben --- */
    .guidebar{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1.5fr;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .guidebar{ grid-template-columns: 1fr; }
    }

    .box{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(15,23,48,.55);
      padding:12px;
    }

    .guide{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .avatar{
      width:56px; height:56px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 50%),
        linear-gradient(135deg, rgba(47,217,255,.40), rgba(255,211,61,.26)),
        linear-gradient(135deg, rgba(255,45,85,.55), rgba(122,60,255,.50));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      letter-spacing:.5px;
      color:rgba(255,255,255,.96);
      flex:0 0 auto;
      box-shadow: 0 10px 28px rgba(0,0,0,.22);
    }
    .speech{
      flex:1;
      padding:10px 12px;
      border-radius: var(--radius2);
      border:1px solid var(--stroke);
      background: rgba(17,26,51,.60);
      line-height:1.35;
      font-size:13.5px;
      min-height:56px;
    }

    .pills{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* Sterne-Pill: Ziel f√ºr Animation */
    .pill.stars{
      border-color: rgba(255,211,61,.30);
      background:
        radial-gradient(200px 40px at 30% 30%, rgba(255,211,61,.18), transparent 60%),
        rgba(255,255,255,.05);
      position:relative;
      overflow:hidden;
    }
    .pill.stars.pulse{
      animation: starPulse .45s ease;
    }
    @keyframes starPulse{
      0%{ transform: scale(1); }
      40%{ transform: scale(1.08); }
      100%{ transform: scale(1); }
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background: rgba(17,26,51,.35);
      padding:10px 12px;
      min-height:56px;
    }
    .stat b{ display:block; font-size:12.5px; letter-spacing:.2px; }
    .stat span{ color:var(--muted); font-size:12px; }

    /* Map: horizontal scroll */
    .mapwrap{ display:flex; flex-direction:column; gap:10px; }
    .maphead{
      display:flex; justify-content:space-between;
      gap:10px; align-items:center; flex-wrap:wrap;
    }
    .maphead b{ font-size:13px; }
    .maphead span{ font-size:12px; color:var(--muted); }

    .map{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
      -webkit-overflow-scrolling: touch;
    }
    .node{
      min-width: 180px;
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background:
        radial-gradient(240px 50px at 15% 20%, rgba(47,217,255,.10), transparent 60%),
        rgba(17,26,51,.30);
      padding:10px 12px;
      cursor:pointer;
      flex:0 0 auto;
      transition: transform .12s ease, border-color .12s ease;
    }
    .node:hover{ border-color: rgba(255,255,255,.22); transform: translateY(-1px); }
    .node.locked{ opacity:.45; cursor:not-allowed; filter: grayscale(.1); }
    .node.done{
      border-color: rgba(67,224,139,.35);
      background:
        radial-gradient(260px 60px at 15% 20%, rgba(124,255,107,.12), transparent 60%),
        rgba(67,224,139,.10);
    }
    .node small{ color:var(--muted); display:block; margin-bottom:4px; }
    .node b{ display:block; font-size:13px; }

    /* --- Content unten --- */
    .content{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .titleRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .titleRow h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(15,23,48,.55);
      padding:14px;
      position:relative;
    }

    .scene{
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .scene .meta{ display:flex; flex-direction:column; gap:2px; }
    .scene .meta small{ color:var(--muted); }
    .scene .meta b{ font-size:16px; }

    /* Lesetext: deutlich + kindgerecht */
    .readingBox{
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.22);
      background:
        radial-gradient(900px 180px at 0% 0%, rgba(47,217,255,.16), transparent 55%),
        radial-gradient(900px 180px at 100% 0%, rgba(255,211,61,.14), transparent 55%),
        rgba(255,255,255,.035);
      padding:16px;
      margin:12px 0 14px;
      box-shadow: var(--shadowIn);
      position:relative;
      overflow:hidden;
    }
    .readingBox:after{
      content:"";
      position:absolute;
      top:-40%;
      left:-60%;
      width:60%;
      height:180%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      transform: rotate(18deg);
      animation: gentleShine 6.5s linear infinite;
      opacity:.55;
      pointer-events:none;
    }
    @keyframes gentleShine{
      0%{ transform: translateX(0) rotate(18deg); }
      100%{ transform: translateX(260%) rotate(18deg); }
    }

    .readingLabel{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .readingLabel b{
      font-size:12.5px;
      letter-spacing:.35px;
      text-transform:uppercase;
      color:rgba(255,255,255,.90);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .readingLabel b:before{
      content:"üìñ";
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.25));
    }
    .readingHint{
      color:var(--muted);
      font-size:12px;
    }

    .text{
      font-size:22px;
      line-height:1.75;
      font-weight:950;
      letter-spacing:.15px;
      text-shadow: 0 10px 24px rgba(0,0,0,.20);
    }
    @media (max-width: 520px){
      .text{ font-size:19px; }
    }

    .question{
      font-weight:950;
      margin:10px 0 10px;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .question:before{
      content:"‚ùì";
      opacity:.95;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.22));
    }

    /* Antwort-Buttons (kindgerecht + farbig + shimmer) */
    .answers{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .option{
      position:relative;
      width:100%;
      text-align:left;
      padding:14px 14px;
      border-radius: 18px;
      font-size:15px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(260px 60px at 15% 25%, rgba(47,217,255,.16), transparent 60%),
        radial-gradient(260px 60px at 85% 65%, rgba(255,211,61,.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      overflow:hidden;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    }
    .option:before{
      content:"";
      position:absolute;
      top:-60%;
      left:-80%;
      width:60%;
      height:220%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.16), transparent);
      transform: rotate(20deg);
      animation: shimmer 3.8s linear infinite;
      opacity:.45;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ transform: translateX(0) rotate(20deg); }
      100%{ transform: translateX(320%) rotate(20deg); }
    }
    .option:hover{
      border-color: rgba(255,255,255,.26);
      transform: translateY(-1px);
      filter: brightness(1.04);
    }
    .option:active{
      transform: translateY(0px) scale(.99);
      filter: brightness(.98);
    }

    /* Feedback states */
    .option.correctFlash{
      border-color: rgba(67,224,139,.55);
      background:
        radial-gradient(260px 60px at 15% 25%, rgba(124,255,107,.20), transparent 60%),
        linear-gradient(180deg, rgba(67,224,139,.16), rgba(255,255,255,.02));
    }
    .option.wrongFlash{
      border-color: rgba(255,90,122,.55);
      background:
        radial-gradient(260px 60px at 15% 25%, rgba(255,90,122,.20), transparent 60%),
        linear-gradient(180deg, rgba(255,90,122,.12), rgba(255,255,255,.02));
    }

    .helpers{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }
    .helpers button{
      font-size:12px;
      padding:9px 10px;
      border-radius:999px;
    }

    .hr{ height:1px; background:var(--stroke); margin:12px 0; }

    .feedback{
      padding:12px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,255,255,.20);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .hidden{ display:none !important; }

    /* Diagnose */
    .table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      color:var(--txt);
    }
    .table td, .table th{
      border-bottom:1px solid var(--stroke);
      padding:8px 6px;
      text-align:left;
    }
    .table th{ color:var(--muted); font-weight:950; }

    .good{ color:var(--good); font-weight:950; }
    .bad{ color:var(--bad); font-weight:950; }

    /* Stern-Fly Animation Element */
    .flyStar{
      position: fixed;
      z-index: 9999;
      font-size: 22px;
      pointer-events:none;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      transition: transform .55s cubic-bezier(.2,.9,.2,1), left .55s cubic-bezier(.2,.9,.2,1), top .55s cubic-bezier(.2,.9,.2,1), opacity .55s ease;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <b>OSION Solution XR</b>
    <span>Leselabyrinth ¬∑ Adventure + AdaptiV + Diagnose</span>
  </div>
  <div class="top-actions">
    <button id="btnPlay" class="primary">Adventure</button>
    <button id="btnDash">Diagnose</button>
    <button id="btnReset">Reset</button>
  </div>
</header>

<main>
  <div class="layout">

    <!-- TOP: Guidebar -->
    <section class="panel">
      <div class="guidebar">

        <div class="box">
          <div class="guide">
            <div class="avatar" id="monsterAvatar">M</div>
            <div class="speech" id="monsterSpeech"></div>
          </div>

          <div class="pills">
            <span class="pill" id="uiHelp"></span>
            <span class="pill" id="uiProgress"></span>
            <span class="pill stars" id="uiStarsPill">‚≠ê Sterne: <b id="uiStarsCount" style="color:var(--txt)">0</b></span>
          </div>
        </div>

        <div class="box">
          <div class="stats">
            <div class="stat">
              <b>Stufe</b>
              <span id="uiLevel"></span>
            </div>
            <div class="stat">
              <b>Serie</b>
              <span id="uiStreak"></span>
            </div>
            <div class="stat">
              <b>Status</b>
              <span id="uiStatus"></span>
            </div>
            <div class="stat">
              <b>Hinweis</b>
              <span id="uiTip"></span>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="mapwrap">
            <div class="maphead">
              <b>Kapitel: Der Wald</b>
              <span>Tippe einen Knoten an. Neue Knoten werden freigeschaltet.</span>
            </div>
            <div class="map" id="map"></div>
          </div>
        </div>

      </div>
    </section>

    <!-- BOTTOM: Content -->
    <section class="panel">
      <div class="content">

        <!-- PLAY VIEW -->
        <div id="viewPlay">
          <div class="titleRow">
            <h2>Lesekarte</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill" id="uiFocus"></span>
              <span class="pill" id="uiNodeState"></span>
              <span class="pill" id="uiNodeId"></span>
            </div>
          </div>

          <div class="card" id="card"></div>
        </div>

        <!-- COMPLETE VIEW -->
        <div id="viewComplete" class="hidden">
          <div class="titleRow">
            <h2>Kapitel abgeschlossen</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill"><span class="good">Stark</span></span>
              <span class="pill">‚≠ê Sterne: <b id="completeStars" style="color:var(--txt)">0</b></span>
            </div>
          </div>

          <div class="card">
            <div class="feedback" id="completeText"></div>
            <div class="hr"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button id="btnGoDash">Diagnose √∂ffnen</button>
              <button id="btnReplay" class="primary">Kapitel neu spielen</button>
            </div>
          </div>
        </div>

        <!-- DASH VIEW -->
        <div id="viewDash" class="hidden">
          <div class="titleRow">
            <h2>Diagnose-Dashboard</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill" id="dDone"></span>
              <span class="pill" id="dAcc"></span>
              <span class="pill" id="dTime"></span>
            </div>
          </div>

          <div class="card">
            <b style="display:block;margin-bottom:8px;">Fehlmuster (Top)</b>
            <table class="table">
              <thead><tr><th>Kategorie</th><th>Anzahl</th><th>Beispiel</th></tr></thead>
              <tbody id="dPatterns"></tbody>
            </table>

            <div class="hr"></div>

            <b style="display:block;margin-bottom:8px;">St√§rken & Fokus</b>
            <div class="feedback" id="dCoach"></div>
          </div>
        </div>

      </div>
    </section>

  </div>
</main>

<script>
/** =========================
 *  KONFIG
 *  ========================= */
const APP = {
  BRAND: "OSION Solution XR",
  APP_NAME: "Leselabyrinth",
  CHAPTER_ID: "wald_v1",
  MONSTER_NAME: "Momo",
  LEVEL_MIN: 1,
  LEVEL_MAX: 3,
  TARGET_STREAK_UP: 3,
  TARGET_MISTAKES_HOLD: 2
};

const HELP_RULES = {
  1: { syllables: true, hintButton: true, rereadButton: true },
  2: { syllables: false, hintButton: true, rereadButton: true },
  3: { syllables: false, hintButton: false, rereadButton: true }
};

const STORE_KEY = "leselabyrinth_state_v3";

/** =========================
 *  CONTENT (IM CODE)
 *  WICHTIG: Jede Frage muss aus dem Lesetext l√∂sbar sein.
 *  ========================= */
const CARDS = [
  {
    id:"n1",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Start am Waldweg",
    textByLevel:{
      1:["Momo geht in den Wald.","Ein Vogel singt im Baum."],
      2:["Momo geht in den Wald.","Ein kleiner Vogel singt laut im Baum."],
      3:["Momo geht in den Wald.","Ein kleiner Vogel singt laut im Baum.","Momo bleibt kurz stehen."]
    },
    questionByLevel:{ 1:"Wo geht Momo hin?", 2:"Wo geht Momo hin?", 3:"Wo geht Momo hin?" },
    answersByLevel:{
      1:["In den Wald.","In die Stadt.","Ins Meer."],
      2:["In den Wald.","In die Stadt.","Ins Meer."],
      3:["In den Wald.","In die Stadt.","Ins Meer."]
    },
    correctIndex:0,
    hint:"Im Satz steht: Momo geht in den Wald.",
    focus:"W-Frage"
  },
  {
    id:"n2",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Die Holzbr√ºcke",
    textByLevel:{
      1:["Vor Momo ist eine Br√ºcke.","Die Br√ºcke ist aus Holz."],
      2:["Vor Momo ist eine kleine Br√ºcke.","Die Br√ºcke ist aus Holz."],
      3:["Vor Momo ist eine kleine Br√ºcke.","Die Br√ºcke ist aus Holz und wackelt leicht."]
    },
    questionByLevel:{ 1:"Woraus ist die Br√ºcke?", 2:"Woraus ist die Br√ºcke?", 3:"Woraus ist die Br√ºcke?" },
    answersByLevel:{
      1:["Aus Holz.","Aus Eis.","Aus Papier."],
      2:["Aus Holz.","Aus Eis.","Aus Papier."],
      3:["Aus Holz.","Aus Eis.","Aus Papier."]
    },
    correctIndex:0,
    hint:"Im Text steht: Die Br√ºcke ist aus Holz.",
    focus:"Detail"
  },
  {
    id:"n3",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Der Apfelbaum",
    // FIX: Farbe muss im Text stehen, sonst ist es nicht l√∂sbar.
    textByLevel:{
      1:["Ein gr√ºner Apfel f√§llt runter.","Momo schaut nach oben."],
      2:["Ein gr√ºner Apfel f√§llt runter.","Momo schaut nach oben und l√§chelt."],
      3:["Ein gr√ºner Apfel f√§llt runter.","Momo schaut nach oben und l√§chelt.","Der Apfel rollt ins Gras."]
    },
    questionByLevel:{ 1:"Welche Farbe hat der Apfel?", 2:"Welche Farbe hat der Apfel?", 3:"Welche Farbe hat der Apfel?" },
    answersByLevel:{
      1:["Gr√ºn.","Blau.","Schwarz."],
      2:["Gr√ºn.","Blau.","Schwarz."],
      3:["Gr√ºn.","Blau.","Schwarz."]
    },
    correctIndex:0,
    hint:"Im Text steht: gr√ºner Apfel.",
    focus:"Wortverwechslung"
  },
  {
    id:"n4",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Der Schl√ºsselstein",
    textByLevel:{
      1:["Momo findet einen Stein.","Auf dem Stein ist ein Stern."],
      2:["Momo findet einen Stein.","Auf dem Stein ist ein Stern.","Der Stern glitzert."],
      3:["Momo findet einen Stein.","Auf dem Stein ist ein Stern.","Der Stern glitzert hell im Licht."]
    },
    questionByLevel:{ 1:"Was ist auf dem Stein?", 2:"Was ist auf dem Stein?", 3:"Was ist auf dem Stein?" },
    answersByLevel:{
      1:["Ein Stern.","Ein Auto.","Ein Haus."],
      2:["Ein Stern.","Ein Auto.","Ein Haus."],
      3:["Ein Stern.","Ein Auto.","Ein Haus."]
    },
    correctIndex:0,
    hint:"Im Text steht: Auf dem Stein ist ein Stern.",
    focus:"Satzverst√§ndnis"
  },
  {
    id:"n5",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Die Boss-T√ºr",
    textByLevel:{
      1:["Vor Momo ist eine gro√üe T√ºr.","Momo braucht einen Schl√ºssel."],
      2:["Vor Momo ist eine gro√üe T√ºr.","Momo braucht einen Schl√ºssel.","Die T√ºr bleibt zu."],
      3:["Vor Momo ist eine gro√üe T√ºr.","Momo braucht einen Schl√ºssel.","Die T√ºr bleibt zu.","Momo sucht den Schl√ºsselstein."]
    },
    questionByLevel:{ 1:"Was braucht Momo?", 2:"Was braucht Momo?", 3:"Was braucht Momo?" },
    answersByLevel:{
      1:["Den Schl√ºssel.","Eine Leiter.","Einen Ball."],
      2:["Den Schl√ºssel.","Eine Leiter.","Einen Ball."],
      3:["Den Schl√ºssel.","Eine Leiter.","Einen Ball."]
    },
    correctIndex:0,
    hint:"Im Text steht: Momo braucht einen Schl√ºssel.",
    focus:"Ursache/Wirkung"
  }
];

const MAP = {
  chapterId: APP.CHAPTER_ID,
  nodes: [
    { id:"n1", unlockFrom:null },
    { id:"n2", unlockFrom:"n1" },
    { id:"n3", unlockFrom:"n2" },
    { id:"n4", unlockFrom:"n3" },
    { id:"n5", unlockFrom:"n4" }
  ],
  sidepaths: ["Quatsch-Tunnel","Kicherweg","Sackgasse","Rutschweg zur√ºck zum Satz"]
};

/** =========================
 *  STATE
 *  ========================= */
const defaultState = () => ({
  level: 1,
  stars: 0,
  currentNodeId: "n1",
  done: {},
  streakCorrect: 0,
  streakWrong: 0,
  chapterComplete: false,
  logs: []
});

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    return { ...defaultState(), ...s };
  }catch(e){
    return defaultState();
  }
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
let state = loadState();

/** =========================
 *  Utils
 *  ========================= */
const $ = (id) => document.getElementById(id);
function getCard(nodeId){ return CARDS.find(c => c.id === nodeId); }
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function isUnlocked(nodeId){
  const node = MAP.nodes.find(n => n.id===nodeId);
  if(!node) return false;
  if(node.unlockFrom===null) return true;
  return !!state.done[node.unlockFrom];
}
function allNodesDone(){
  return MAP.nodes.every(n => !!state.done[n.id]);
}
function nextUnlockedUndoneNode(){
  for(const n of MAP.nodes){
    if(isUnlocked(n.id) && !state.done[n.id]) return n.id;
  }
  return null;
}

/** =========================
 *  Monster
 *  ========================= */
function setMonster(text, mood="neutral"){
  $("monsterAvatar").textContent = (APP.MONSTER_NAME || "M").slice(0,1).toUpperCase();
  const prefix =
    mood==="good" ? "Yes! " :
    mood==="bad"  ? "Oh! "  :
                    "";
  $("monsterSpeech").innerHTML = `<b>${APP.MONSTER_NAME}</b><br>${prefix}${text}`;
}

/** =========================
 *  Hilfen / Anzeige
 *  ========================= */
function helpSummary(level){
  const h = HELP_RULES[level];
  const parts = [];
  if(h.syllables) parts.push("Silben");
  if(h.hintButton) parts.push("Hinweis");
  if(h.rereadButton) parts.push("Nochmal lesen");
  return parts.length ? parts.join(" ¬∑ ") : "keine";
}

/** =========================
 *  Stern Animation (Button -> Sterne Pill)
 *  ========================= */
function flyStarFromElement(fromEl){
  const toEl = $("uiStarsPill");
  if(!fromEl || !toEl) return;

  const a = fromEl.getBoundingClientRect();
  const b = toEl.getBoundingClientRect();

  const startX = a.left + a.width * 0.85;
  const startY = a.top + a.height * 0.50;
  const endX   = b.left + b.width * 0.20;
  const endY   = b.top + b.height * 0.55;

  const star = document.createElement("div");
  star.className = "flyStar";
  star.textContent = "‚≠ê";
  star.style.left = startX + "px";
  star.style.top  = startY + "px";
  document.body.appendChild(star);

  // Start-Pop
  star.style.transform = "translate(-50%, -50%) scale(1.15)";

  requestAnimationFrame(()=>{
    star.style.left = endX + "px";
    star.style.top  = endY + "px";
    star.style.transform = "translate(-50%, -50%) scale(.55)";
    star.style.opacity = "0.85";
  });

  setTimeout(()=>{
    star.style.opacity = "0";
  }, 430);

  setTimeout(()=>{
    star.remove();
    toEl.classList.remove("pulse");
    void toEl.offsetWidth; // reflow
    toEl.classList.add("pulse");
  }, 560);
}

/** =========================
 *  Render Top
 *  ========================= */
function renderTop(){
  $("uiHelp").textContent = `Hilfen: ${helpSummary(state.level)}`;
  $("uiProgress").textContent = `Abgeschlossen: ${Object.keys(state.done).length} / ${MAP.nodes.length}`;

  $("uiLevel").textContent = `Stufe ${state.level}`;
  const streakText =
    state.streakCorrect > 0 ? `${state.streakCorrect} richtig in Folge` :
    state.streakWrong > 0   ? `${state.streakWrong} falsch in Folge` :
                              "keine Serie";
  $("uiStreak").textContent = streakText;

  $("uiStatus").textContent = state.chapterComplete ? "Kapitel abgeschlossen" : "l√§uft";
  $("uiTip").textContent = "Lies zuerst den Text.";

  $("uiStarsCount").textContent = String(state.stars);

  const c = state.currentNodeId ? getCard(state.currentNodeId) : null;
  $("uiFocus").textContent = c ? `Fokus: ${c.focus}` : "Fokus: -";
  $("uiNodeState").textContent = (c && state.done[c.id]) ? "Status: erledigt" : "Status: offen";
  $("uiNodeId").textContent = state.currentNodeId ? `Knoten: ${state.currentNodeId.toUpperCase()}` : "Knoten: -";
}

/** =========================
 *  Render Map
 *  ========================= */
function renderMap(){
  const wrap = $("map");
  wrap.innerHTML = "";

  MAP.nodes.forEach(n=>{
    const card = getCard(n.id);
    const unlocked = isUnlocked(n.id);
    const done = !!state.done[n.id];

    const el = document.createElement("div");
    el.className = "node" + (unlocked ? "" : " locked") + (done ? " done":"");
    el.innerHTML = `
      <small>${done ? "erledigt" : unlocked ? "bereit" : "gesperrt"}</small>
      <b>${card?.nodeTitle ?? n.id}</b>
    `;
    el.onclick = () => {
      if(!unlocked || state.chapterComplete) return;
      state.currentNodeId = n.id;
      saveState();
      showPlay();
      renderAll();
    };
    wrap.appendChild(el);
  });
}

/** =========================
 *  Silben Demo (Platzhalter)
 *  ========================= */
function syllabifySimple(word){
  return word.replace(/([aeiou√§√∂√ºy]{1,2})([^aeiou√§√∂√ºy])/gi, "$1-$2");
}
function applySyllablesToText(lines){
  return lines.map(line=>{
    return line.split(" ").map(w=>{
      const clean = w.replace(/[.,!?]/g,"");
      if(clean.length >= 7){
        return w.replace(clean, syllabifySimple(clean));
      }
      return w;
    }).join(" ");
  });
}

/** =========================
 *  Card Rendering
 *  ========================= */
let cardStartTs = null;
let currentOptions = null; // [{text,isCorrect}]
let lastOptionButtons = null;

function renderCard(){
  const nodeId = state.currentNodeId;
  const c = nodeId ? getCard(nodeId) : null;

  if(state.chapterComplete || !c){
    $("card").innerHTML = `<div class="feedback">Kein aktiver Knoten. √ñffne die Diagnose oder starte neu.</div>`;
    return;
  }

  const level = state.level;
  let lines = c.textByLevel[level] || c.textByLevel[1];
  const question = c.questionByLevel[level] || c.questionByLevel[1];
  const answers = c.answersByLevel[level] || c.answersByLevel[1];
  const helps = HELP_RULES[level];

  let renderedLines = lines;
  if(helps.syllables) renderedLines = applySyllablesToText(lines);

  // Optionen bauen + mischen (Fix: richtige Antwort nicht immer oben)
  const base = answers.map((t, idx)=>({ text:t, isCorrect: idx === c.correctIndex }));
  currentOptions = shuffle([...base]);

  $("card").innerHTML = `
    <div class="scene">
      <div class="meta">
        <small>Szene</small>
        <b>${c.nodeTitle}</b>
      </div>
      <span class="pill">üèÅ Ziel: richtig lesen</span>
    </div>

    <div class="readingBox" id="readingBox">
      <div class="readingLabel">
        <b>Lesetext</b>
        <div class="readingHint">Lies zuerst den Text. Dann beantworte die Frage.</div>
      </div>
      <div class="text" id="cardText">
        ${renderedLines.map(x=>`<div>${x}</div>`).join("")}
      </div>
    </div>

    <div class="question">${question}</div>

    <div class="answers" id="answers"></div>

    <div class="helpers">
      ${helps.rereadButton ? `<button id="btnReread">Nochmal lesen</button>` : ""}
      ${helps.hintButton ? `<button id="btnHint">Hinweis</button>` : ""}
      <span class="pill">üéØ Fokus: <b style="color:var(--txt)">${c.focus}</b></span>
    </div>

    <div class="hr"></div>
    <div class="feedback" id="feedback">W√§hle eine Antwort.</div>
  `;

  const ansWrap = $("answers");
  lastOptionButtons = [];

  currentOptions.forEach((opt, idx)=>{
    const b = document.createElement("button");
    b.className = "option";
    b.textContent = opt.text;
    b.onclick = () => submitAnswer(idx, b);
    ansWrap.appendChild(b);
    lastOptionButtons.push(b);
  });

  if(helps.rereadButton){
    $("btnReread").onclick = () => {
      setMonster("Lies den Text noch einmal. Die L√∂sung steht im Satz.");
      $("feedback").textContent = "Nochmal lesen aktiviert.";
      const box = $("readingBox");
      box.style.borderColor = "rgba(255,255,255,.35)";
      setTimeout(()=> box.style.borderColor = "rgba(255,255,255,.22)", 520);
    };
  }
  if(helps.hintButton){
    $("btnHint").onclick = () => {
      setMonster(`Tipp: ${c.hint}`);
      $("feedback").textContent = `Hinweis: ${c.hint}`;
    };
  }

  cardStartTs = performance.now();
}

/** =========================
 *  Adaptive Regeln
 *  ========================= */
function adaptAfterAnswer(correct){
  if(correct){
    state.streakCorrect += 1;
    state.streakWrong = 0;

    if(state.streakCorrect >= APP.TARGET_STREAK_UP && state.level < APP.LEVEL_MAX){
      state.level += 1;
      state.streakCorrect = 0;
      setMonster(`Stufe erh√∂ht: ${state.level}.`, "good");
    } else {
      setMonster("Richtig. Weiter.", "good");
    }
  }else{
    state.streakWrong += 1;
    state.streakCorrect = 0;

    const side = MAP.sidepaths[Math.floor(Math.random()*MAP.sidepaths.length)];
    setMonster(`Das war der ${side}. Lies den Satz noch einmal.`, "bad");
  }
}

/** =========================
 *  Submit
 *  ========================= */
function lockOptions(){
  if(!lastOptionButtons) return;
  lastOptionButtons.forEach(btn => btn.disabled = true);
}

function submitAnswer(optionIdx, btnEl){
  const nodeId = state.currentNodeId;
  const c = getCard(nodeId);
  if(!c || state.chapterComplete || !currentOptions) return;

  const timeMs = Math.max(1, Math.round(performance.now() - (cardStartTs ?? performance.now())));
  const chosen = currentOptions[optionIdx];
  const correct = !!chosen?.isCorrect;

  // Logging
  state.logs.push({
    ts: Date.now(),
    nodeId,
    level: state.level,
    correct,
    timeMs,
    focus: c.focus,
    chosenText: chosen?.text ?? "",
    correctText: (c.answersByLevel[state.level] || c.answersByLevel[1])[c.correctIndex]
  });

  lockOptions();

  if(correct){
    state.stars += 1;
    state.done[nodeId] = true;

    if(btnEl) btnEl.classList.add("correctFlash");
    flyStarFromElement(btnEl);

    $("uiStarsCount").textContent = String(state.stars);
    $("feedback").innerHTML = `<span class="good">Richtig.</span> ‚≠ê 1 Stern.`;

    adaptAfterAnswer(true);

    if(allNodesDone()){
      state.chapterComplete = true;
      state.currentNodeId = null;
      saveState();
      showComplete();
      renderAll();
      return;
    }

    state.currentNodeId = nextUnlockedUndoneNode();
    saveState();

    // Mini-Delay f√ºr ‚ÄúFeedback Gef√ºhl‚Äù, dann neue Karte
    setTimeout(()=> renderAll(), 280);
    return;
  }

  // Falsch
  if(btnEl) btnEl.classList.add("wrongFlash");
  $("feedback").innerHTML = `<span class="bad">Noch nicht.</span> Tipp: ${c.hint}`;
  adaptAfterAnswer(false);
  saveState();
}

/** =========================
 *  Diagnose
 *  ========================= */
function renderDashboard(){
  const logs = state.logs;
  const doneCount = Object.keys(state.done).length;

  const total = logs.length;
  const correct = logs.filter(x=>x.correct).length;
  const acc = total ? Math.round((correct/total)*100) : 0;

  const avgTime = total ? Math.round(logs.reduce((a,b)=>a+b.timeMs,0)/total) : 0;

  $("dDone").textContent = `Abgeschlossen: ${doneCount} / ${MAP.nodes.length}`;
  $("dAcc").textContent = `Trefferquote: ${acc}%`;
  $("dTime").textContent = `√ò Zeit: ${Math.round(avgTime/1000)} s`;

  const wrong = logs.filter(x=>!x.correct);
  const byFocus = {};
  wrong.forEach(x=>{
    byFocus[x.focus] = byFocus[x.focus] || { count:0, exampleNodeId:x.nodeId };
    byFocus[x.focus].count++;
  });

  const rows = Object.entries(byFocus)
    .sort((a,b)=>b[1].count - a[1].count)
    .slice(0,5);

  const tbody = $("dPatterns");
  tbody.innerHTML = "";
  if(rows.length===0){
    tbody.innerHTML = `<tr><td colspan="3" style="color:var(--muted)">Noch keine Fehlmuster.</td></tr>`;
  }else{
    rows.forEach(([focus, data])=>{
      const card = getCard(data.exampleNodeId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${focus}</td>
        <td>${data.count}</td>
        <td>${card ? card.nodeTitle : data.exampleNodeId}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  const strengths = [];
  if(acc >= 80) strengths.push("Trefferquote ist hoch.");
  if(avgTime && avgTime < 6000) strengths.push("Tempo ist stabil.");
  if(doneCount >= 3) strengths.push("Viele Karten geschafft.");

  if(strengths.length===0) strengths.push("Startphase: weiter spielen, dann wird die Diagnose pr√§ziser.");

  const focus = rows.length ? rows[0][0] : "Aufmerksamkeit";
  const mission =
    acc >= 80 ? "8 Minuten pro Tag. Schwierigkeit stabil halten." :
    acc >= 60 ? "8 Minuten pro Tag. Hinweis nur bei Bedarf." :
                "8 Minuten pro Tag. Text zuerst, dann Frage. Hinweis nutzen.";

  $("dCoach").innerHTML = `
    <b>St√§rken</b>
    <ul style="margin:6px 0 12px 18px;">
      ${strengths.slice(0,3).map(s=>`<li>${s}</li>`).join("")}
    </ul>
    <b>Fokus</b>
    <div style="margin-top:6px;">
      <span class="pill">Top-Fokus: <b style="color:var(--txt)">${focus}</b></span>
    </div>
    <div style="margin-top:12px;"><b>Empfohlene Mission</b></div>
    <div style="margin-top:6px;color:var(--muted)">${mission}</div>
  `;
}

/** =========================
 *  Views
 *  ========================= */
function showPlay(){
  $("viewPlay").classList.remove("hidden");
  $("viewDash").classList.add("hidden");
  $("viewComplete").classList.add("hidden");
  $("btnPlay").classList.add("primary");
  $("btnDash").classList.remove("primary");
}
function showDash(){
  $("viewDash").classList.remove("hidden");
  $("viewPlay").classList.add("hidden");
  $("viewComplete").classList.add("hidden");
  $("btnDash").classList.add("primary");
  $("btnPlay").classList.remove("primary");
  renderDashboard();
}
function showComplete(){
  $("viewComplete").classList.remove("hidden");
  $("viewPlay").classList.add("hidden");
  $("viewDash").classList.add("hidden");
  $("btnPlay").classList.remove("primary");
  $("btnDash").classList.remove("primary");
}

/** =========================
 *  Complete Screen
 *  ========================= */
function renderComplete(){
  $("completeStars").textContent = String(state.stars);
  $("completeText").innerHTML = `
    Kapitel abgeschlossen.<br>
    Abgeschlossene Knoten: <b>${Object.keys(state.done).length}</b> / <b>${MAP.nodes.length}</b><br>
    Stufe am Ende: <b>${state.level}</b><br>
    √ñffne die Diagnose, um Fehlmuster und Fokus zu sehen.
  `;
}

/** =========================
 *  Render All
 *  ========================= */
function renderAll(){
  renderTop();
  renderMap();

  if(state.chapterComplete){
    setMonster("Kapitel ist abgeschlossen. Diagnose zeigt die Auswertung.");
    renderComplete();
    return;
  }

  // Guide Standardtext
  if(state.logs.length === 0){
    setMonster("Willkommen im Wald. Lies den Text. Beantworte die Frage. Sammle Sterne.");
  } else {
    // nicht aggressiv √ºberschreiben, wenn gerade Feedback im Monster steht
    // nur, wenn kein Text vorhanden w√§re
    if(!$("monsterSpeech").innerText.trim()){
      setMonster("Weiter geht es. Lies den Text. Dann die Frage.");
    }
  }

  renderCard();
}

/** =========================
 *  Buttons
 *  ========================= */
$("btnPlay").onclick = () => { showPlay(); renderAll(); };
$("btnDash").onclick = () => { showDash(); };

$("btnReset").onclick = () => {
  const ok = confirm("Alles zur√ºcksetzen? Sterne, Fortschritt und Diagnose werden gel√∂scht.");
  if(!ok) return;
  state = defaultState();
  saveState();
  showPlay();
  setMonster("Reset durchgef√ºhrt. Starte neu.");
  renderAll();
};

$("btnReplay").onclick = () => {
  state = defaultState();
  saveState();
  showPlay();
  setMonster("Neu gestartet. Los geht es.");
  renderAll();
};

$("btnGoDash").onclick = () => showDash();

/** Init */
showPlay();
renderAll();
</script>
</body>
</html>

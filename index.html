<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Leselabyrinth – Funkelwald (MVP)</title>

  <style>
    :root{
      --bg0:#070a14;
      --bg1:#0b1030;
      --bg2:#171a3a;

      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);

      --text:#eaf0ff;
      --muted:#b9c2e8;

      --good:#45d483;
      --bad:#ff6b6b;

      --gold:#ffd36a;
      --blue:#6fd0ff;
      --pink:#ff4fa3;

      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --radius: 22px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(255,79,163,.18), transparent 60%),
        radial-gradient(900px 600px at 70% 20%, rgba(111,208,255,.14), transparent 60%),
        radial-gradient(900px 700px at 50% 80%, rgba(255,211,106,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 40%, var(--bg2));
      overflow-x:hidden;
    }

    /* Top HUD */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(8,10,24,.82), rgba(8,10,24,.38));
      border-bottom: 1px solid var(--stroke);
      padding: 12px 14px;
    }
    .topbar-inner{
      max-width: 1480px;
      margin:0 auto;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 280px;
    }
    .brand .dot{
      width: 10px; height: 10px; border-radius: 50%;
      background: linear-gradient(135deg, var(--pink), var(--gold));
      box-shadow: 0 0 18px rgba(255,79,163,.45);
    }
    .brand .title{
      font-weight: 1000;
      letter-spacing: .2px;
      line-height: 1.1;
      font-size: 16px;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      opacity: .95;
      margin-top: 2px;
    }

    .hud{
      display:flex;
      gap: 10px;
      align-items:center;
      flex: 1;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .pill{
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      white-space: nowrap;
      position: relative;
      overflow:hidden;
      transform-origin:center;
    }
    .pill b{ font-weight: 1000; }
    .icon{
      width: 30px; height: 30px; object-fit: contain;
      filter: drop-shadow(0 0 14px rgba(255,255,255,.12));
      transform-origin:center;
    }

    .hearts{ display:flex; gap:7px; align-items:center; }
    .hearts .heart{
      width: 30px; height: 30px; opacity: .98;
      filter: drop-shadow(0 0 14px rgba(255,79,163,.26));
      transform-origin:center;
    }
    .hearts .heart.off{ opacity: .20; filter:none; }

    .sep{ opacity:.25; }
    .tiny{ font-size: 12px; color: var(--muted); opacity:.95; }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.07);
      color: var(--text);
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 1000;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.11); border-color: var(--stroke2); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,79,163,.92), rgba(255,211,106,.88));
      border-color: rgba(255,255,255,.18);
      color: #1a1022;
      box-shadow: 0 14px 35px rgba(255,79,163,.18);
    }

    .xp{
      min-width: 340px;
      max-width: 560px;
      flex: 1;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      position:relative;
      overflow:hidden;
    }
    .xp small{ color: var(--muted); font-weight:1000; }
    .xpbar{
      flex: 1;
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .xpbar > div{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(111,208,255,.92), rgba(255,211,106,.95));
      box-shadow: 0 0 18px rgba(111,208,255,.25);
      transition: width .35s ease;
    }

    /* Layout */
    .wrap{
      max-width: 1480px;
      margin: 0 auto;
      padding: 16px 14px 26px;
      display:grid;
      gap: 14px;
      grid-template-columns: 400px 1fr 360px;
      align-items:start;
    }
    @media (max-width: 1200px){
      .wrap{ grid-template-columns: 380px 1fr; }
      .right{ display:none; }
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .right{ display:block; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(0,0,0,.16);
    }
    .panel .hd h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
      opacity: .95;
      font-weight:1000;
    }
    .panel .bd{ padding: 14px 16px; }

    /* Pergament */
    .parchment{
      background:
        radial-gradient(800px 340px at 20% 20%, rgba(255,240,205,.22), transparent 55%),
        radial-gradient(700px 320px at 80% 35%, rgba(255,220,150,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,235,190,.16), rgba(255,235,190,.08));
      border: 1px solid rgba(255,255,255,.14);
    }
    .parchment .bd{ padding: 16px 16px 16px; }
    .paper{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(700px 220px at 35% 10%, rgba(255,255,255,.15), transparent 60%),
        radial-gradient(700px 260px at 65% 90%, rgba(0,0,0,.10), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.06));
      padding: 14px 14px;
      box-shadow: 0 12px 26px rgba(0,0,0,.25) inset;
      min-height: 190px;
    }
    .paper .label{
      font-size: 12px;
      color: rgba(255,255,255,.85);
      letter-spacing: .2px;
      font-weight: 1000;
      opacity: .95;
    }
    .paper .text{
      margin-top: 10px;
      font-size: 22px;
      line-height: 1.35;
      font-weight: 1000;
      letter-spacing: .1px;
      text-shadow: 0 2px 18px rgba(0,0,0,.25);
    }
    @media (max-width: 560px){
      .paper .text{ font-size: 18px; }
    }

    .q{
      margin-top: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      padding: 12px 12px;
    }
    .q .qt{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
      margin-bottom: 10px;
    }
    .q .qt h3{
      margin:0;
      font-size: 16px;
      font-weight: 1000;
    }
    .qmeta{
      display:flex;
      flex-direction:column;
      gap: 4px;
      text-align:right;
    }
    .answers{ display:grid; gap: 10px; }
    .ans{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
      font-weight: 1000;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      position:relative;
      overflow:hidden;
    }
    .ans:hover{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .ans:active{ transform: translateY(1px); }
    .ans.correct{ border-color: rgba(69,212,131,.55); background: rgba(69,212,131,.12); }
    .ans.wrong{ border-color: rgba(255,107,107,.55); background: rgba(255,107,107,.12); }
    .ans.correct::after{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(220px 140px at 20% 0%, rgba(255,211,106,.25), transparent 55%),
                  radial-gradient(220px 140px at 80% 100%, rgba(111,208,255,.18), transparent 55%);
      pointer-events:none;
      opacity:.9;
      mix-blend-mode: screen;
    }

    .foot{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .statusline{
      font-size: 13px;
      color: var(--muted);
    }
    .statusline .good{ color: var(--good); font-weight: 1000; }
    .statusline .bad{ color: var(--bad); font-weight: 1000; }

    /* Right */
    .right{
      display:flex;
      flex-direction:column;
      gap: 14px;
      position: sticky;
      top: 80px;
    }
    @media (max-width: 980px){
      .right{ position: static; }
    }
    .mini{ display:flex; gap: 12px; align-items:flex-start; }
    .avatar{
      width: 64px; height: 64px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .avatar img{ width: 100%; height: 100%; object-fit: contain; }
    .speech{
      flex:1;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 10px 12px;
      min-height: 64px;
    }
    .speech .name{ font-weight: 1000; }
    .speech .line{ margin-top: 4px; color: var(--muted); font-size: 13px; line-height:1.35; }

    .pathlist{ display:flex; flex-direction:column; gap: 10px; }
    .node{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
    }
    .node:hover{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .node.locked{ opacity:.5; cursor:not-allowed; }
    .node.active{ outline: 2px solid rgba(111,208,255,.35); }
    .node .left{ display:flex; gap:10px; align-items:center; }
    .badge{
      width: 30px; height: 30px;
      border-radius: 11px;
      display:grid; place-items:center;
      font-weight: 1000;
      background: rgba(111,208,255,.12);
      border: 1px solid rgba(111,208,255,.20);
    }

    /* Scene */
    .sceneWrap{
      position: relative;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      min-height: 560px;
      box-shadow: var(--shadow);
    }
    .sceneImg{
      width: 100%;
      height: min(66vh, 660px);
      object-fit: cover;
      display:block;
      transform: scale(1.01);
    }
    .sceneFallback{
      width:100%;
      height: min(66vh, 660px);
      display:none;
      place-items:center;
      background:
        radial-gradient(900px 450px at 50% 25%, rgba(255,211,106,.10), transparent 60%),
        radial-gradient(700px 380px at 30% 80%, rgba(111,208,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(10,12,28,.78), rgba(10,12,28,.92));
      color: rgba(255,255,255,.92);
      text-align:center;
      padding: 18px;
    }
    .sceneFallback.show{ display:grid; }
    .sceneFallback .box{
      width:min(720px, 92%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding: 16px;
    }
    .sceneFallback h3{ margin:0; font-size:18px; font-weight:1000; }
    .sceneFallback p{ margin:10px 0 0; color: var(--muted); line-height:1.35; font-weight:800; }

    .overlay{ position:absolute; inset:0; z-index: 3; }

    /* Hotspots */
    .hotspot{
      position:absolute;
      transform: translate(-50%, -50%);
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
    }
    .hotspot:hover{ transform: translate(-50%,-50%) scale(1.05); filter: drop-shadow(0 0 22px rgba(255,211,106,.28)); }
    .hotspot:active{ transform: translate(-50%,-50%) scale(.99); }
    .hotspot img{
      width: var(--w, 120px);
      height: auto;
      display:block;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
      pointer-events:none;
    }
    .hotspot.small img{ width: var(--w, 120px); }
    .hotspot.tiny img{ width: var(--w, 70px); }

    /* Hint pulse hotspots when blocked (kids can "see" what to do) */
    .hotspot.hint{
      animation: hintPulse 1.25s ease-in-out infinite;
      filter: drop-shadow(0 0 18px rgba(255,211,106,.18));
    }
    @keyframes hintPulse{
      0%,100%{ transform: translate(-50%,-50%) scale(1); opacity: .92; }
      50%{ transform: translate(-50%,-50%) scale(1.08); opacity: 1; }
    }

    /* Fips MAIN */
    .fipsMain{
      position:absolute;
      left: 18px;
      bottom: 14px;
      z-index: 6;
      display:flex;
      align-items:flex-end;
      gap: 14px;
      pointer-events:none;
    }
    .fipsMain .frame{
      width: 210px;
      height: 210px;
      border-radius: 30px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      overflow:hidden;
      display:grid;
      place-items:center;
      position: relative;
    }
    .fipsMain .frame img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      transform-origin:center;
    }
    .fipsMain .bubble{
      max-width: 520px;
      border-radius: 18px;
      background: rgba(8,10,24,.60);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      padding: 10px 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .fipsMain .bubble b{ font-weight:1000; }
    .fipsMain .bubble .line{ color: var(--muted); margin-top:4px; font-size: 13px; line-height:1.35; }

    /* Boss HUD */
    .bossHud{
      position:absolute;
      left: 50%;
      top: 14px;
      transform: translateX(-50%);
      z-index: 7;
      display:none;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .bossHud.show{ display:flex; }
    .bossName{ font-weight:1000; }
    .bossBar{
      width: 220px;
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
    }
    .bossBar > div{
      height:100%;
      width: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,107,107,.92), rgba(255,211,106,.95));
      box-shadow: 0 0 18px rgba(255,107,107,.22);
      transition: width .28s ease;
    }

    /* Gate overlay */
    .gateOpen{
      position:absolute;
      inset:0;
      z-index: 8;
      display:none;
      place-items:center;
      background: radial-gradient(900px 500px at 50% 40%, rgba(255,211,106,.18), rgba(0,0,0,.55));
      backdrop-filter: blur(2px);
    }
    .gateOpen.show{ display:grid; animation: fadeIn .35s ease; }
    @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }
    .gateOpen .card{
      width:min(560px, 92%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.72);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding: 16px 16px;
      text-align:center;
    }
    .gateOpen .card h3{ margin:0; font-size: 18px; font-weight:1000; }
    .gateOpen .card p{ margin:10px 0 0; color: var(--muted); line-height:1.35; }

    /* Toast */
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 80;
      max-width: 460px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(10,12,28,.92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
      display:none;
    }
    .toast.show{ display:block; animation: pop .18s ease; }
    @keyframes pop{ from{ transform: translateY(6px); opacity:.0;} to{ transform: translateY(0); opacity:1;} }
    .toast b{ font-weight: 1000; }

    /* Pickup animation */
    .fly{
      position: fixed;
      z-index: 90;
      width: 46px; height: 46px;
      pointer-events:none;
      filter: drop-shadow(0 0 18px rgba(255,211,106,.35));
      transform: translate(-50%, -50%) scale(1);
    }
    .sparkBurst{
      position: absolute;
      inset: -26px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255,211,106,.35), transparent 60%);
      animation: burst .45s ease-out forwards;
      pointer-events:none;
    }
    @keyframes burst{
      from{ opacity:.0; transform: scale(.6); }
      35%{ opacity:1; transform: scale(1.05); }
      to{ opacity:0; transform: scale(1.35); }
    }

    /* HUD pulse */
    .pulse{ animation: hudPulse .35s ease; }
    @keyframes hudPulse{
      0%{ transform: scale(1); }
      45%{ transform: scale(1.06); }
      100%{ transform: scale(1); }
    }
    .wiggle{ animation: wiggle .45s ease; }
    @keyframes wiggle{
      0%{ transform: rotate(0deg) scale(1); }
      30%{ transform: rotate(-6deg) scale(1.06); }
      60%{ transform: rotate(6deg) scale(1.06); }
      100%{ transform: rotate(0deg) scale(1); }
    }

    /* ============================================================
       KIDS BLOCKER: No reading required
       Big icons + rings + lock + arrow
       ============================================================ */
    .kidBlocker{
      position: fixed;
      inset: 0;
      z-index: 140;
      display:none;
      place-items:center;
      background:
        radial-gradient(900px 500px at 50% 25%, rgba(255,211,106,.18), transparent 60%),
        radial-gradient(900px 520px at 50% 80%, rgba(111,208,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(5,8,18,.70), rgba(5,8,18,.92));
      backdrop-filter: blur(8px);
    }
    .kidBlocker.show{ display:grid; animation: fadeIn .25s ease; }

    .kidPanel{
      width:min(960px, 94%);
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.78);
      box-shadow: 0 30px 90px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .kidTop{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .kidTop .left{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }
    .kidTitleIcon{
      width: 52px; height: 52px;
      border-radius: 18px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      position: relative;
      overflow:hidden;
    }
    .kidTitleIcon::after{
      content:"";
      position:absolute; inset:-30px;
      background: radial-gradient(circle, rgba(255,211,106,.22), transparent 60%);
      animation: kidGlow 1.4s ease-in-out infinite;
    }
    @keyframes kidGlow{
      0%,100%{ opacity:.35; transform: scale(.95); }
      50%{ opacity:1; transform: scale(1.05); }
    }
    .kidTitleIcon svg{ width: 30px; height: 30px; position: relative; z-index: 2; }

    .kidTop h3{
      margin:0;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .kidTop .sub{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      opacity:.95;
    }

    .kidBody{
      padding: 14px 16px 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .kidRow{
      display:grid;
      grid-template-columns: repeat(3, minmax(150px, 1fr));
      gap: 12px;
    }
    @media (max-width: 820px){
      .kidRow{ grid-template-columns: 1fr; }
    }

    .kidTile{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      position:relative;
      overflow:hidden;
    }
    .kidTile.missing{
      border-color: rgba(255,107,107,.26);
      background: rgba(255,107,107,.06);
      animation: kidMissing 1.1s ease-in-out infinite;
    }
    @keyframes kidMissing{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-2px); }
    }

    .kidIcon{
      width: 64px; height: 64px;
      border-radius: 22px;
      display:grid; place-items:center;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .kidIcon img{ width: 54px; height: 54px; object-fit: contain; filter: drop-shadow(0 8px 14px rgba(0,0,0,.35)); }
    .kidIcon::after{
      content:"";
      position:absolute;
      inset:-30px;
      background: radial-gradient(circle, rgba(255,211,106,.22), transparent 60%);
      opacity:.55;
      animation: kidIconGlow 1.25s ease-in-out infinite;
    }
    @keyframes kidIconGlow{
      0%,100%{ transform: scale(.95); opacity:.35; }
      50%{ transform: scale(1.05); opacity:1; }
    }

    .kidCount{
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:flex-end;
      min-width: 88px;
    }

    .kidDots{
      display:flex;
      gap: 6px;
      align-items:center;
      justify-content:flex-end;
    }
    .dot{
      width: 16px; height: 16px;
      border-radius: 6px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 18px rgba(0,0,0,.25) inset;
      opacity:.35;
      transform-origin:center;
    }
    .dot.on{
      opacity:1;
      background: linear-gradient(135deg, rgba(255,211,106,.92), rgba(255,79,163,.70));
      border-color: rgba(255,255,255,.24);
      box-shadow: 0 12px 28px rgba(255,211,106,.16);
      animation: dotPop .35s ease;
    }
    @keyframes dotPop{
      from{ transform: scale(.75); }
      to{ transform: scale(1); }
    }

    .kidFooter{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      padding: 14px 16px 16px;
      border-top: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
    }

    .bigLock{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000;
    }
    .bigLock svg{ width: 22px; height: 22px; }
    .arrowHint{
      display:flex;
      align-items:center;
      gap: 10px;
      color: rgba(255,255,255,.92);
      font-weight: 1000;
    }
    .arrowHint .hand{
      width: 44px; height: 44px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      animation: handTap 1.0s ease-in-out infinite;
    }
    @keyframes handTap{
      0%,100%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-3px) scale(1.06); }
    }

    /* ============================================================
       FIPS CELEBRATION: Fullscreen, ultra animation
       ============================================================ */
    .celebrate{
      position: fixed;
      inset: 0;
      z-index: 150;
      display:none;
      place-items:center;
      pointer-events:none;
      background:
        radial-gradient(900px 520px at 50% 35%, rgba(255,211,106,.22), transparent 60%),
        radial-gradient(900px 520px at 50% 80%, rgba(255,79,163,.14), transparent 60%),
        radial-gradient(900px 520px at 15% 55%, rgba(111,208,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(5,8,18,.55), rgba(5,8,18,.80));
      backdrop-filter: blur(6px);
    }
    .celebrate.show{ display:grid; animation: fadeIn .14s ease; }

    .celebrate .stage{
      width:min(1100px, 96%);
      height: min(78vh, 680px);
      position:relative;
      border-radius: 34px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.16);
      box-shadow: 0 40px 120px rgba(0,0,0,.70);
    }

    .rays{
      position:absolute;
      inset:-40%;
      background:
        conic-gradient(from 90deg,
          rgba(255,211,106,.0),
          rgba(255,211,106,.22),
          rgba(255,211,106,.0),
          rgba(111,208,255,.20),
          rgba(255,79,163,.18),
          rgba(255,211,106,.0));
      filter: blur(2px);
      opacity:.85;
      animation: spin 2.6s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .bigStarBack{
      position:absolute;
      left:50%;
      top:52%;
      width: min(72vh, 620px);
      height: min(72vh, 620px);
      transform: translate(-50%,-50%);
      filter: drop-shadow(0 30px 80px rgba(0,0,0,.55));
      animation: starPulse 1.05s ease-in-out infinite;
      opacity:.95;
    }
    @keyframes starPulse{
      0%,100%{ transform: translate(-50%,-50%) scale(1.00) rotate(0deg); }
      50%{ transform: translate(-50%,-50%) scale(1.03) rotate(2deg); }
    }

    .bigStarBack svg{ width:100%; height:100%; }

    .fipsGiant{
      position:absolute;
      left:50%;
      top:54%;
      transform: translate(-50%,-50%);
      width: min(66vh, 560px);
      height: min(66vh, 560px);
      display:grid;
      place-items:center;
      filter: drop-shadow(0 40px 90px rgba(0,0,0,.55));
    }
    .fipsGiant img{
      width:100%;
      height:100%;
      object-fit: contain;
      transform-origin:center;
      animation: fipsPower 0.92s ease-out forwards;
    }
    @keyframes fipsPower{
      0%{ transform: scale(.55) translateY(40px) rotate(-6deg); opacity:0; }
      30%{ transform: scale(1.06) translateY(-8px) rotate(4deg); opacity:1; }
      60%{ transform: scale(.98) translateY(2px) rotate(0deg); }
      100%{ transform: scale(1.00) translateY(0) rotate(0deg); }
    }

    .shine{
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at 50% 45%, rgba(255,255,255,.62), transparent 55%);
      opacity:.0;
      animation: flash 0.92s ease-out forwards;
    }
    @keyframes flash{
      0%{ opacity:0; transform: scale(.8); }
      30%{ opacity:1; transform: scale(1.05); }
      100%{ opacity:0; transform: scale(1.25); }
    }

    .confetti{
      position:absolute;
      inset:0;
      overflow:hidden;
      pointer-events:none;
    }
    .c{
      position:absolute;
      width: 10px; height: 14px;
      border-radius: 4px;
      background: rgba(255,255,255,.85);
      opacity:.92;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
      animation: fall 1.15s ease-in forwards;
    }
    @keyframes fall{
      0%{ transform: translateY(-60px) rotate(0deg); opacity:0; }
      10%{ opacity:1; }
      100%{ transform: translateY(820px) rotate(240deg); opacity:0; }
    }

    .celebrateBadge{
      position:absolute;
      left: 18px;
      top: 18px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.65);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      font-weight: 1000;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap: 10px;
      animation: badgePop .35s ease;
    }
    @keyframes badgePop{
      from{ transform: translateY(-6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .celebrateBadge .miniStar{
      width: 24px; height: 24px;
      display:grid; place-items:center;
      border-radius: 10px;
      background: rgba(255,211,106,.16);
      border: 1px solid rgba(255,211,106,.25);
    }

    /* Water world splash */
    .splash{
      position: fixed;
      inset: 0;
      z-index: 120;
      display:none;
      place-items:center;
      background:
        radial-gradient(900px 500px at 50% 25%, rgba(111,208,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(5,8,18,.75), rgba(5,8,18,.92));
      backdrop-filter: blur(6px);
    }
    .splash.show{ display:grid; animation: fadeIn .35s ease; }
    .splash .box{
      width:min(920px, 94%);
      border-radius: 24px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.68);
      box-shadow: 0 30px 80px rgba(0,0,0,.60);
    }
    .splash img{
      width:100%;
      height: 320px;
      object-fit: cover;
      display:block;
    }
    .splash .content{
      padding: 14px 16px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .splash h3{ margin:0; font-size: 18px; font-weight:1000; }
    .splash p{ margin:6px 0 0; color: var(--muted); line-height:1.35; }

    .reportGrid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(140px, 1fr));
      gap: 10px;
    }
    @media (max-width: 820px){
      .reportGrid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
    }
    .rep{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .rep .k{ color: var(--muted); font-weight: 1000; font-size: 12px; }
    .rep .v{ font-weight: 1000; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Leselabyrinth – Funkelwald</div>
          <div class="sub">Kinder-RPG Lesetraining · Szene-Pfad · Progression · Sammeln</div>
        </div>
      </div>

      <div class="hud">
        <div class="pill" id="pillHearts" title="Leben (3 Herzen)">
          <span class="tiny"><b>Leben</b></span>
          <div class="hearts" id="hearts"></div>
        </div>

        <div class="pill" id="pillStars" title="Sterne">
          <img class="icon" src="assets/ui/icons/stern.png" alt="Stern" />
          <span><b id="starsVal">0</b></span>
          <span class="sep">|</span>
          <span class="tiny">Sterne</span>
        </div>

        <div class="pill" id="pillApples" title="Äpfel">
          <img class="icon" src="assets/ui/interactables/Apfel.png" alt="Apfel" />
          <span><b id="applesVal">0</b></span>
          <span class="sep">|</span>
          <span class="tiny">Äpfel</span>
        </div>

        <div class="pill" id="pillLanterns" title="Laternen">
          <img class="icon" src="assets/ui/interactables/Laterne.png" alt="Laterne" />
          <span><b id="lanternsVal">0</b></span>
          <span class="sep">|</span>
          <span class="tiny">Laternen</span>
        </div>

        <div class="pill" id="pillSparks" title="Geheimfunken">
          <img class="icon" src="assets/ui/icons/geheimfunke.png" alt="Geheimfunke" />
          <span><b id="sparksVal">0</b></span>
          <span class="sep">|</span>
          <span class="tiny">Funken</span>
        </div>

        <div class="pill" title="Serie, Stufe, Fokus">
          <span class="tiny">Serie</span> <b id="streakVal">0</b>
          <span class="sep">|</span>
          <span class="tiny">Stufe</span> <b id="levelVal">1</b>
          <span class="sep">|</span>
          <span class="tiny">Fokus</span> <b id="focusVal">W-Frage</b>
        </div>

        <div class="xp" id="pillXP" title="XP Fortschritt">
          <small><b>XP</b> <span id="xpVal">0</span>/<span id="xpNeed">100</span></small>
          <div class="xpbar"><div id="xpBar"></div></div>
        </div>

        <button class="btn" id="resetBtn">Reset</button>
        <button class="btn primary" id="helpBtn">Hilfe</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT -->
    <div class="panel parchment">
      <div class="hd">
        <h2>Pergament</h2>
        <span class="tiny"><b>Szene</b> <span id="sceneTitle">–</span></span>
      </div>
      <div class="bd">
        <div class="paper">
          <div class="label">LESETEXT</div>
          <div class="text" id="readText">–</div>
        </div>

        <div class="q">
          <div class="qt">
            <div>
              <h3 id="question">–</h3>
              <div class="tiny" id="goalLine" style="margin-top:6px">Sammelziel: –</div>
            </div>
            <div class="qmeta">
              <span class="tiny">Erst lesen, dann antworten.</span>
              <span class="tiny" id="qProgress">Frage 1/3</span>
            </div>
          </div>

          <div class="answers" id="answers"></div>

          <div class="foot">
            <div class="row">
              <button class="btn" id="reReadBtn">Nochmal lesen</button>
              <button class="btn" id="nextBtn" disabled>Nächste Szene</button>
            </div>
            <div class="statusline" id="statusLine">Status: <span class="tiny">offen</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MIDDLE -->
    <div class="sceneWrap" id="sceneWrap">
      <img id="sceneImg" class="sceneImg" src="" alt="Szene" />
      <div class="sceneFallback" id="sceneFallback">
        <div class="box">
          <h3>Szene-Bild fehlt</h3>
          <p>Das Bild wurde nicht gefunden. Pfad prüfen: assets/scenes/…</p>
        </div>
      </div>

      <div class="overlay" id="overlay"></div>

      <!-- Boss HUD -->
      <div class="bossHud" id="bossHud">
        <span class="bossName" id="bossName">Boss</span>
        <div class="bossBar"><div id="bossBarFill"></div></div>
        <span class="tiny"><b id="bossHPText">3</b>/3</span>
      </div>

      <!-- Fips MAIN -->
      <div class="fipsMain">
        <div class="frame">
          <img id="fipsMainImg" src="assets/chars/fips/idle.png" alt="Fips" />
        </div>
        <div class="bubble">
          <b>Fips</b>
          <div class="line" id="fipsMainLine">Tippe Dinge im Bild an. Sammle Sterne, Äpfel, Laternen. Dann lies das Pergament.</div>
        </div>
      </div>

      <!-- Gate open -->
      <div class="gateOpen" id="gateOpen">
        <div class="card">
          <h3>Das Tor öffnet sich</h3>
          <p>Boss besiegt. Als Nächstes geht es in die Wasserwelt.</p>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="panel">
        <div class="hd">
          <h2>Guide</h2>
          <span class="tiny">Fips der Funkenkobold</span>
        </div>
        <div class="bd">
          <div class="mini">
            <div class="avatar"><img id="fipsAvatar" src="assets/chars/fips/idle.png" alt="Fips" /></div>
            <div class="speech">
              <div class="name">Fips</div>
              <div class="line" id="fipsLine">Sammle Dinge, lies, beantworte 3 Fragen. Bonus: Finde den Geheimfunken.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="hd">
          <h2>Kapitel: Funkelwald</h2>
          <span class="tiny" id="chapterStatus">0/5 erledigt</span>
        </div>
        <div class="bd">
          <div class="pathlist" id="pathList"></div>
          <div style="height:10px"></div>
          <div class="tiny" id="unlockHint">Freischaltung: 3 richtige Antworten + Sammelziel erfüllen.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- KIDS BLOCKER (icons-only friendly) -->
  <div class="kidBlocker" id="kidBlocker">
    <div class="kidPanel">
      <div class="kidTop">
        <div class="left">
          <div class="kidTitleIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M7 10V8a5 5 0 0 1 10 0v2" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/>
              <path d="M6.5 10h11a2 2 0 0 1 2 2v6.2a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2V12a2 2 0 0 1 2-2Z"
                stroke="rgba(255,255,255,.9)" stroke-width="2" />
              <path d="M12 14.2v2.6" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h3 id="kidTitle">Noch nicht</h3>
            <div class="sub" id="kidSub">Sammeln</div>
          </div>
        </div>
        <button class="btn" id="kidCloseBtn">Schließen</button>
      </div>

      <div class="kidBody">
        <div class="kidRow" id="kidTiles"></div>
      </div>

      <div class="kidFooter">
        <div class="bigLock" title="Noch gesperrt">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 10V8a5 5 0 0 1 10 0v2" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/>
            <path d="M6.5 10h11a2 2 0 0 1 2 2v6.2a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2V12a2 2 0 0 1 2-2Z"
              stroke="rgba(255,255,255,.9)" stroke-width="2" />
          </svg>
          <span id="kidLockText">—</span>
        </div>

        <div class="arrowHint">
          <div class="hand" aria-hidden="true">☝</div>
          <div id="kidHintText">Im Bild tippen</div>
        </div>

        <button class="btn primary" id="kidOkBtn">Ok</button>
      </div>
    </div>
  </div>

  <!-- FIPS CELEBRATION FULLSCREEN -->
  <div class="celebrate" id="celebrate">
    <div class="stage">
      <div class="rays"></div>
      <div class="shine"></div>

      <div class="bigStarBack" aria-hidden="true">
        <svg viewBox="0 0 200 200">
          <defs>
            <linearGradient id="gStar2" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#ffe9a8"/>
              <stop offset="0.55" stop-color="#ffd36a"/>
              <stop offset="1" stop-color="#ff8ec6"/>
            </linearGradient>
          </defs>
          <path fill="url(#gStar2)" stroke="rgba(255,255,255,.65)" stroke-width="4"
            d="M100 14
               L123 68
               L184 74
               L138 113
               L152 170
               L100 138
               L48 170
               L62 113
               L16 74
               L77 68
               Z" />
        </svg>
      </div>

      <div class="celebrateBadge" id="celebrateBadge">
        <div class="miniStar" aria-hidden="true">★</div>
        <div id="celebrateText">Richtig</div>
      </div>

      <div class="fipsGiant">
        <img id="fipsGiantImg" src="assets/chars/fips/excited.png" alt="Fips" />
      </div>

      <div class="confetti" id="confetti"></div>
    </div>
  </div>

  <!-- Water world splash -->
  <div class="splash" id="splash">
    <div class="box">
      <img src="assets/scenes/wasserwelt.png" alt="Wasserwelt" />
      <div class="content">
        <div>
          <h3>Kapitel 2: Wasserwelt</h3>
          <p>Funkelwald ist geschafft. Als Nächstes wartet die Wasserwelt.</p>
          <div class="reportGrid" id="reportGrid"></div>
        </div>
        <div class="row">
          <button class="btn primary" id="closeSplashBtn">Schließen</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ------------------------------------------------------------
  // Assets
  // ------------------------------------------------------------
  const ASSETS = {
    scenes: {
      waldweg:     ["assets/scenes/waldweg.png","assets/scenes/waldweg.jpg","assets/scenes/Waldweg.png"],
      holzbruecke: ["assets/scenes/holzbruecke.png","assets/scenes/holzbruecke.jpg","assets/scenes/Holzbruecke.png"],
      apfelbaum:   ["assets/scenes/apfelbaum.png","assets/scenes/apfelbaum.jpg","assets/scenes/Apfelbaum.png"],
      sternstein:  ["assets/scenes/sternstein.png","assets/scenes/sternstein.jpg","assets/scenes/Sternstein.png"],
      // FIX: Boss-Tor lädt manchmal nicht -> mehrere Kandidaten
      bosstor:     ["assets/scenes/bosstor.png","assets/scenes/bossTor.png","assets/scenes/boss_tor.png","assets/scenes/BossTor.png","assets/scenes/bosstor.jpg","assets/scenes/bosstor.webp"],
      wasserwelt:  ["assets/scenes/wasserwelt.png","assets/scenes/wasserwelt.jpg","assets/scenes/Wasserwelt.png"],
    },
    interact: {
      Stern:   "assets/ui/interactables/Stern.png",
      Apfel:   "assets/ui/interactables/Apfel.png",
      Laterne: "assets/ui/interactables/Laterne.png",
    },
    icons: {
      herz:  "assets/ui/icons/herz.png",
      stern: "assets/ui/icons/stern.png",
      spark: "assets/ui/icons/geheimfunke.png",
    },
    fips: {
      idle:     "assets/chars/fips/idle.png",
      happy:    "assets/chars/fips/happy.png",
      excited:  "assets/chars/fips/excited.png",
      thinking: "assets/chars/fips/thinking.png",
      sad:      "assets/chars/fips/sad.png",
    }
  };

  // ------------------------------------------------------------
  // Nodes (3 Fragen + Sammelziel)
  // ------------------------------------------------------------
  const NODES = [
    {
      id:"N1", key:"waldweg", title:"Waldweg",
      sparkHotspot: { x: 14, y: 78, r: 7 },
      goals: { stars:1, apples:1, lanterns:1 },
      interactables: [
        { id:"star1", type:"collect_star",    img:ASSETS.interact.Stern,   x: 38, y: 70, size:"small", once:true, points: 1, label:"Stern" },
        { id:"lan1",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 73, y: 33, size:"small", once:true, points: 1, label:"Laterne" },
        { id:"ap1",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 86, y: 40, size:"small", once:true, points: 1, label:"Apfel" }
      ],
      readSteps: [
        {
          text: ["Fips steht am Waldweg.","Eine Laterne leuchtet.","Fips bleibt ruhig und liest."].join("<br>"),
          question: "Wo steht Fips?",
          answers: [
            { t:"Am Waldweg.", correct:true },
            { t:"Im Wasser.", correct:false },
            { t:"Auf dem Dach.", correct:false }
          ]
        },
        {
          text: ["Fips steht am Waldweg.","Eine Laterne leuchtet.","Fips bleibt ruhig und liest."].join("<br>"),
          question: "Was leuchtet?",
          answers: [
            { t:"Die Laterne.", correct:true },
            { t:"Ein Auto.", correct:false },
            { t:"Ein Schuh.", correct:false }
          ]
        },
        {
          text: ["Fips steht am Waldweg.","Eine Laterne leuchtet.","Fips bleibt ruhig und liest."].join("<br>"),
          question: "Was tut Fips?",
          answers: [
            { t:"Er liest.", correct:true },
            { t:"Er rennt.", correct:false },
            { t:"Er schläft.", correct:false }
          ]
        }
      ]
    },
    {
      id:"N2", key:"holzbruecke", title:"Holzbrücke",
      sparkHotspot: { x: 82, y: 63, r: 7 },
      goals: { stars:1, apples:1, lanterns:1 },
      interactables: [
        { id:"star2", type:"collect_star",    img:ASSETS.interact.Stern,   x: 55, y: 72, size:"small", once:true, points: 1, label:"Stern" },
        { id:"lan2",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 22, y: 42, size:"small", once:true, points: 1, label:"Laterne" },
        { id:"ap2",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 80, y: 78, size:"tiny",  once:true, points: 1, label:"Apfel" }
      ],
      readSteps: [
        {
          text: ["Vor Fips ist eine Holzbrücke.","Fips geht langsam.","Die Brücke knarrt leise."].join("<br>"),
          question: "Was ist vor Fips?",
          answers: [
            { t:"Eine Holzbrücke.", correct:true },
            { t:"Ein Auto.", correct:false },
            { t:"Ein Flugzeug.", correct:false }
          ]
        },
        {
          text: ["Vor Fips ist eine Holzbrücke.","Fips geht langsam.","Die Brücke knarrt leise."].join("<br>"),
          question: "Was macht die Brücke?",
          answers: [
            { t:"Sie knarrt leise.", correct:true },
            { t:"Sie fliegt.", correct:false },
            { t:"Sie schläft.", correct:false }
          ]
        },
        {
          text: ["Vor Fips ist eine Holzbrücke.","Fips geht langsam.","Die Brücke knarrt leise."].join("<br>"),
          question: "Wie geht Fips?",
          answers: [
            { t:"Langsam.", correct:true },
            { t:"Rückwärts.", correct:false },
            { t:"Unsichtbar.", correct:false }
          ]
        }
      ]
    },
    {
      id:"N3", key:"apfelbaum", title:"Apfelbaum",
      sparkHotspot: { x: 50, y: 18, r: 7 },
      goals: { stars:1, apples:1, lanterns:1 },
      interactables: [
        { id:"star3", type:"collect_star",    img:ASSETS.interact.Stern,   x: 25, y: 77, size:"small", once:true, points: 1, label:"Stern" },
        { id:"ap3",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 78, y: 40, size:"small", once:true, points: 1, label:"Apfel" },
        { id:"lan3",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 60, y: 70, size:"tiny",  once:true, points: 1, label:"Laterne" }
      ],
      readSteps: [
        {
          text: ["Fips sieht einen Apfelbaum.","Ein Apfel hängt am Ast.","Fips lächelt."].join("<br>"),
          question: "Was sieht Fips?",
          answers: [
            { t:"Einen Apfelbaum.", correct:true },
            { t:"Einen Fernseher.", correct:false },
            { t:"Eine Rakete.", correct:false }
          ]
        },
        {
          text: ["Fips sieht einen Apfelbaum.","Ein Apfel hängt am Ast.","Fips lächelt."].join("<br>"),
          question: "Was hängt am Ast?",
          answers: [
            { t:"Ein Apfel.", correct:true },
            { t:"Ein Hut.", correct:false },
            { t:"Ein Ball.", correct:false }
          ]
        },
        {
          text: ["Fips sieht einen Apfelbaum.","Ein Apfel hängt am Ast.","Fips lächelt."].join("<br>"),
          question: "Was macht Fips?",
          answers: [
            { t:"Er lächelt.", correct:true },
            { t:"Er bellt.", correct:false },
            { t:"Er schwimmt.", correct:false }
          ]
        }
      ]
    },
    {
      id:"N4", key:"sternstein", title:"Sternstein",
      sparkHotspot: { x: 18, y: 34, r: 7 },
      goals: { stars:1, apples:1, lanterns:1 },
      interactables: [
        { id:"star4", type:"collect_star",    img:ASSETS.interact.Stern,   x: 52, y: 73, size:"small", once:true, points: 1, label:"Stern" },
        { id:"lan4",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 78, y: 40, size:"small", once:true, points: 1, label:"Laterne" },
        { id:"ap4",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 86, y: 84, size:"tiny",  once:true, points: 1, label:"Apfel" }
      ],
      readSteps: [
        {
          text: ["Fips findet einen Sternstein.","Der Stein glitzert.","Fips tippt ihn an."].join("<br>"),
          question: "Was findet Fips?",
          answers: [
            { t:"Einen Sternstein.", correct:true },
            { t:"Einen Stuhl.", correct:false },
            { t:"Einen Steinpilz.", correct:false }
          ]
        },
        {
          text: ["Fips findet einen Sternstein.","Der Stein glitzert.","Fips tippt ihn an."].join("<br>"),
          question: "Was glitzert?",
          answers: [
            { t:"Der Stein.", correct:true },
            { t:"Der Schuh.", correct:false },
            { t:"Der Stuhl.", correct:false }
          ]
        },
        {
          text: ["Fips findet einen Sternstein.","Der Stein glitzert.","Fips tippt ihn an."].join("<br>"),
          question: "Was macht Fips?",
          answers: [
            { t:"Er tippt ihn an.", correct:true },
            { t:"Er wirft ihn weg.", correct:false },
            { t:"Er versteckt sich.", correct:false }
          ]
        }
      ]
    },
    {
      id:"N5", key:"bosstor", title:"Boss-Tor",
      sparkHotspot: { x: 90, y: 20, r: 7 },
      goals: { stars:1, apples:1, lanterns:1 },
      interactables: [
        { id:"star5", type:"collect_star",    img:ASSETS.interact.Stern,   x: 40, y: 72, size:"small", once:true, points: 1, label:"Stern" },
        { id:"lan5",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 70, y: 35, size:"small", once:true, points: 1, label:"Laterne" },
        { id:"ap5",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 84, y: 74, size:"tiny",  once:true, points: 1, label:"Apfel" }
      ],
      boss: { name: "Torwächter", hpMax: 3 },
      readBoss: [
        {
          text: ["Vor Fips ist ein großes Tor.","Fips braucht einen Schlüssel.","Das Tor bleibt zu."].join("<br>"),
          question: "Was braucht Fips?",
          answers: [
            { t:"Den Schlüssel.", correct:true },
            { t:"Einen Ball.", correct:false },
            { t:"Eine Leiter.", correct:false }
          ]
        },
        {
          text: ["Fips bleibt ruhig.","Fips liest den Text.","Fips denkt nach."].join("<br>"),
          question: "Was macht Fips?",
          answers: [
            { t:"Er liest den Text.", correct:true },
            { t:"Er schläft.", correct:false },
            { t:"Er fliegt.", correct:false }
          ]
        },
        {
          text: ["Ein Funken glitzert.","Fips bleibt aufmerksam.","Das Tor wartet."].join("<br>"),
          question: "Was glitzert?",
          answers: [
            { t:"Ein Funken.", correct:true },
            { t:"Ein Auto.", correct:false },
            { t:"Ein Baum.", correct:false }
          ]
        }
      ]
    }
  ];

  // ------------------------------------------------------------
  // Storage
  // ------------------------------------------------------------
  const STORAGE_KEY = "leselabyrinth_funkelwald_v5_fipsCelebration_kidBlocker_bossImageFix";

  const defaultState = () => ({
    nodeIndex: 0,
    unlocked: [true, false, false, false, false],
    completed: [false, false, false, false, false],

    stars: 0,
    apples: 0,
    lanterns: 0,
    sparks: 0,
    streak: 0,
    level: 1,
    xp: 0,
    xpNeed: 100,
    heartsMax: 3,
    hearts: 3,
    focus: "W-Frage",

    scene: NODES.map(n => ({
      tries: 0,
      answered: false,
      perfect: true,
      sparkFound: false,
      collected: {},

      qIndex: 0,
      correctSteps: [false,false,false],
      xpGrantedSteps: [false,false,false],

      bossHP: n.boss ? n.boss.hpMax : 0,
      bossStep: 0,
      bossXpGrantedSteps: [false,false,false]
    }))
  });

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      const d = defaultState();
      return {
        ...d,
        ...parsed,
        scene: (parsed.scene && parsed.scene.length === NODES.length) ? parsed.scene : d.scene
      };
    }catch(e){
      return defaultState();
    }
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // ------------------------------------------------------------
  // UI refs
  // ------------------------------------------------------------
  const el = {
    sceneTitle: document.getElementById("sceneTitle"),
    readText: document.getElementById("readText"),
    question: document.getElementById("question"),
    answers: document.getElementById("answers"),
    reReadBtn: document.getElementById("reReadBtn"),
    nextBtn: document.getElementById("nextBtn"),
    statusLine: document.getElementById("statusLine"),
    goalLine: document.getElementById("goalLine"),
    qProgress: document.getElementById("qProgress"),

    sceneWrap: document.getElementById("sceneWrap"),
    sceneImg: document.getElementById("sceneImg"),
    sceneFallback: document.getElementById("sceneFallback"),
    overlay: document.getElementById("overlay"),
    gateOpen: document.getElementById("gateOpen"),

    bossHud: document.getElementById("bossHud"),
    bossName: document.getElementById("bossName"),
    bossBarFill: document.getElementById("bossBarFill"),
    bossHPText: document.getElementById("bossHPText"),

    fipsAvatar: document.getElementById("fipsAvatar"),
    fipsLine: document.getElementById("fipsLine"),
    fipsMainImg: document.getElementById("fipsMainImg"),
    fipsMainLine: document.getElementById("fipsMainLine"),

    pathList: document.getElementById("pathList"),
    chapterStatus: document.getElementById("chapterStatus"),

    hearts: document.getElementById("hearts"),
    starsVal: document.getElementById("starsVal"),
    applesVal: document.getElementById("applesVal"),
    lanternsVal: document.getElementById("lanternsVal"),
    sparksVal: document.getElementById("sparksVal"),
    streakVal: document.getElementById("streakVal"),
    levelVal: document.getElementById("levelVal"),
    focusVal: document.getElementById("focusVal"),
    xpVal: document.getElementById("xpVal"),
    xpNeed: document.getElementById("xpNeed"),
    xpBar: document.getElementById("xpBar"),

    pillHearts: document.getElementById("pillHearts"),
    pillStars: document.getElementById("pillStars"),
    pillApples: document.getElementById("pillApples"),
    pillLanterns: document.getElementById("pillLanterns"),
    pillSparks: document.getElementById("pillSparks"),
    pillXP: document.getElementById("pillXP"),

    resetBtn: document.getElementById("resetBtn"),
    helpBtn: document.getElementById("helpBtn"),

    toast: document.getElementById("toast"),

    kidBlocker: document.getElementById("kidBlocker"),
    kidTitle: document.getElementById("kidTitle"),
    kidSub: document.getElementById("kidSub"),
    kidTiles: document.getElementById("kidTiles"),
    kidLockText: document.getElementById("kidLockText"),
    kidHintText: document.getElementById("kidHintText"),
    kidCloseBtn: document.getElementById("kidCloseBtn"),
    kidOkBtn: document.getElementById("kidOkBtn"),

    celebrate: document.getElementById("celebrate"),
    confetti: document.getElementById("confetti"),
    fipsGiantImg: document.getElementById("fipsGiantImg"),
    celebrateText: document.getElementById("celebrateText"),

    splash: document.getElementById("splash"),
    closeSplashBtn: document.getElementById("closeSplashBtn"),
    reportGrid: document.getElementById("reportGrid"),
  };

  // ------------------------------------------------------------
  // Helpers
  // ------------------------------------------------------------
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

  function toast(html, ms=2200){
    el.toast.innerHTML = html;
    el.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.toast.classList.remove("show"), ms);
  }

  function setFips(mood, line){
    const src = ASSETS.fips[mood] || ASSETS.fips.idle;
    el.fipsAvatar.src = src;
    el.fipsMainImg.src = src;
    el.fipsLine.textContent = line;
    el.fipsMainLine.textContent = line;

    el.fipsMainImg.classList.remove("wiggle");
    void el.fipsMainImg.offsetWidth;
    el.fipsMainImg.classList.add("wiggle");
  }

  function pulse(pill){
    pill.classList.remove("pulse");
    void pill.offsetWidth;
    pill.classList.add("pulse");
  }

  function gainXP(amount){
    state.xp += amount;
    while(state.xp >= state.xpNeed){
      state.xp -= state.xpNeed;
      state.level += 1;
      state.xpNeed = Math.round(state.xpNeed * 1.18 + 10);
      toast(`<b>Level Up!</b> Stufe ${state.level} erreicht.`);
      setFips("excited", `Stufe ${state.level}. Weiter.`);
    }
    pulse(el.pillXP);
  }

  function vibrate(ms=40){
    try{
      if(navigator.vibrate) navigator.vibrate(ms);
    }catch(e){}
  }

  function loseHeart(){
    state.hearts = clamp(state.hearts - 1, 0, state.heartsMax);
    pulse(el.pillHearts);
    vibrate(60);

    if(state.hearts === 0){
      toast(`<b>Oh nein.</b> Keine Herzen mehr. Die Szene startet neu.`);
      const i = state.nodeIndex;
      const s = state.scene[i];

      s.tries = 0;
      s.answered = false;
      s.perfect = true;
      s.collected = {};
      s.sparkFound = false;

      s.qIndex = 0;
      s.correctSteps = [false,false,false];
      s.xpGrantedSteps = [false,false,false];

      if(NODES[i].boss){
        s.bossHP = NODES[i].boss.hpMax;
        s.bossStep = 0;
        s.bossXpGrantedSteps = [false,false,false];
      }

      state.hearts = state.heartsMax;
      state.streak = 0;
      setFips("sad", "Nochmal. Lies und sammle.");
      vibrate(140);
    }
  }

  function burstAtHotspot(hsEl){
    const b = document.createElement("div");
    b.className = "sparkBurst";
    hsEl.appendChild(b);
    setTimeout(()=>b.remove(), 500);
  }

  function flyToHUD(fromClientX, fromClientY, iconSrc, targetEl){
    const rect = targetEl.getBoundingClientRect();
    const tx = rect.left + rect.width/2;
    const ty = rect.top + rect.height/2;

    const img = document.createElement("img");
    img.src = iconSrc;
    img.className = "fly";
    img.style.left = fromClientX + "px";
    img.style.top = fromClientY + "px";
    document.body.appendChild(img);

    img.animate([
      { transform: "translate(-50%,-50%) scale(1)", opacity: 1 },
      { transform: `translate(${(tx-fromClientX)}px, ${(ty-fromClientY)}px) scale(.65)`, opacity: 0 }
    ], { duration: 650, easing: "ease-in", fill: "forwards" });

    setTimeout(()=>img.remove(), 700);
  }

  function goalsForNode(node){
    const g = node.goals || {stars:0,apples:0,lanterns:0};
    return { stars: g.stars||0, apples: g.apples||0, lanterns: g.lanterns||0 };
  }

  function collectedCountsInNode(i){
    const s = state.scene[i];
    let stars=0, apples=0, lanterns=0;
    for(const key in s.collected){
      if(!s.collected[key]) continue;
      if(key.startsWith("star")) stars++;
      if(key.startsWith("ap")) apples++;
      if(key.startsWith("lan")) lanterns++;
    }
    return { stars, apples, lanterns };
  }

  function missingForNode(i){
    const node = NODES[i];
    const g = goalsForNode(node);
    const c = collectedCountsInNode(i);
    return {
      stars: Math.max(0, g.stars - c.stars),
      apples: Math.max(0, g.apples - c.apples),
      lanterns: Math.max(0, g.lanterns - c.lanterns),
      have: c,
      goal: g
    };
  }

  function isGoalMet(i){
    const m = missingForNode(i);
    return (m.stars === 0 && m.apples === 0 && m.lanterns === 0);
  }

  function allQuestionsCorrect(i){
    const s = state.scene[i];
    return s.correctSteps.every(Boolean);
  }

  // ------------------------------------------------------------
  // Kids blocker (no reading needed)
  // ------------------------------------------------------------
  function showKidBlocker(i){
    const m = missingForNode(i);

    el.kidTitle.textContent = "Noch nicht";
    el.kidSub.textContent = "Sammeln";

    el.kidHintText.textContent = "Im Bild tippen";
    el.kidLockText.textContent = "Erst sammeln";

    const tiles = [
      { key:"stars", label:"Sterne", img:"assets/ui/icons/stern.png", have:m.have.stars, need:m.goal.stars },
      { key:"apples", label:"Äpfel", img:"assets/ui/interactables/Apfel.png", have:m.have.apples, need:m.goal.apples },
      { key:"lanterns", label:"Laternen", img:"assets/ui/interactables/Laterne.png", have:m.have.lanterns, need:m.goal.lanterns },
    ];

    el.kidTiles.innerHTML = tiles.map(t => {
      const missing = Math.max(0, t.need - t.have);
      const cls = missing > 0 ? "kidTile missing" : "kidTile";
      const dots = [];
      for(let k=0;k<t.need;k++){
        dots.push(`<span class="dot ${k < t.have ? "on" : ""}"></span>`);
      }
      return `
        <div class="${cls}">
          <div class="kidIcon" aria-hidden="true">
            <img src="${t.img}" alt="${t.label}">
          </div>
          <div class="kidCount">
            <div class="kidDots">${dots.join("")}</div>
            <div class="tiny" style="font-weight:1000; opacity:.95; color: rgba(255,255,255,.92);">
              ${t.have}/${t.need}
            </div>
          </div>
        </div>
      `;
    }).join("");

    el.kidBlocker.classList.add("show");
    vibrate(40);
  }

  function hideKidBlocker(){
    el.kidBlocker.classList.remove("show");
  }

  // ------------------------------------------------------------
  // Fips Celebration (fullscreen)
  // ------------------------------------------------------------
  function clearConfetti(){
    el.confetti.innerHTML = "";
  }

  function spawnConfettiBurst(){
    clearConfetti();
    const pieces = 56; // heavy but safe
    for(let i=0;i<pieces;i++){
      const d = document.createElement("div");
      d.className = "c";
      const left = Math.random() * 100;
      const delay = Math.random() * 120;
      const dur = 920 + Math.random()*520;
      const w = 8 + Math.random()*8;
      const h = 10 + Math.random()*12;

      d.style.left = left + "%";
      d.style.top = (-20 - Math.random()*120) + "px";
      d.style.width = w + "px";
      d.style.height = h + "px";
      d.style.animationDelay = delay + "ms";
      d.style.animationDuration = dur + "ms";

      // simple palette using opacity variations (no hard-coded color names in JS)
      const r = 200 + Math.floor(Math.random()*55);
      const g = 150 + Math.floor(Math.random()*80);
      const b = 140 + Math.floor(Math.random()*90);
      d.style.background = `rgba(${r},${g},${b},.92)`;

      el.confetti.appendChild(d);
    }
  }

  function showFipsCelebration(text){
    // choose strongest "hands up" available: use excited, fallback happy
    el.fipsGiantImg.src = ASSETS.fips.excited || ASSETS.fips.happy || ASSETS.fips.idle;
    el.celebrateText.textContent = text || "Richtig";

    spawnConfettiBurst();
    el.celebrate.classList.add("show");
    vibrate(70);

    clearTimeout(showFipsCelebration._t);
    showFipsCelebration._t = setTimeout(() => {
      el.celebrate.classList.remove("show");
      clearConfetti();
    }, 980);
  }

  // ------------------------------------------------------------
  // Completion
  // ------------------------------------------------------------
  function markCompleted(i){
    state.completed[i] = true;
    state.scene[i].answered = true;

    if(state.scene[i].perfect){
      state.stars += 1; // Bonus
      pulse(el.pillStars);
      gainXP(35);
      toast(`<b>Perfekt!</b> Bonus erhalten.`);
      setFips("happy", "Perfekt gelesen.");
    }else{
      gainXP(20);
      setFips("happy", "Erledigt. Weiter.");
    }

    state.streak += 1;
    if(i < NODES.length - 1) state.unlocked[i+1] = true;
  }

  function autoAdvance(){
    const i = state.nodeIndex;
    if(i < NODES.length - 1 && state.unlocked[i+1]){
      setTimeout(() => {
        if(state.nodeIndex === i && state.completed[i]){
          state.nodeIndex = i+1;
          saveState();
          renderAll();
        }
      }, 900);
    }
  }

  // ------------------------------------------------------------
  // Scene image loader with fallbacks (fix Boss-Tor load)
  // ------------------------------------------------------------
  async function setSceneImage(nodeKey){
    const candidates = ASSETS.scenes[nodeKey] || [];
    el.sceneFallback.classList.remove("show");
    el.sceneImg.style.display = "block";

    const tryLoad = (src) => new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve({ ok:true, src });
      img.onerror = () => resolve({ ok:false, src });
      img.src = src;
    });

    for(const src of candidates){
      const r = await tryLoad(src);
      if(r.ok){
        el.sceneImg.src = r.src;
        return true;
      }
    }

    // nothing loaded
    el.sceneImg.removeAttribute("src");
    el.sceneImg.style.display = "none";
    el.sceneFallback.classList.add("show");
    toast("<b>Szene-Bild fehlt.</b> Dateiname/Pfad prüfen.", 2600);
    return false;
  }

  // ------------------------------------------------------------
  // Render HUD
  // ------------------------------------------------------------
  function renderHUD(){
    el.starsVal.textContent = state.stars;
    el.applesVal.textContent = state.apples;
    el.lanternsVal.textContent = state.lanterns;
    el.sparksVal.textContent = state.sparks;
    el.streakVal.textContent = state.streak;
    el.levelVal.textContent = state.level;
    el.focusVal.textContent = state.focus;

    el.xpVal.textContent = state.xp;
    el.xpNeed.textContent = state.xpNeed;

    const pct = clamp((state.xp / state.xpNeed) * 100, 0, 100);
    el.xpBar.style.width = pct.toFixed(1) + "%";

    el.hearts.innerHTML = "";
    for(let i=0;i<state.heartsMax;i++){
      const img = document.createElement("img");
      img.src = ASSETS.icons.herz;
      img.alt = "Herz";
      img.className = "heart" + (i < state.hearts ? "" : " off");
      el.hearts.appendChild(img);
    }
  }

  // ------------------------------------------------------------
  // Render Path
  // ------------------------------------------------------------
  function renderPath(){
    el.pathList.innerHTML = "";
    const done = state.completed.filter(Boolean).length;
    el.chapterStatus.textContent = `${done}/5 erledigt`;

    NODES.forEach((n, i) => {
      const unlocked = state.unlocked[i];
      const completed = state.completed[i];

      const btn = document.createElement("div");
      btn.className = "node" + (unlocked ? "" : " locked") + (i===state.nodeIndex ? " active" : "");
      const extra = completed ? "erledigt" : (unlocked ? "bereit" : "gesperrt");
      btn.innerHTML = `
        <div class="left">
          <div class="badge">${i+1}</div>
          <div>
            <div style="font-weight:1000; line-height:1.05;">${n.title}</div>
            <div class="tiny" style="margin-top:2px;">${extra}</div>
          </div>
        </div>
        <div class="tiny">${completed ? "✓" : (unlocked ? "→" : "🔒")}</div>
      `;
      btn.addEventListener("click", () => {
        if(!state.unlocked[i]) return;
        state.nodeIndex = i;
        saveState();
        renderAll();
      });
      el.pathList.appendChild(btn);
    });
  }

  // ------------------------------------------------------------
  // Boss UI
  // ------------------------------------------------------------
  function renderBossUI(node, sceneState){
    if(node.boss){
      el.bossHud.classList.add("show");
      el.bossName.textContent = node.boss.name;
      const hpMax = node.boss.hpMax;
      const hp = clamp(sceneState.bossHP, 0, hpMax);
      el.bossHPText.textContent = hp;
      el.bossBarFill.style.width = ((hp / hpMax) * 100) + "%";
    }else{
      el.bossHud.classList.remove("show");
    }
  }

  // ------------------------------------------------------------
  // Render Scene
  // ------------------------------------------------------------
  async function renderScene(){
    const i = state.nodeIndex;
    const node = NODES[i];
    const s = state.scene[i];

    el.sceneTitle.textContent = node.title;
    el.overlay.innerHTML = "";
    el.gateOpen.classList.remove("show");

    await setSceneImage(node.key);

    renderBossUI(node, s);

    if(node.boss){
      const step = clamp(s.bossStep, 0, node.readBoss.length - 1);
      const pack = node.readBoss[step];
      el.readText.innerHTML = pack.text;
      el.question.textContent = pack.question;
      renderAnswers(pack.answers);
      el.qProgress.textContent = `Bossfrage ${step+1}/3`;
    } else {
      const qi = clamp(s.qIndex, 0, node.readSteps.length - 1);
      const pack = node.readSteps[qi];
      el.readText.innerHTML = pack.text;
      el.question.textContent = pack.question;
      renderAnswers(pack.answers);
      el.qProgress.textContent = `Frage ${qi+1}/3`;
    }

    const m = missingForNode(i);
    el.goalLine.textContent = `Sammelziel: Sterne ${m.have.stars}/${m.goal.stars} · Äpfel ${m.have.apples}/${m.goal.apples} · Laternen ${m.have.lanterns}/${m.goal.lanterns}`;

    el.nextBtn.disabled = !(state.completed[i] && i < NODES.length-1 && state.unlocked[i+1]);

    // Interactables (optionally hint-pulse when blocked)
    const shouldHint = (!node.boss && allQuestionsCorrect(i) && !isGoalMet(i)) || (node.boss && s.bossHP===0 && !isGoalMet(i));

    node.interactables.forEach(it => {
      if(it.once && s.collected[it.id]) return;

      const hs = document.createElement("div");
      hs.className = "hotspot " + (it.size || "") + (shouldHint ? " hint" : "");
      hs.style.left = it.x + "%";
      hs.style.top  = it.y + "%";
      hs.style.setProperty("--w", it.size==="tiny" ? "70px" : "120px");
      hs.title = it.label || "Tippen";

      const img = document.createElement("img");
      img.src = it.img;
      img.alt = it.label || "Tippen";
      hs.appendChild(img);

      hs.addEventListener("click", (e) => {
        e.stopPropagation();
        onInteract(it, hs, e.clientX, e.clientY);
      });

      el.overlay.appendChild(hs);
    });

    // Secret spark
    const sp = node.sparkHotspot;
    if(sp && !s.sparkFound){
      const hs = document.createElement("div");
      hs.className = "hotspot";
      hs.style.left = sp.x + "%";
      hs.style.top  = sp.y + "%";
      hs.style.width = (sp.r*2) + "%";
      hs.style.height = (sp.r*2) + "%";
      hs.style.borderRadius = "999px";
      hs.style.opacity = "0.001";
      hs.addEventListener("click", (e) => {
        e.stopPropagation();
        s.sparkFound = true;
        state.sparks += 1;
        pulse(el.pillSparks);
        gainXP(15);
        toast(`<b>Geheimfunke!</b>`);
        setFips("excited", "Geheimfunke gefunden.");
        saveState();
        renderAll();
      });
      el.overlay.appendChild(hs);
    }
  }

  function renderAnswers(list){
    el.answers.innerHTML = "";
    list.forEach((a, idx) => {
      const div = document.createElement("div");
      div.className = "ans";
      div.innerHTML = `<span>${a.t}</span><span class="tiny">Antwort</span>`;
      div.addEventListener("click", () => onAnswer(idx));
      el.answers.appendChild(div);
    });

    const i = state.nodeIndex;
    const ok = state.completed[i] ? "erledigt" : "offen";
    el.statusLine.innerHTML = `Status: <span class="tiny">${ok}</span>`;
  }

  // ------------------------------------------------------------
  // Interact (Sammeln)
  // ------------------------------------------------------------
  function onInteract(it, hsEl, cx, cy){
    const i = state.nodeIndex;
    const node = NODES[i];
    const s = state.scene[i];

    if(state.completed[i]) return;

    if(it.once) s.collected[it.id] = true;
    burstAtHotspot(hsEl);

    if(it.type === "collect_star"){
      state.stars += (it.points || 1);
      pulse(el.pillStars);
      gainXP(10);
      setFips("happy", "Stern eingesammelt.");
      flyToHUD(cx, cy, ASSETS.icons.stern, el.pillStars);
      toast(`<b>★</b>`);

    } else if(it.type === "collect_apple"){
      state.apples += (it.points || 1);
      pulse(el.pillApples);
      gainXP(8);
      setFips("happy", "Apfel eingesammelt.");
      flyToHUD(cx, cy, ASSETS.interact.Apfel, el.pillApples);
      toast(`<b>🍎</b>`);

    } else if(it.type === "collect_lantern"){
      state.lanterns += (it.points || 1);
      pulse(el.pillLanterns);
      gainXP(8);
      setFips("happy", "Laterne eingesammelt.");
      flyToHUD(cx, cy, ASSETS.interact.Laterne, el.pillLanterns);
      toast(`<b>🕯</b>`);
    }

    // If already all questions correct and now goal met: complete immediately
    if(!node.boss && allQuestionsCorrect(i) && isGoalMet(i) && !state.completed[i]){
      markCompleted(i);
      toast(`<b>Freigeschaltet!</b>`);
      showFipsCelebration("Freigeschaltet");
    }

    // Boss: if boss already down and now goal met, complete and open
    if(node.boss && s.bossHP === 0 && isGoalMet(i) && !state.completed[i]){
      markCompleted(i);
      el.gateOpen.classList.add("show");
      showFipsCelebration("Boss fertig");
      setTimeout(() => {
        el.gateOpen.classList.remove("show");
        openReportAndSplash();
      }, 1200);
    }

    saveState();
    renderAll();
  }

  // ------------------------------------------------------------
  // Answer (XP only once per question, ultra celebration mid-screen)
  // ------------------------------------------------------------
  function onAnswer(idx){
    const i = state.nodeIndex;
    const node = NODES[i];
    const s = state.scene[i];

    if(state.completed[i]) return;

    const cards = [...el.answers.querySelectorAll(".ans")];
    cards.forEach(c => c.classList.remove("correct","wrong"));

    s.tries += 1;

    let answers, chosen;
    let qi = 0;

    if(node.boss){
      qi = clamp(s.bossStep, 0, 2);
      answers = node.readBoss[qi].answers;
      chosen = answers[idx];
    }else{
      qi = clamp(s.qIndex, 0, 2);
      answers = node.readSteps[qi].answers;
      chosen = answers[idx];
    }

    if(chosen && chosen.correct){
      cards[idx].classList.add("correct");

      // Fullscreen Fips animation (center, huge, "power-up")
      showFipsCelebration("Richtig");
      setFips("excited", "Richtig.");
      vibrate(55);

      // If already solved this question, do NOT stack XP or progress
      if(!node.boss && s.correctSteps[qi] === true){
        // If blocked by collecting, show kids blocker (icons)
        if(allQuestionsCorrect(i) && !isGoalMet(i)){
          showKidBlocker(i);
        }
        saveState();
        renderAll();
        return;
      }
      if(node.boss && s.bossXpGrantedSteps[qi] === true){
        if(s.bossHP === 0 && !isGoalMet(i)){
          showKidBlocker(i);
        }
        saveState();
        renderAll();
        return;
      }

      // XP only once per question
      if(node.boss){
        if(!s.bossXpGrantedSteps[qi]){
          s.bossXpGrantedSteps[qi] = true;
          gainXP(18);
        }

        // Boss hit once per question
        s.bossHP = clamp(s.bossHP - 1, 0, node.boss.hpMax);
        renderBossUI(node, s);

        // next boss question
        s.bossStep = clamp(s.bossStep + 1, 0, node.readBoss.length - 1);

        // Boss defeated
        if(s.bossHP === 0){
          el.statusLine.innerHTML = `Status: <span class="good">Boss besiegt.</span>`;

          if(isGoalMet(i)){
            markCompleted(i);
            el.gateOpen.classList.add("show");
            setTimeout(() => {
              el.gateOpen.classList.remove("show");
              openReportAndSplash();
            }, 1200);
          }else{
            // No reading: show kid blocker with icons
            showKidBlocker(i);
          }
        }else{
          el.statusLine.innerHTML = `Status: <span class="good">Richtig.</span> Noch ${s.bossHP} Treffer.`;
        }

      } else {
        // Normal: mark question solved once
        s.correctSteps[qi] = true;

        if(!s.xpGrantedSteps[qi]){
          s.xpGrantedSteps[qi] = true;
          gainXP(16);
        }

        if(qi < 2) s.qIndex = qi + 1;

        if(allQuestionsCorrect(i)){
          if(isGoalMet(i)){
            markCompleted(i);
            el.statusLine.innerHTML = `Status: <span class="good">Erledigt.</span>`;
          }else{
            // no reading: show kid blocker
            showKidBlocker(i);
          }
        }else{
          el.statusLine.innerHTML = `Status: <span class="good">Richtig.</span>`;
        }
      }

      saveState();
      renderAll();

      if(state.completed[i]) autoAdvance();

    } else {
      cards[idx].classList.add("wrong");
      s.perfect = false;
      state.streak = 0;

      loseHeart();

      el.statusLine.innerHTML = `Status: <span class="bad">Falsch.</span>`;
      toast(`<b>Falsch.</b>`);
      setFips("thinking", "Nochmal lesen.");
      saveState();
      renderAll();
    }
  }

  // ------------------------------------------------------------
  // Abschlussbericht + Splash
  // ------------------------------------------------------------
  function openReportAndSplash(){
    const items = [
      ["Sterne", state.stars],
      ["Äpfel", state.apples],
      ["Laternen", state.lanterns],
      ["Funken", state.sparks],
      ["Stufe", state.level],
      ["XP", `${state.xp}/${state.xpNeed}`],
      ["Serie", state.streak],
      ["Herzen", `${state.hearts}/${state.heartsMax}`],
    ];

    el.reportGrid.innerHTML = items.map(([k,v]) => `
      <div class="rep"><div class="k">${k}</div><div class="v">${v}</div></div>
    `).join("");

    el.splash.classList.add("show");
  }

  // ------------------------------------------------------------
  // Buttons
  // ------------------------------------------------------------
  el.reReadBtn.addEventListener("click", () => {
    toast(`<b>Nochmal lesen.</b>`, 2000);
    setFips("thinking", "Lies das Pergament. Dann antworten.");
  });

  el.nextBtn.addEventListener("click", () => {
    const i = state.nodeIndex;
    if(i < NODES.length - 1 && state.unlocked[i+1]){
      state.nodeIndex = i+1;
      saveState();
      renderAll();
    }
  });

  el.resetBtn.addEventListener("click", () => {
    if(!confirm("Wirklich alles zurücksetzen?")) return;
    state = defaultState();
    saveState();
    renderAll();
    toast("<b>Reset.</b> Alles wurde zurückgesetzt.");
    setFips("idle", "Los geht’s. Sammeln, dann lesen.");
  });

  el.helpBtn.addEventListener("click", () => {
    toast(`<b>So geht’s:</b> Tippen im Bild · Lesen · Antworten · Dann weiter.`, 5200);
    setFips("idle", "Tippe im Bild. Dann lies. Dann antworte.");
  });

  el.kidCloseBtn.addEventListener("click", hideKidBlocker);
  el.kidOkBtn.addEventListener("click", hideKidBlocker);
  el.kidBlocker.addEventListener("click", (e) => { if(e.target === el.kidBlocker) hideKidBlocker(); });

  el.closeSplashBtn.addEventListener("click", () => {
    el.splash.classList.remove("show");
  });

  window.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if(k === "h") el.helpBtn.click();
    if(k === "r") el.resetBtn.click();
    if(k === "escape") hideKidBlocker();
  });

  // ------------------------------------------------------------
  // Render All
  // ------------------------------------------------------------
  async function renderAll(){
    renderHUD();
    renderPath();
    await renderScene();

    const i = state.nodeIndex;
    el.nextBtn.disabled = !(state.completed[i] && i < NODES.length-1 && state.unlocked[i+1]);
  }

  // Initial
  setFips("idle", "Sammle Sterne, Äpfel, Laternen. Dann lies das Pergament.");
  renderAll().then(saveState);
})();
</script>
</body>
</html>

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Leselabyrinth – Funkelwald (MVP)</title>

  <style>
    :root{
      --bg0:#070a14;
      --bg1:#0b1030;
      --bg2:#171a3a;

      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);

      --text:#eaf0ff;
      --muted:#b9c2e8;

      --good:#45d483;
      --bad:#ff6b6b;

      --gold:#ffd36a;
      --blue:#6fd0ff;
      --pink:#ff4fa3;

      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --radius: 22px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;

      /* Pergament-Bar Höhe: ca. 1/4 Screen */
      --parchH: clamp(170px, 24vh, 260px);

      /* Safe Area */
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(255,79,163,.18), transparent 60%),
        radial-gradient(900px 600px at 70% 20%, rgba(111,208,255,.14), transparent 60%),
        radial-gradient(900px 700px at 50% 80%, rgba(255,211,106,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 40%, var(--bg2));
      overflow:hidden;
    }

    /* Top HUD */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 200;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(8,10,24,.82), rgba(8,10,24,.38));
      border-bottom: 1px solid var(--stroke);
      padding: 12px 14px;
    }
    .topbar-inner{
      max-width: 1480px;
      margin:0 auto;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 280px;
    }
    .brand .dot{
      width: 10px; height: 10px; border-radius: 50%;
      background: linear-gradient(135deg, var(--pink), var(--gold));
      box-shadow: 0 0 18px rgba(255,79,163,.45);
    }
    .brand .title{
      font-weight: 1000;
      letter-spacing: .2px;
      line-height: 1.1;
      font-size: 16px;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      opacity: .95;
      margin-top: 2px;
    }

    .hud{
      display:flex;
      gap: 10px;
      align-items:center;
      flex: 1;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .pill{
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      white-space: nowrap;
      position: relative;
      overflow:hidden;
      transform-origin:center;
    }
    .pill b{ font-weight: 1000; }
    .icon{
      width: 30px; height: 30px; object-fit: contain;
      filter: drop-shadow(0 0 14px rgba(255,255,255,.12));
      transform-origin:center;
    }

    .hearts{ display:flex; gap:7px; align-items:center; }
    .hearts .heart{
      width: 30px; height: 30px; opacity: .98;
      filter: drop-shadow(0 0 14px rgba(255,79,163,.26));
      transform-origin:center;
    }
    .hearts .heart.off{ opacity: .20; filter:none; }

    .sep{ opacity:.25; }
    .tiny{ font-size: 12px; color: var(--muted); opacity:.95; }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.07);
      color: var(--text);
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 1000;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.11); border-color: var(--stroke2); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,79,163,.92), rgba(255,211,106,.88));
      border-color: rgba(255,255,255,.18);
      color: #1a1022;
      box-shadow: 0 14px 35px rgba(255,79,163,.18);
    }

    .xp{
      min-width: 340px;
      max-width: 560px;
      flex: 1;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      position:relative;
      overflow:hidden;
    }
    .xp small{ color: var(--muted); font-weight:1000; }
    .xpbar{
      flex: 1;
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .xpbar > div{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(111,208,255,.92), rgba(255,211,106,.95));
      box-shadow: 0 0 18px rgba(111,208,255,.25);
      transition: width .35s ease;
    }

    /* ============================================================
       NEW LAYOUT: FULL SCENE + BOTTOM PARCHMENT BAR
       ============================================================ */
    .stageWrap{
      max-width: 1480px;
      margin: 0 auto;
      padding: 14px 14px 18px;
    }

    .sceneWrap{
      position: relative;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      box-shadow: var(--shadow);
      height: calc(100vh - 92px - 18px); /* topbar approx + padding */
      min-height: 640px;
    }
    @media (max-width: 920px){
      .sceneWrap{ min-height: 620px; height: calc(100vh - 122px - 18px); }
    }

    .sceneImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
      transform: scale(1.01);
    }

    .sceneFallback{
      position:absolute;
      inset:0;
      display:none;
      place-items:center;
      background:
        radial-gradient(900px 450px at 50% 25%, rgba(255,211,106,.10), transparent 60%),
        radial-gradient(700px 380px at 30% 80%, rgba(111,208,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(10,12,28,.78), rgba(10,12,28,.92));
      color: rgba(255,255,255,.92);
      text-align:center;
      padding: 18px;
      z-index: 5;
    }
    .sceneFallback.show{ display:grid; }
    .sceneFallback .box{
      width:min(720px, 92%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding: 16px;
    }
    .sceneFallback h3{ margin:0; font-size:18px; font-weight:1000; }
    .sceneFallback p{ margin:10px 0 0; color: var(--muted); line-height:1.35; font-weight:800; }

    /* Overlay layer for items */
    .overlay{ position:absolute; inset:0; z-index: 10; }

    /* Hotspots */
    .hotspot{
      position:absolute;
      transform: translate(-50%, -50%);
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
      z-index: 12;
    }
    .hotspot:hover{ transform: translate(-50%,-50%) scale(1.05); filter: drop-shadow(0 0 22px rgba(255,211,106,.28)); }
    .hotspot:active{ transform: translate(-50%,-50%) scale(.99); }
    .hotspot img{
      width: var(--w, 120px);
      height: auto;
      display:block;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
      pointer-events:none;
    }
    .hotspot.small img{ width: var(--w, 120px); }
    .hotspot.tiny img{ width: var(--w, 70px); }

    /* Boss HUD */
    .bossHud{
      position:absolute;
      left: 50%;
      top: 14px;
      transform: translateX(-50%);
      z-index: 40;
      display:none;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .bossHud.show{ display:flex; }
    .bossName{ font-weight:1000; }
    .bossBar{
      width: 280px;
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
      position:relative;
    }
    .bossBar > div{
      height:100%;
      width: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,107,107,.92), rgba(255,211,106,.95));
      box-shadow: 0 0 18px rgba(255,107,107,.22);
      transition: width .22s ease;
    }
    .bossHitFlash{
      position:absolute;
      inset:-12px;
      background: radial-gradient(circle at 50% 50%, rgba(255,107,107,.42), transparent 60%);
      opacity:0;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    .bossHud.hit .bossHitFlash{ animation: bossFlash .32s ease forwards; }
    @keyframes bossFlash{
      0%{ opacity:0; transform: scale(.9); }
      40%{ opacity:1; transform: scale(1.05); }
      100%{ opacity:0; transform: scale(1.2); }
    }
    .bossShake{ animation: bossShake .25s ease; }
    @keyframes bossShake{
      0%{ transform: translateX(-50%) translateY(0); }
      25%{ transform: translateX(-50%) translateY(0) translateX(-6px); }
      50%{ transform: translateX(-50%) translateY(0) translateX(6px); }
      75%{ transform: translateX(-50%) translateY(0) translateX(-3px); }
      100%{ transform: translateX(-50%) translateY(0) translateX(0); }
    }

    /* Floating damage number */
    .dmg{
      position:absolute;
      left:50%;
      top: 72px;
      transform: translateX(-50%);
      z-index: 60;
      font-weight:1000;
      font-size: 22px;
      color: rgba(255,107,107,.95);
      text-shadow: 0 10px 24px rgba(0,0,0,.6);
      pointer-events:none;
      opacity:0;
    }
    .dmg.show{ animation: dmgFloat .55s ease forwards; }
    @keyframes dmgFloat{
      0%{ opacity:0; transform: translateX(-50%) translateY(10px) scale(.95); }
      20%{ opacity:1; transform: translateX(-50%) translateY(0) scale(1.05); }
      100%{ opacity:0; transform: translateX(-50%) translateY(-26px) scale(.9); }
    }

    /* Fips MAIN (oben über Pergament) */
    .fipsMain{
      position:absolute;
      left: 16px;
      bottom: calc(var(--parchH) + 10px);
      z-index: 30;
      display:flex;
      align-items:flex-end;
      gap: 14px;
      pointer-events:none;
    }
    @media (max-width: 720px){
      .fipsMain{ left: 10px; bottom: calc(var(--parchH) + 8px); gap: 10px; }
    }
    .fipsMain .frame{
      width: 190px;
      height: 190px;
      border-radius: 30px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      overflow:hidden;
      display:grid;
      place-items:center;
      position: relative;
    }
    @media (max-width: 720px){
      .fipsMain .frame{ width: 150px; height: 150px; border-radius: 26px; }
    }
    .fipsMain .frame img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      transform-origin:center;
    }
    .fipsMain .bubble{
      max-width: 520px;
      border-radius: 18px;
      background: rgba(8,10,24,.60);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      padding: 10px 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .fipsMain .bubble b{ font-weight:1000; }
    .fipsMain .bubble .line{ color: var(--muted); margin-top:4px; font-size: 13px; line-height:1.35; }

    /* ============================================================
       Bottom Pergament Bar (PNG)
       ============================================================ */
    .pergBar{
      position:absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: calc(var(--parchH) + var(--safeB));
      z-index: 90;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: 10px 14px calc(12px + var(--safeB));
      pointer-events:none; /* Hintergrund blockt nichts */
    }
    .pergInner{
      width: min(1320px, 98%);
      height: 100%;
      position: relative;
      pointer-events:auto; /* Inhalte klickbar */
    }
    .pergBG{
      position:absolute;
      inset: 0;
      background: url("assets/ui/panels/parchment.png") no-repeat center bottom;
      background-size: contain;
      filter: drop-shadow(0 24px 50px rgba(0,0,0,.55));
      pointer-events:none;
    }

    .pergContent{
      position: relative;
      height: 100%;
      padding: 18px 26px 18px;
      display:flex;
      gap: 16px;
      align-items:stretch;
    }
    @media (max-width: 920px){
      .pergContent{ padding: 14px 18px 14px; gap: 12px; }
    }

    .pergCol{
      flex: 1;
      min-width: 0;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    .pergTopLine{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .pergTopLine .sceneMeta{
      font-size: 12px;
      color: rgba(20,12,6,.78);
      font-weight: 1000;
      letter-spacing: .2px;
      text-shadow: 0 1px 0 rgba(255,255,255,.22);
      opacity: .95;
    }
    .pergTopLine .qMeta{
      text-align:right;
      font-size: 12px;
      color: rgba(20,12,6,.68);
      font-weight: 1000;
    }

    .readText{
      font-size: 18px;
      line-height: 1.35;
      font-weight: 1000;
      color: rgba(18,10,6,.92);
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
      padding-right: 10px;
      max-height: 4.1em;
      overflow:hidden;
    }
    @media (max-width: 920px){
      .readText{ font-size: 16px; max-height: 3.9em; }
    }

    .questionLine{
      font-size: 16px;
      font-weight: 1000;
      color: rgba(18,10,6,.92);
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
      margin-top: 8px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .answersRow{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(160px, 1fr));
      gap: 10px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .answersRow{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
    }
    @media (max-width: 560px){
      .answersRow{ grid-template-columns: 1fr; }
    }

    .ans{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.28);
      cursor:pointer;
      user-select:none;
      font-weight: 1000;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      position:relative;
      overflow:hidden;
      color: rgba(20,12,6,.92);
      text-shadow: 0 1px 0 rgba(255,255,255,.22);
    }
    .ans:hover{ border-color: rgba(0,0,0,.18); background: rgba(255,255,255,.36); }
    .ans:active{ transform: translateY(1px); }
    .ans.correct{ border-color: rgba(69,212,131,.55); background: rgba(69,212,131,.18); }
    .ans.wrong{ border-color: rgba(255,107,107,.55); background: rgba(255,107,107,.18); }

    .pergFoot{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .statusline{
      font-size: 13px;
      color: rgba(20,12,6,.72);
      font-weight: 1000;
      text-shadow: 0 1px 0 rgba(255,255,255,.20);
    }
    .statusline .good{ color: #0f6a3d; }
    .statusline .bad{ color: #8d2020; }

    .btnSmall{
      appearance:none;
      border: 1px solid rgba(0,0,0,.16);
      background: rgba(255,255,255,.26);
      color: rgba(20,12,6,.92);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 1000;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      text-shadow: 0 1px 0 rgba(255,255,255,.22);
    }
    .btnSmall:hover{ background: rgba(255,255,255,.34); border-color: rgba(0,0,0,.20); }
    .btnSmall:active{ transform: translateY(1px); }
    .btnSmall[disabled]{ opacity:.45; cursor:not-allowed; }

    /* ============================================================
       Drawer: Kapitel/Guide (minimiert)
       ============================================================ */
    .fabRow{
      position:absolute;
      right: 14px;
      top: 14px;
      z-index: 95;
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .fab{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.55);
      backdrop-filter: blur(10px);
      color: var(--text);
      padding: 10px 12px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
    }
    .fab:hover{ background: rgba(8,10,24,.68); border-color: rgba(255,255,255,.20); }
    .fab:active{ transform: translateY(1px); }

    .drawer{
      position:absolute;
      right: 14px;
      top: 58px;
      width: min(420px, 94%);
      max-height: min(70vh, 620px);
      z-index: 110;
      display:none;
      overflow:hidden;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.70);
      backdrop-filter: blur(10px);
      box-shadow: 0 28px 90px rgba(0,0,0,.65);
    }
    .drawer.show{ display:block; animation: pop .18s ease; }
    @keyframes pop{ from{ transform: translateY(6px); opacity:.0;} to{ transform: translateY(0); opacity:1;} }

    .drawerHd{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .drawerHd h3{
      margin:0;
      font-size: 14px;
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .drawerBd{
      padding: 12px 14px 14px;
      overflow:auto;
      max-height: calc(min(70vh, 620px) - 54px);
    }

    .mini{ display:flex; gap: 12px; align-items:flex-start; }
    .avatar{
      width: 64px; height: 64px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .avatar img{ width: 100%; height: 100%; object-fit: contain; }
    .speech{
      flex:1;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 10px 12px;
      min-height: 64px;
    }
    .speech .name{ font-weight: 1000; }
    .speech .line{ margin-top: 4px; color: var(--muted); font-size: 13px; line-height:1.35; }

    .pathlist{ display:flex; flex-direction:column; gap: 10px; margin-top: 12px; }
    .node{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
    }
    .node:hover{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .node.locked{ opacity:.5; cursor:not-allowed; }
    .node.active{ outline: 2px solid rgba(111,208,255,.35); }
    .node .left{ display:flex; gap:10px; align-items:center; }
    .badge{
      width: 30px; height: 30px;
      border-radius: 11px;
      display:grid; place-items:center;
      font-weight: 1000;
      background: rgba(111,208,255,.12);
      border: 1px solid rgba(111,208,255,.20);
    }

    /* Toast */
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 210;
      max-width: 460px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(10,12,28,.92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
      display:none;
    }
    .toast.show{ display:block; animation: pop .18s ease; }
    .toast b{ font-weight: 1000; }

    /* Pickup animation */
    .fly{
      position: fixed;
      z-index: 220;
      width: 46px; height: 46px;
      pointer-events:none;
      filter: drop-shadow(0 0 18px rgba(255,211,106,.35));
      transform: translate(-50%, -50%) scale(1);
    }
    .sparkBurst{
      position: absolute;
      inset: -26px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255,211,106,.35), transparent 60%);
      animation: burst .45s ease-out forwards;
      pointer-events:none;
    }
    @keyframes burst{
      from{ opacity:.0; transform: scale(.6); }
      35%{ opacity:1; transform: scale(1.05); }
      to{ opacity:0; transform: scale(1.35); }
    }

    /* HUD pulse */
    .pulse{ animation: hudPulse .35s ease; }
    @keyframes hudPulse{
      0%{ transform: scale(1); }
      45%{ transform: scale(1.06); }
      100%{ transform: scale(1); }
    }
    .wiggle{ animation: wiggle .45s ease; }
    @keyframes wiggle{
      0%{ transform: rotate(0deg) scale(1); }
      30%{ transform: rotate(-6deg) scale(1.06); }
      60%{ transform: rotate(6deg) scale(1.06); }
      100%{ transform: rotate(0deg) scale(1); }
    }

    /* Gate overlay */
    .gateOpen{
      position:absolute;
      inset:0;
      z-index: 120;
      display:none;
      place-items:center;
      background: radial-gradient(900px 500px at 50% 40%, rgba(255,211,106,.18), rgba(0,0,0,.55));
      backdrop-filter: blur(2px);
      pointer-events:none;
    }
    .gateOpen.show{ display:grid; animation: fadeIn .35s ease; }
    @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }
    .gateOpen .card{
      width:min(560px, 92%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.72);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding: 16px 16px;
      text-align:center;
    }
    .gateOpen .card h3{ margin:0; font-size: 18px; font-weight:1000; }
    .gateOpen .card p{ margin:10px 0 0; color: var(--muted); line-height:1.35; }

    /* ============================================================
       POSITIVE CELEBRATION FULLSCREEN (unchanged)
       ============================================================ */
    .celebrate{
      position: fixed;
      inset: 0;
      z-index: 260;
      display:none;
      place-items:center;
      pointer-events:none;
      background:
        radial-gradient(900px 520px at 50% 35%, rgba(255,211,106,.22), transparent 60%),
        radial-gradient(900px 520px at 50% 80%, rgba(255,79,163,.14), transparent 60%),
        radial-gradient(900px 520px at 15% 55%, rgba(111,208,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(5,8,18,.55), rgba(5,8,18,.80));
      backdrop-filter: blur(6px);
    }
    .celebrate.show{ display:grid; animation: fadeIn .14s ease; }

    .celebrate .stage{
      width:min(1100px, 96%);
      height: min(78vh, 680px);
      position:relative;
      border-radius: 34px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.16);
      box-shadow: 0 40px 120px rgba(0,0,0,.70);
    }

    .rays{
      position:absolute;
      inset:-40%;
      background:
        conic-gradient(from 90deg,
          rgba(255,211,106,.0),
          rgba(255,211,106,.22),
          rgba(255,211,106,.0),
          rgba(111,208,255,.20),
          rgba(255,79,163,.18),
          rgba(255,211,106,.0));
      filter: blur(2px);
      opacity:.85;
      animation: spin 2.6s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .bigStarBack{
      position:absolute;
      left:50%;
      top:52%;
      width: min(72vh, 620px);
      height: min(72vh, 620px);
      transform: translate(-50%,-50%);
      filter: drop-shadow(0 30px 80px rgba(0,0,0,.55));
      animation: starPulse 1.05s ease-in-out infinite;
      opacity:.95;
    }
    @keyframes starPulse{
      0%,100%{ transform: translate(-50%,-50%) scale(1.00) rotate(0deg); }
      50%{ transform: translate(-50%,-50%) scale(1.03) rotate(2deg); }
    }
    .bigStarBack svg{ width:100%; height:100%; }

    .fipsGiant{
      position:absolute;
      left:50%;
      top:54%;
      transform: translate(-50%,-50%);
      width: min(66vh, 560px);
      height: min(66vh, 560px);
      display:grid;
      place-items:center;
      filter: drop-shadow(0 40px 90px rgba(0,0,0,.55));
    }
    .fipsGiant img{
      width:100%;
      height:100%;
      object-fit: contain;
      transform-origin:center;
      animation: fipsPower 0.92s ease-out forwards;
    }
    @keyframes fipsPower{
      0%{ transform: scale(.55) translateY(40px) rotate(-6deg); opacity:0; }
      30%{ transform: scale(1.06) translateY(-8px) rotate(4deg); opacity:1; }
      60%{ transform: scale(.98) translateY(2px) rotate(0deg); }
      100%{ transform: scale(1.00) translateY(0) rotate(0deg); }
    }

    .shine{
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at 50% 45%, rgba(255,255,255,.62), transparent 55%);
      opacity:.0;
      animation: flash 0.92s ease-out forwards;
    }
    @keyframes flash{
      0%{ opacity:0; transform: scale(.8); }
      30%{ opacity:1; transform: scale(1.05); }
      100%{ opacity:0; transform: scale(1.25); }
    }

    .confetti{
      position:absolute;
      inset:0;
      overflow:hidden;
      pointer-events:none;
    }
    .c{
      position:absolute;
      width: 10px; height: 14px;
      border-radius: 4px;
      background: rgba(255,255,255,.85);
      opacity:.92;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
      animation: fall 1.15s ease-in forwards;
    }
    @keyframes fall{
      0%{ transform: translateY(-60px) rotate(0deg); opacity:0; }
      10%{ opacity:1; }
      100%{ transform: translateY(820px) rotate(240deg); opacity:0; }
    }

    .celebrateBadge{
      position:absolute;
      left: 18px;
      top: 18px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.65);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      font-weight: 1000;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap: 10px;
      animation: badgePop .35s ease;
    }
    @keyframes badgePop{
      from{ transform: translateY(-6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .celebrateBadge .miniStar{
      width: 24px; height: 24px;
      display:grid; place-items:center;
      border-radius: 10px;
      background: rgba(255,211,106,.16);
      border: 1px solid rgba(255,211,106,.25);
    }

    /* ============================================================
       NEW: NEGATIVE FEEDBACK FULLSCREEN (no black star)
       ============================================================ */
    .oops{
      position: fixed;
      inset: 0;
      z-index: 255;
      display:none;
      place-items:center;
      pointer-events:none;
      background:
        radial-gradient(900px 520px at 50% 30%, rgba(255,107,107,.18), transparent 60%),
        radial-gradient(900px 520px at 15% 70%, rgba(111,208,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(5,8,18,.60), rgba(5,8,18,.88));
      backdrop-filter: blur(6px);
    }
    .oops.show{ display:grid; animation: fadeIn .14s ease; }

    .oops .stage{
      width:min(980px, 96%);
      height: min(72vh, 620px);
      position:relative;
      border-radius: 34px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.16);
      box-shadow: 0 40px 120px rgba(0,0,0,.70);
    }

    .oopsCloud{
      position:absolute;
      left:50%;
      top:50%;
      width: min(74vh, 640px);
      height: min(42vh, 360px);
      transform: translate(-50%,-52%);
      filter: drop-shadow(0 26px 70px rgba(0,0,0,.55));
      opacity:.95;
      animation: cloudPulse 1.1s ease-in-out infinite;
    }
    @keyframes cloudPulse{
      0%,100%{ transform: translate(-50%,-52%) scale(1.00); }
      50%{ transform: translate(-50%,-52%) scale(1.02); }
    }

    .oopsBadge{
      position:absolute;
      left: 18px;
      top: 18px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.65);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      font-weight: 1000;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap: 10px;
      animation: badgePop .35s ease;
    }
    .oopsBadge .miniMark{
      width: 24px; height: 24px;
      display:grid; place-items:center;
      border-radius: 10px;
      background: rgba(255,107,107,.16);
      border: 1px solid rgba(255,107,107,.28);
    }

    .oopsFips{
      position:absolute;
      left:50%;
      top:55%;
      transform: translate(-50%,-50%);
      width: min(58vh, 520px);
      height: min(58vh, 520px);
      display:grid;
      place-items:center;
      filter: drop-shadow(0 40px 90px rgba(0,0,0,.55));
    }
    .oopsFips img{
      width:100%;
      height:100%;
      object-fit: contain;
      transform-origin:center;
      animation: fipsOops .8s ease-out forwards;
    }
    @keyframes fipsOops{
      0%{ transform: scale(.70) translateY(20px); opacity:0; }
      35%{ transform: scale(1.02) translateY(-6px); opacity:1; }
      100%{ transform: scale(1.00) translateY(0); opacity:1; }
    }

    /* BONUS SUMMARY (unchanged) */
    .bonus{
      position: fixed;
      inset: 0;
      z-index: 240;
      display:none;
      place-items:center;
      background:
        radial-gradient(900px 500px at 50% 25%, rgba(255,211,106,.18), transparent 60%),
        radial-gradient(900px 520px at 50% 80%, rgba(111,208,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(5,8,18,.70), rgba(5,8,18,.92));
      backdrop-filter: blur(8px);
    }
    .bonus.show{ display:grid; animation: fadeIn .25s ease; }

    .bonus .card{
      width:min(980px, 94%);
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.78);
      box-shadow: 0 30px 90px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .bonus .top{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .bonus .top h3{
      margin:0;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .bonus .body{
      padding: 14px 16px 16px;
    }
    .bonusGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(160px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 820px){
      .bonusGrid{ grid-template-columns: 1fr; }
    }
    .bonusTile{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      position:relative;
      overflow:hidden;
    }
    .bonusIcon{
      width: 64px; height: 64px;
      border-radius: 22px;
      display:grid; place-items:center;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .bonusIcon img{ width: 54px; height: 54px; object-fit: contain; filter: drop-shadow(0 8px 14px rgba(0,0,0,.35)); }
    .bonusIcon::after{
      content:"";
      position:absolute;
      inset:-30px;
      background: radial-gradient(circle, rgba(255,211,106,.22), transparent 60%);
      opacity:.55;
      animation: bonusGlow 1.25s ease-in-out infinite;
    }
    @keyframes bonusGlow{
      0%,100%{ transform: scale(.95); opacity:.35; }
      50%{ transform: scale(1.05); opacity:1; }
    }
    .bonusCount{
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:flex-end;
      min-width: 88px;
      font-weight:1000;
    }

    /* Water world splash (unchanged) */
    .splash{
      position: fixed;
      inset: 0;
      z-index: 250;
      display:none;
      place-items:center;
      background:
        radial-gradient(900px 500px at 50% 25%, rgba(111,208,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(5,8,18,.75), rgba(5,8,18,.92));
      backdrop-filter: blur(6px);
    }
    .splash.show{ display:grid; animation: fadeIn .35s ease; }
    .splash .box{
      width:min(920px, 94%);
      border-radius: 24px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,24,.68);
      box-shadow: 0 30px 80px rgba(0,0,0,.60);
    }
    .splash img{
      width:100%;
      height: 320px;
      object-fit: cover;
      display:block;
    }
    .splash .content{
      padding: 14px 16px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .splash h3{ margin:0; font-size: 18px; font-weight:1000; }
    .splash p{ margin:6px 0 0; color: var(--muted); line-height:1.35; }

    .reportGrid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(140px, 1fr));
      gap: 10px;
    }
    @media (max-width: 820px){
      .reportGrid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
    }
    .rep{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .rep .k{ color: var(--muted); font-weight: 1000; font-size: 12px; }
    .rep .v{ font-weight: 1000; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Leselabyrinth – Funkelwald</div>
          <div class="sub">Kinder-RPG Lesetraining · Szene-Pfad · Progression · Bonus-Sammeln</div>
        </div>
      </div>

      <div class="hud">
        <div class="pill" id="pillHearts" title="Leben (3 Herzen)">
          <span class="tiny"><b>Leben</b></span>
          <div class="hearts" id="hearts"></div>
        </div>

        <div class="pill" id="pillStars" title="Sterne (Bonus)">
          <img class="icon" src="assets/ui/icons/stern.png" alt="Stern" />
          <span><b id="starsVal">0</b></span>
          <span class="sep">|</span>
          <span class="tiny">Sterne</span>
        </div>

        <div class="pill" id="pillApples" title="Äpfel (Bonus)">
          <img class="icon" src="assets/ui/interactables/Apfel.png" alt="Apfel" />
          <span><b id="applesVal">0</b></span>
          <span class="sep">|</span>
          <span class="tiny">Äpfel</span>
        </div>

        <div class="pill" id="pillLanterns" title="Laternen (Bonus)">
          <img class="icon" src="assets/ui/interactables/Laterne.png" alt="Laterne" />
          <span><b id="lanternsVal">0</b></span>
          <span class="sep">|</span>
          <span class="tiny">Laternen</span>
        </div>

        <div class="pill" id="pillSparks" title="Geheimfunken (Bonus)">
          <img class="icon" src="assets/ui/icons/geheimfunke.png" alt="Geheimfunke" />
          <span><b id="sparksVal">0</b></span>
          <span class="sep">|</span>
          <span class="tiny">Funken</span>
        </div>

        <div class="pill" title="Serie, Stufe, Fokus">
          <span class="tiny">Serie</span> <b id="streakVal">0</b>
          <span class="sep">|</span>
          <span class="tiny">Stufe</span> <b id="levelVal">1</b>
          <span class="sep">|</span>
          <span class="tiny">Fokus</span> <b id="focusVal">W-Frage</b>
        </div>

        <div class="xp" id="pillXP" title="XP Fortschritt">
          <small><b>XP</b> <span id="xpVal">0</span>/<span id="xpNeed">100</span></small>
          <div class="xpbar"><div id="xpBar"></div></div>
        </div>

        <button class="btn" id="resetBtn">Reset</button>
        <button class="btn primary" id="helpBtn">Hilfe</button>
      </div>
    </div>
  </div>

  <div class="stageWrap">
    <div class="sceneWrap" id="sceneWrap">
      <img id="sceneImg" class="sceneImg" src="" alt="Szene" />

      <div class="sceneFallback" id="sceneFallback">
        <div class="box">
          <h3>Szene-Bild fehlt</h3>
          <p>Das Bild wurde nicht gefunden. Pfad prüfen: assets/scenes/…</p>
        </div>
      </div>

      <div class="overlay" id="overlay"></div>

      <!-- Floating Buttons -->
      <div class="fabRow">
        <button class="fab" id="drawerBtn">Kapitel</button>
      </div>

      <!-- Drawer (Kapitel + Guide) -->
      <div class="drawer" id="drawer">
        <div class="drawerHd">
          <h3>Kapitel: Funkelwald</h3>
          <button class="btn" id="drawerCloseBtn" style="padding:10px 12px;">Schließen</button>
        </div>
        <div class="drawerBd">
          <div class="mini">
            <div class="avatar"><img id="fipsAvatar" src="assets/chars/fips/idle.png" alt="Fips" /></div>
            <div class="speech">
              <div class="name">Fips</div>
              <div class="line" id="fipsLine">Bonus: Sammeln. Hauptziel: Fragen richtig beantworten.</div>
            </div>
          </div>

          <div class="tiny" style="margin-top:10px; font-weight:1000; opacity:.95;">
            Status: <span id="chapterStatus">0/5 erledigt</span>
          </div>

          <div class="pathlist" id="pathList"></div>
          <div class="tiny" id="unlockHint" style="margin-top:10px;">Freischaltung: Fragen richtig beantworten.</div>
        </div>
      </div>

      <!-- Boss HUD -->
      <div class="bossHud" id="bossHud">
        <span class="bossName" id="bossName">Boss</span>
        <div class="bossBar">
          <div id="bossBarFill"></div>
          <div class="bossHitFlash"></div>
        </div>
        <span class="tiny"><b id="bossHPText">9</b>/9</span>
      </div>
      <div class="dmg" id="dmg">-1</div>

      <!-- Fips MAIN -->
      <div class="fipsMain">
        <div class="frame">
          <img id="fipsMainImg" src="assets/chars/fips/idle.png" alt="Fips" />
        </div>
        <div class="bubble">
          <b>Fips</b>
          <div class="line" id="fipsMainLine">Lies das Pergament. Beantworte Fragen. Sammeln ist Bonus.</div>
        </div>
      </div>

      <!-- Gate open -->
      <div class="gateOpen" id="gateOpen">
        <div class="card">
          <h3>Das Tor öffnet sich</h3>
          <p>Boss besiegt. Als Nächstes geht es in die Wasserwelt.</p>
        </div>
      </div>

      <!-- Bottom Pergament Bar -->
      <div class="pergBar" id="pergBar">
        <div class="pergInner">
          <div class="pergBG" aria-hidden="true"></div>

          <div class="pergContent">
            <div class="pergCol">
              <div class="pergTopLine">
                <div class="sceneMeta"><b>Szene</b> <span id="sceneTitle">–</span></div>
                <div class="qMeta">
                  <div id="qProgress">Frage 1/3</div>
                  <div style="opacity:.9;">Erst lesen, dann antworten.</div>
                </div>
              </div>

              <div class="readText" id="readText">–</div>
              <div class="questionLine" id="question">–</div>

              <div class="answersRow" id="answers"></div>

              <div class="pergFoot">
                <div class="statusline" id="statusLine">Status: <span class="tiny">offen</span></div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btnSmall" id="reReadBtn">Nochmal lesen</button>
                  <button class="btnSmall" id="nextBtn" disabled>Nächste Szene</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- FIPS CELEBRATION FULLSCREEN (positive, unchanged) -->
  <div class="celebrate" id="celebrate">
    <div class="stage">
      <div class="rays"></div>
      <div class="shine"></div>

      <div class="bigStarBack" aria-hidden="true">
        <svg viewBox="0 0 200 200">
          <defs>
            <linearGradient id="gStar2" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#ffe9a8"/>
              <stop offset="0.55" stop-color="#ffd36a"/>
              <stop offset="1" stop-color="#ff8ec6"/>
            </linearGradient>
          </defs>
          <path fill="url(#gStar2)" stroke="rgba(255,255,255,.65)" stroke-width="4"
            d="M100 14
               L123 68
               L184 74
               L138 113
               L152 170
               L100 138
               L48 170
               L62 113
               L16 74
               L77 68
               Z" />
        </svg>
      </div>

      <div class="celebrateBadge" id="celebrateBadge">
        <div class="miniStar" aria-hidden="true">★</div>
        <div id="celebrateText">Richtig</div>
      </div>

      <div class="fipsGiant">
        <img id="fipsGiantImg" src="assets/chars/fips/excited.png" alt="Fips" />
      </div>

      <div class="confetti" id="confetti"></div>
    </div>
  </div>

  <!-- NEW: Negative Feedback -->
  <div class="oops" id="oops">
    <div class="stage">
      <div class="oopsBadge">
        <div class="miniMark" aria-hidden="true">!</div>
        <div id="oopsText">Nicht richtig</div>
      </div>

      <div class="oopsCloud" aria-hidden="true">
        <svg viewBox="0 0 900 500" width="100%" height="100%">
          <defs>
            <linearGradient id="gCloud" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="rgba(230,240,255,.95)"/>
              <stop offset="0.55" stop-color="rgba(200,220,255,.92)"/>
              <stop offset="1" stop-color="rgba(255,200,200,.88)"/>
            </linearGradient>
          </defs>
          <path fill="url(#gCloud)" stroke="rgba(255,255,255,.55)" stroke-width="10"
            d="M180 320
               C90 320, 60 260, 90 210
               C40 170, 70 110, 140 120
               C160 60, 250 50, 290 95
               C330 40, 430 40, 470 95
               C520 65, 600 85, 610 150
               C690 135, 760 190, 720 265
               C760 310, 720 370, 640 355
               C600 410, 520 430, 470 395
               C430 450, 320 450, 290 395
               C250 430, 170 410, 180 320 Z"/>
        </svg>
      </div>

      <div class="oopsFips">
        <img id="oopsFipsImg" src="assets/chars/fips/sad.png" alt="Fips traurig" />
      </div>
    </div>
  </div>

  <!-- BONUS SUMMARY (optional collecting) -->
  <div class="bonus" id="bonus">
    <div class="card">
      <div class="top">
        <h3>Bonus</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="bonusCloseBtn">Schließen</button>
          <button class="btn primary" id="bonusOkBtn">Ok</button>
        </div>
      </div>
      <div class="body">
        <div class="tiny" style="font-weight:1000; opacity:.95;">Das ist Bonus. Sammeln ist keine Pflicht.</div>
        <div class="bonusGrid" id="bonusGrid"></div>
      </div>
    </div>
  </div>

  <!-- Water world splash -->
  <div class="splash" id="splash">
    <div class="box">
      <img src="assets/scenes/wasserwelt.png" alt="Wasserwelt" />
      <div class="content">
        <div>
          <h3>Kapitel 2: Wasserwelt</h3>
          <p>Funkelwald ist geschafft. Als Nächstes wartet die Wasserwelt.</p>
          <div class="reportGrid" id="reportGrid"></div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="closeSplashBtn">Schließen</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ------------------------------------------------------------
  // Assets
  // ------------------------------------------------------------
  const ASSETS = {
    scenes: {
      waldweg:     ["assets/scenes/waldweg.png","assets/scenes/waldweg.jpg","assets/scenes/Waldweg.png"],
      holzbruecke: ["assets/scenes/holzbruecke.png","assets/scenes/holzbruecke.jpg","assets/scenes/Holzbruecke.png"],
      apfelbaum:   ["assets/scenes/apfelbaum.png","assets/scenes/apfelbaum.jpg","assets/scenes/Apfelbaum.png"],
      sternstein:  ["assets/scenes/sternstein.png","assets/scenes/sternstein.jpg","assets/scenes/Sternstein.png"],
      bosstor:     ["assets/scenes/bosstor.png","assets/scenes/bossTor.png","assets/scenes/boss_tor.png","assets/scenes/BossTor.png","assets/scenes/bosstor.jpg","assets/scenes/bosstor.webp"],
      wasserwelt:  ["assets/scenes/wasserwelt.png","assets/scenes/wasserwelt.jpg","assets/scenes/Wasserwelt.png"],
    },
    interact: {
      Stern:   "assets/ui/interactables/Stern.png",
      Apfel:   "assets/ui/interactables/Apfel.png",
      Laterne: "assets/ui/interactables/Laterne.png",
    },
    icons: {
      herz:  "assets/ui/icons/herz.png",
      stern: "assets/ui/icons/stern.png",
      spark: "assets/ui/icons/geheimfunke.png",
    },
    fips: {
      idle:     "assets/chars/fips/idle.png",
      happy:    "assets/chars/fips/happy.png",
      excited:  "assets/chars/fips/excited.png",
      thinking: "assets/chars/fips/thinking.png",
      sad:      "assets/chars/fips/sad.png",
    }
  };

  // ------------------------------------------------------------
  // Boss settings (9 questions = 9 HP)
  // ------------------------------------------------------------
  const BOSS_HP_MAX = 9;

  // ------------------------------------------------------------
  // Nodes
  // Sammeln ist komplett optional (Bonus only).
  // ------------------------------------------------------------
  const NODES = [
    {
      id:"N1", key:"waldweg", title:"Waldweg",
      sparkHotspot: { x: 14, y: 78, r: 7 },
      interactables: [
        { id:"star1", type:"collect_star",    img:ASSETS.interact.Stern,   x: 38, y: 70, size:"small", once:true, points: 1, label:"Stern" },
        { id:"lan1",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 73, y: 33, size:"small", once:true, points: 1, label:"Laterne" },
        { id:"ap1",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 86, y: 40, size:"small", once:true, points: 1, label:"Apfel" }
      ],
      readSteps: [
        { text:"Fips steht am Waldweg.<br>Eine Laterne leuchtet.<br>Fips bleibt ruhig und liest.",
          question:"Wo steht Fips?",
          answers:[
            { t:"Am Waldweg.", correct:true },
            { t:"Im Wasser.", correct:false },
            { t:"Auf dem Dach.", correct:false }
          ]
        },
        { text:"Fips steht am Waldweg.<br>Eine Laterne leuchtet.<br>Fips bleibt ruhig und liest.",
          question:"Was leuchtet?",
          answers:[
            { t:"Die Laterne.", correct:true },
            { t:"Ein Auto.", correct:false },
            { t:"Ein Schuh.", correct:false }
          ]
        },
        { text:"Fips steht am Waldweg.<br>Eine Laterne leuchtet.<br>Fips bleibt ruhig und liest.",
          question:"Was tut Fips?",
          answers:[
            { t:"Er liest.", correct:true },
            { t:"Er rennt.", correct:false },
            { t:"Er schläft.", correct:false }
          ]
        }
      ]
    },
    {
      id:"N2", key:"holzbruecke", title:"Holzbrücke",
      sparkHotspot: { x: 82, y: 63, r: 7 },
      interactables: [
        { id:"star2", type:"collect_star",    img:ASSETS.interact.Stern,   x: 55, y: 72, size:"small", once:true, points: 1, label:"Stern" },
        { id:"lan2",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 22, y: 42, size:"small", once:true, points: 1, label:"Laterne" },
        { id:"ap2",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 80, y: 78, size:"tiny",  once:true, points: 1, label:"Apfel" }
      ],
      readSteps: [
        { text:"Vor Fips ist eine Holzbrücke.<br>Fips geht langsam.<br>Die Brücke knarrt leise.",
          question:"Was ist vor Fips?",
          answers:[
            { t:"Eine Holzbrücke.", correct:true },
            { t:"Ein Auto.", correct:false },
            { t:"Ein Flugzeug.", correct:false }
          ]
        },
        { text:"Vor Fips ist eine Holzbrücke.<br>Fips geht langsam.<br>Die Brücke knarrt leise.",
          question:"Was macht die Brücke?",
          answers:[
            { t:"Sie knarrt leise.", correct:true },
            { t:"Sie fliegt.", correct:false },
            { t:"Sie schläft.", correct:false }
          ]
        },
        { text:"Vor Fips ist eine Holzbrücke.<br>Fips geht langsam.<br>Die Brücke knarrt leise.",
          question:"Wie geht Fips?",
          answers:[
            { t:"Langsam.", correct:true },
            { t:"Rückwärts.", correct:false },
            { t:"Unsichtbar.", correct:false }
          ]
        }
      ]
    },
    {
      id:"N3", key:"apfelbaum", title:"Apfelbaum",
      sparkHotspot: { x: 50, y: 18, r: 7 },
      interactables: [
        { id:"star3", type:"collect_star",    img:ASSETS.interact.Stern,   x: 25, y: 77, size:"small", once:true, points: 1, label:"Stern" },
        { id:"ap3",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 78, y: 40, size:"small", once:true, points: 1, label:"Apfel" },
        { id:"lan3",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 60, y: 70, size:"tiny",  once:true, points: 1, label:"Laterne" }
      ],
      readSteps: [
        { text:"Fips sieht einen Apfelbaum.<br>Ein Apfel hängt am Ast.<br>Fips lächelt.",
          question:"Was sieht Fips?",
          answers:[
            { t:"Einen Apfelbaum.", correct:true },
            { t:"Einen Fernseher.", correct:false },
            { t:"Eine Rakete.", correct:false }
          ]
        },
        { text:"Fips sieht einen Apfelbaum.<br>Ein Apfel hängt am Ast.<br>Fips lächelt.",
          question:"Was hängt am Ast?",
          answers:[
            { t:"Ein Apfel.", correct:true },
            { t:"Ein Hut.", correct:false },
            { t:"Ein Ball.", correct:false }
          ]
        },
        { text:"Fips sieht einen Apfelbaum.<br>Ein Apfel hängt am Ast.<br>Fips lächelt.",
          question:"Was macht Fips?",
          answers:[
            { t:"Er lächelt.", correct:true },
            { t:"Er bellt.", correct:false },
            { t:"Er schwimmt.", correct:false }
          ]
        }
      ]
    },
    {
      id:"N4", key:"sternstein", title:"Sternstein",
      sparkHotspot: { x: 18, y: 34, r: 7 },
      interactables: [
        { id:"star4", type:"collect_star",    img:ASSETS.interact.Stern,   x: 52, y: 73, size:"small", once:true, points: 1, label:"Stern" },
        { id:"lan4",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 78, y: 40, size:"small", once:true, points: 1, label:"Laterne" },
        { id:"ap4",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 86, y: 84, size:"tiny",  once:true, points: 1, label:"Apfel" }
      ],
      readSteps: [
        { text:"Fips findet einen Sternstein.<br>Der Stein glitzert.<br>Fips tippt ihn an.",
          question:"Was findet Fips?",
          answers:[
            { t:"Einen Sternstein.", correct:true },
            { t:"Einen Stuhl.", correct:false },
            { t:"Einen Steinpilz.", correct:false }
          ]
        },
        { text:"Fips findet einen Sternstein.<br>Der Stein glitzert.<br>Fips tippt ihn an.",
          question:"Was glitzert?",
          answers:[
            { t:"Der Stein.", correct:true },
            { t:"Der Schuh.", correct:false },
            { t:"Der Stuhl.", correct:false }
          ]
        },
        { text:"Fips findet einen Sternstein.<br>Der Stein glitzert.<br>Fips tippt ihn an.",
          question:"Was macht Fips?",
          answers:[
            { t:"Er tippt ihn an.", correct:true },
            { t:"Er wirft ihn weg.", correct:false },
            { t:"Er versteckt sich.", correct:false }
          ]
        }
      ]
    },
    {
      id:"N5", key:"bosstor", title:"Boss-Tor",
      sparkHotspot: { x: 90, y: 20, r: 7 },
      interactables: [
        { id:"star5", type:"collect_star",    img:ASSETS.interact.Stern,   x: 40, y: 72, size:"small", once:true, points: 1, label:"Stern" },
        { id:"lan5",  type:"collect_lantern", img:ASSETS.interact.Laterne, x: 70, y: 35, size:"small", once:true, points: 1, label:"Laterne" },
        { id:"ap5",   type:"collect_apple",   img:ASSETS.interact.Apfel,   x: 84, y: 74, size:"tiny",  once:true, points: 1, label:"Apfel" }
      ],
      boss: { name: "Torwächter", hpMax: BOSS_HP_MAX },
      readBoss: [
        { text:"Vor Fips ist ein großes Tor.<br>Fips braucht einen Schlüssel.<br>Das Tor bleibt zu.",
          question:"Was braucht Fips?",
          answers:[ {t:"Den Schlüssel.",correct:true},{t:"Einen Ball.",correct:false},{t:"Eine Leiter.",correct:false} ]
        },
        { text:"Fips bleibt ruhig.<br>Fips liest den Text.<br>Fips denkt nach.",
          question:"Was tut Fips?",
          answers:[ {t:"Er liest.",correct:true},{t:"Er schläft.",correct:false},{t:"Er fliegt.",correct:false} ]
        },
        { text:"Ein Funken glitzert.<br>Fips bleibt aufmerksam.<br>Das Tor wartet.",
          question:"Was glitzert?",
          answers:[ {t:"Ein Funken.",correct:true},{t:"Ein Auto.",correct:false},{t:"Ein Baum.",correct:false} ]
        },
        { text:"Fips steht vor dem Tor.<br>Fips atmet tief.<br>Fips bleibt ruhig.",
          question:"Wo steht Fips?",
          answers:[ {t:"Vor dem Tor.",correct:true},{t:"Im Bett.",correct:false},{t:"Im Haus.",correct:false} ]
        },
        { text:"Das Tor ist groß.<br>Das Tor ist alt.<br>Das Tor ist schwer.",
          question:"Wie ist das Tor?",
          answers:[ {t:"Schwer.",correct:true},{t:"Weich.",correct:false},{t:"Klein.",correct:false} ]
        },
        { text:"Fips hört ein Knacken.<br>Das Holz knarrt.<br>Fips schaut hin.",
          question:"Was hört Fips?",
          answers:[ {t:"Ein Knacken.",correct:true},{t:"Ein Lied.",correct:false},{t:"Ein Telefon.",correct:false} ]
        },
        { text:"Fips hebt die Hand.<br>Fips tippt an das Tor.<br>Fips wartet.",
          question:"Was macht Fips?",
          answers:[ {t:"Er tippt an das Tor.",correct:true},{t:"Er rennt weg.",correct:false},{t:"Er schläft.",correct:false} ]
        },
        { text:"Ein Licht flackert.<br>Fips schaut genau.<br>Fips bleibt still.",
          question:"Was flackert?",
          answers:[ {t:"Ein Licht.",correct:true},{t:"Ein Fisch.",correct:false},{t:"Ein Stein.",correct:false} ]
        },
        { text:"Fips findet Mut.<br>Fips bleibt dran.<br>Fips gibt nicht auf.",
          question:"Was findet Fips?",
          answers:[ {t:"Mut.",correct:true},{t:"Eine Pizza.",correct:false},{t:"Ein Fahrrad.",correct:false} ]
        }
      ]
    }
  ];

  // ------------------------------------------------------------
  // Storage
  // ------------------------------------------------------------
  const STORAGE_KEY = "leselabyrinth_funkelwald_v7_fullscene_bottomparch_negativefx";

  const defaultState = () => ({
    nodeIndex: 0,
    unlocked: [true, false, false, false, false],
    completed: [false, false, false, false, false],

    stars: 0,
    apples: 0,
    lanterns: 0,
    sparks: 0,

    streak: 0,
    level: 1,
    xp: 0,
    xpNeed: 110,
    heartsMax: 3,
    hearts: 3,
    focus: "W-Frage",

    scene: NODES.map(n => ({
      tries: 0,
      answered: false,
      perfect: true,
      sparkFound: false,
      collected: {},

      qIndex: 0,
      correctSteps: [false,false,false],
      xpGrantedSteps: [false,false,false],

      bossHP: n.boss ? n.boss.hpMax : 0,
      bossStep: 0,
      bossXpGrantedSteps: Array(BOSS_HP_MAX).fill(false)
    }))
  });

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      const d = defaultState();
      return {
        ...d,
        ...parsed,
        scene: (parsed.scene && parsed.scene.length === NODES.length) ? parsed.scene : d.scene
      };
    }catch(e){
      return defaultState();
    }
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // ------------------------------------------------------------
  // UI refs
  // ------------------------------------------------------------
  const el = {
    sceneTitle: document.getElementById("sceneTitle"),
    readText: document.getElementById("readText"),
    question: document.getElementById("question"),
    answers: document.getElementById("answers"),
    reReadBtn: document.getElementById("reReadBtn"),
    nextBtn: document.getElementById("nextBtn"),
    statusLine: document.getElementById("statusLine"),
    qProgress: document.getElementById("qProgress"),

    sceneImg: document.getElementById("sceneImg"),
    sceneFallback: document.getElementById("sceneFallback"),
    overlay: document.getElementById("overlay"),
    gateOpen: document.getElementById("gateOpen"),

    bossHud: document.getElementById("bossHud"),
    bossName: document.getElementById("bossName"),
    bossBarFill: document.getElementById("bossBarFill"),
    bossHPText: document.getElementById("bossHPText"),
    dmg: document.getElementById("dmg"),

    fipsAvatar: document.getElementById("fipsAvatar"),
    fipsLine: document.getElementById("fipsLine"),
    fipsMainImg: document.getElementById("fipsMainImg"),
    fipsMainLine: document.getElementById("fipsMainLine"),

    pathList: document.getElementById("pathList"),
    chapterStatus: document.getElementById("chapterStatus"),
    unlockHint: document.getElementById("unlockHint"),

    hearts: document.getElementById("hearts"),
    starsVal: document.getElementById("starsVal"),
    applesVal: document.getElementById("applesVal"),
    lanternsVal: document.getElementById("lanternsVal"),
    sparksVal: document.getElementById("sparksVal"),
    streakVal: document.getElementById("streakVal"),
    levelVal: document.getElementById("levelVal"),
    focusVal: document.getElementById("focusVal"),
    xpVal: document.getElementById("xpVal"),
    xpNeed: document.getElementById("xpNeed"),
    xpBar: document.getElementById("xpBar"),

    pillHearts: document.getElementById("pillHearts"),
    pillStars: document.getElementById("pillStars"),
    pillApples: document.getElementById("pillApples"),
    pillLanterns: document.getElementById("pillLanterns"),
    pillSparks: document.getElementById("pillSparks"),
    pillXP: document.getElementById("pillXP"),

    resetBtn: document.getElementById("resetBtn"),
    helpBtn: document.getElementById("helpBtn"),

    toast: document.getElementById("toast"),

    celebrate: document.getElementById("celebrate"),
    confetti: document.getElementById("confetti"),
    fipsGiantImg: document.getElementById("fipsGiantImg"),
    celebrateText: document.getElementById("celebrateText"),

    oops: document.getElementById("oops"),
    oopsText: document.getElementById("oopsText"),
    oopsFipsImg: document.getElementById("oopsFipsImg"),

    bonus: document.getElementById("bonus"),
    bonusGrid: document.getElementById("bonusGrid"),
    bonusCloseBtn: document.getElementById("bonusCloseBtn"),
    bonusOkBtn: document.getElementById("bonusOkBtn"),

    splash: document.getElementById("splash"),
    closeSplashBtn: document.getElementById("closeSplashBtn"),
    reportGrid: document.getElementById("reportGrid"),

    drawerBtn: document.getElementById("drawerBtn"),
    drawer: document.getElementById("drawer"),
    drawerCloseBtn: document.getElementById("drawerCloseBtn"),
  };

  // ------------------------------------------------------------
  // Helpers
  // ------------------------------------------------------------
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

  function toast(html, ms=2200){
    el.toast.innerHTML = html;
    el.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.toast.classList.remove("show"), ms);
  }

  function setFips(mood, line){
    const src = ASSETS.fips[mood] || ASSETS.fips.idle;
    el.fipsAvatar.src = src;
    el.fipsMainImg.src = src;
    el.fipsLine.textContent = line;
    el.fipsMainLine.textContent = line;

    el.fipsMainImg.classList.remove("wiggle");
    void el.fipsMainImg.offsetWidth;
    el.fipsMainImg.classList.add("wiggle");
  }

  function pulse(pill){
    pill.classList.remove("pulse");
    void pill.offsetWidth;
    pill.classList.add("pulse");
  }

  function gainXP(amount){
    state.xp += amount;
    while(state.xp >= state.xpNeed){
      state.xp -= state.xpNeed;
      state.level += 1;
      state.xpNeed = Math.round(state.xpNeed * 1.18 + 10);
      toast(`<b>Level Up!</b> Stufe ${state.level} erreicht.`);
      setFips("excited", `Stufe ${state.level}. Weiter.`);
    }
    pulse(el.pillXP);
  }

  function vibrate(ms=40){
    try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){}
  }

  function loseHeart(){
    state.hearts = clamp(state.hearts - 1, 0, state.heartsMax);
    pulse(el.pillHearts);
    vibrate(60);

    if(state.hearts === 0){
      toast(`<b>Oh nein.</b> Keine Herzen mehr. Szene startet neu.`);
      const i = state.nodeIndex;
      const s = state.scene[i];

      s.tries = 0;
      s.answered = false;
      s.perfect = true;
      s.collected = {};
      s.sparkFound = false;

      s.qIndex = 0;
      s.correctSteps = [false,false,false];
      s.xpGrantedSteps = [false,false,false];

      if(NODES[i].boss){
        s.bossHP = NODES[i].boss.hpMax;
        s.bossStep = 0;
        s.bossXpGrantedSteps = Array(BOSS_HP_MAX).fill(false);
      }

      state.hearts = state.heartsMax;
      state.streak = 0;
      setFips("sad", "Nochmal. Lies und antworte.");
      vibrate(140);
    }
  }

  function burstAtHotspot(hsEl){
    const b = document.createElement("div");
    b.className = "sparkBurst";
    hsEl.appendChild(b);
    setTimeout(()=>b.remove(), 500);
  }

  function flyToHUD(fromClientX, fromClientY, iconSrc, targetEl){
    const rect = targetEl.getBoundingClientRect();
    const tx = rect.left + rect.width/2;
    const ty = rect.top + rect.height/2;

    const img = document.createElement("img");
    img.src = iconSrc;
    img.className = "fly";
    img.style.left = fromClientX + "px";
    img.style.top = fromClientY + "px";
    document.body.appendChild(img);

    img.animate([
      { transform: "translate(-50%,-50%) scale(1)", opacity: 1 },
      { transform: `translate(${(tx-fromClientX)}px, ${(ty-fromClientY)}px) scale(.65)`, opacity: 0 }
    ], { duration: 650, easing: "ease-in", fill: "forwards" });

    setTimeout(()=>img.remove(), 700);
  }

  // deterministic shuffle per (scene + question + tries)
  function shuffledAnswersWithKey(answers, seedKey){
    const arr = answers.map((a,i)=>({a, i}));
    let h = 2166136261;
    for(let i=0;i<seedKey.length;i++){
      h ^= seedKey.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    let x = h >>> 0;
    function rnd(){
      x ^= x << 13; x >>>= 0;
      x ^= x >> 17; x >>>= 0;
      x ^= x << 5;  x >>>= 0;
      return (x >>> 0) / 4294967296;
    }
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(rnd()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  // ------------------------------------------------------------
  // Completion
  // ------------------------------------------------------------
  function markCompleted(i){
    state.completed[i] = true;
    state.scene[i].answered = true;

    gainXP(30);
    state.streak += 1;
    if(i < NODES.length - 1) state.unlocked[i+1] = true;

    showBonusModal();
  }

  function autoAdvance(){
    const i = state.nodeIndex;
    if(i < NODES.length - 1 && state.unlocked[i+1]){
      setTimeout(() => {
        if(state.nodeIndex === i && state.completed[i]){
          state.nodeIndex = i+1;
          saveState();
          renderAll();
        }
      }, 900);
    }
  }

  // ------------------------------------------------------------
  // Scene image loader with fallbacks
  // ------------------------------------------------------------
  async function setSceneImage(nodeKey){
    const candidates = ASSETS.scenes[nodeKey] || [];
    el.sceneFallback.classList.remove("show");
    el.sceneImg.style.display = "block";

    const tryLoad = (src) => new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve({ ok:true, src });
      img.onerror = () => resolve({ ok:false, src });
      img.src = src;
    });

    for(const src of candidates){
      const r = await tryLoad(src);
      if(r.ok){
        el.sceneImg.src = r.src;
        return true;
      }
    }

    el.sceneImg.removeAttribute("src");
    el.sceneImg.style.display = "none";
    el.sceneFallback.classList.add("show");
    toast("<b>Szene-Bild fehlt.</b> Dateiname/Pfad prüfen.", 2600);
    return false;
  }

  // ------------------------------------------------------------
  // Render HUD
  // ------------------------------------------------------------
  function renderHUD(){
    el.starsVal.textContent = state.stars;
    el.applesVal.textContent = state.apples;
    el.lanternsVal.textContent = state.lanterns;
    el.sparksVal.textContent = state.sparks;
    el.streakVal.textContent = state.streak;
    el.levelVal.textContent = state.level;
    el.focusVal.textContent = state.focus;

    el.xpVal.textContent = state.xp;
    el.xpNeed.textContent = state.xpNeed;

    const pct = clamp((state.xp / state.xpNeed) * 100, 0, 100);
    el.xpBar.style.width = pct.toFixed(1) + "%";

    el.hearts.innerHTML = "";
    for(let i=0;i<state.heartsMax;i++){
      const img = document.createElement("img");
      img.src = ASSETS.icons.herz;
      img.alt = "Herz";
      img.className = "heart" + (i < state.hearts ? "" : " off");
      el.hearts.appendChild(img);
    }
  }

  // ------------------------------------------------------------
  // Render Path
  // ------------------------------------------------------------
  function renderPath(){
    el.pathList.innerHTML = "";
    const done = state.completed.filter(Boolean).length;
    el.chapterStatus.textContent = `${done}/5 erledigt`;

    NODES.forEach((n, i) => {
      const unlocked = state.unlocked[i];
      const completed = state.completed[i];

      const btn = document.createElement("div");
      btn.className = "node" + (unlocked ? "" : " locked") + (i===state.nodeIndex ? " active" : "");
      const extra = completed ? "erledigt" : (unlocked ? "bereit" : "gesperrt");
      btn.innerHTML = `
        <div class="left">
          <div class="badge">${i+1}</div>
          <div>
            <div style="font-weight:1000; line-height:1.05;">${n.title}</div>
            <div class="tiny" style="margin-top:2px;">${extra}</div>
          </div>
        </div>
        <div class="tiny">${completed ? "✓" : (unlocked ? "→" : "🔒")}</div>
      `;
      btn.addEventListener("click", () => {
        if(!state.unlocked[i]) return;
        state.nodeIndex = i;
        saveState();
        renderAll();
      });
      el.pathList.appendChild(btn);
    });
  }

  // ------------------------------------------------------------
  // Boss UI
  // ------------------------------------------------------------
  function bossHitFX(dmg=1){
    el.bossHud.classList.add("hit");
    el.bossHud.classList.add("bossShake");
    el.dmg.textContent = `-${dmg}`;
    el.dmg.classList.remove("show");
    void el.dmg.offsetWidth;
    el.dmg.classList.add("show");
    vibrate(50);

    setTimeout(()=>el.bossHud.classList.remove("hit"), 380);
    setTimeout(()=>el.bossHud.classList.remove("bossShake"), 260);
  }

  function renderBossUI(node, sceneState){
    if(node.boss){
      el.bossHud.classList.add("show");
      el.bossName.textContent = node.boss.name;
      const hpMax = node.boss.hpMax;
      const hp = clamp(sceneState.bossHP, 0, hpMax);
      el.bossHPText.textContent = hp;
      el.bossBarFill.style.width = ((hp / hpMax) * 100) + "%";
    }else{
      el.bossHud.classList.remove("show");
    }
  }

  // ------------------------------------------------------------
  // Celebration (positive, unchanged)
  // ------------------------------------------------------------
  function clearConfetti(){ el.confetti.innerHTML = ""; }

  function spawnConfettiBurst(){
    clearConfetti();
    const pieces = 56;
    for(let i=0;i<pieces;i++){
      const d = document.createElement("div");
      d.className = "c";
      const left = Math.random() * 100;
      const delay = Math.random() * 120;
      const dur = 920 + Math.random()*520;
      const w = 8 + Math.random()*8;
      const h = 10 + Math.random()*12;

      d.style.left = left + "%";
      d.style.top = (-20 - Math.random()*120) + "px";
      d.style.width = w + "px";
      d.style.height = h + "px";
      d.style.animationDelay = delay + "ms";
      d.style.animationDuration = dur + "ms";

      const r = 200 + Math.floor(Math.random()*55);
      const g = 150 + Math.floor(Math.random()*80);
      const b = 140 + Math.floor(Math.random()*90);
      d.style.background = `rgba(${r},${g},${b},.92)`;

      el.confetti.appendChild(d);
    }
  }

  function showFipsCelebration(text){
    el.fipsGiantImg.src = ASSETS.fips.excited || ASSETS.fips.happy || ASSETS.fips.idle;
    el.celebrateText.textContent = text || "Richtig";
    spawnConfettiBurst();
    el.celebrate.classList.add("show");

    clearTimeout(showFipsCelebration._t);
    showFipsCelebration._t = setTimeout(() => {
      el.celebrate.classList.remove("show");
      clearConfetti();
    }, 980);
  }

  // ------------------------------------------------------------
  // NEW: Negative feedback (cloud + sad fips)
  // ------------------------------------------------------------
  function showOops(text){
    el.oopsText.textContent = text || "Nicht richtig";
    el.oopsFipsImg.src = ASSETS.fips.sad || ASSETS.fips.idle;
    el.oops.classList.add("show");
    clearTimeout(showOops._t);
    showOops._t = setTimeout(() => {
      el.oops.classList.remove("show");
    }, 850);
  }

  // ------------------------------------------------------------
  // Bonus modal
  // ------------------------------------------------------------
  function showBonusModal(){
    el.bonusGrid.innerHTML = [
      { label:"Sterne",   img:"assets/ui/icons/stern.png",           val: state.stars },
      { label:"Äpfel",    img:"assets/ui/interactables/Apfel.png",   val: state.apples },
      { label:"Laternen", img:"assets/ui/interactables/Laterne.png", val: state.lanterns },
    ].map(x => `
      <div class="bonusTile">
        <div class="bonusIcon"><img src="${x.img}" alt="${x.label}"></div>
        <div class="bonusCount">${x.label}<div style="font-size:24px;">${x.val}</div></div>
      </div>
    `).join("");
    el.bonus.classList.add("show");
  }
  function hideBonusModal(){ el.bonus.classList.remove("show"); }

  // ------------------------------------------------------------
  // Render Scene
  // ------------------------------------------------------------
  async function renderScene(){
    const i = state.nodeIndex;
    const node = NODES[i];
    const s = state.scene[i];

    el.sceneTitle.textContent = node.title;
    el.overlay.innerHTML = "";
    el.gateOpen.classList.remove("show");

    await setSceneImage(node.key);
    renderBossUI(node, s);

    let pack, qLabel, answers, seedKey;

    if(node.boss){
      const step = clamp(s.bossStep, 0, node.readBoss.length - 1);
      pack = node.readBoss[step];
      qLabel = `Bossfrage ${step+1}/${node.readBoss.length}`;
      seedKey = `${node.id}|boss|${step}|${s.tries}`;
      answers = shuffledAnswersWithKey(pack.answers, seedKey);
    }else{
      const qi = clamp(s.qIndex, 0, node.readSteps.length - 1);
      pack = node.readSteps[qi];
      qLabel = `Frage ${qi+1}/${node.readSteps.length}`;
      seedKey = `${node.id}|q|${qi}|${s.tries}`;
      answers = shuffledAnswersWithKey(pack.answers, seedKey);
    }

    el.readText.innerHTML = pack.text;
    el.question.textContent = pack.question;
    el.qProgress.textContent = qLabel;

    renderAnswers(answers);

    el.nextBtn.disabled = !(state.completed[i] && i < NODES.length-1 && state.unlocked[i+1]);

    // Interactables (optional) + protect against parchment collision
    node.interactables.forEach(it => {
      if(it.once && s.collected[it.id]) return;

      // If item would land in parchment area, auto-shift upward a bit
      let x = it.x;
      let y = it.y;

      // Bottom bar takes roughly 24% height. We keep items above ~76%.
      if(y > 76) y = 74;

      const hs = document.createElement("div");
      hs.className = "hotspot " + (it.size || "");
      hs.style.left = x + "%";
      hs.style.top  = y + "%";
      hs.style.setProperty("--w", it.size==="tiny" ? "70px" : "120px");
      hs.title = it.label || "Tippen";

      const img = document.createElement("img");
      img.src = it.img;
      img.alt = it.label || "Tippen";
      hs.appendChild(img);

      hs.addEventListener("click", (e) => {
        e.stopPropagation();
        onInteract(it, hs, e.clientX, e.clientY);
      });

      el.overlay.appendChild(hs);
    });

    // Secret spark (optional)
    const sp = node.sparkHotspot;
    if(sp && !s.sparkFound){
      const hs = document.createElement("div");
      hs.className = "hotspot";
      hs.style.left = sp.x + "%";
      hs.style.top  = (sp.y > 76 ? 74 : sp.y) + "%";
      hs.style.width = (sp.r*2) + "%";
      hs.style.height = (sp.r*2) + "%";
      hs.style.borderRadius = "999px";
      hs.style.opacity = "0.001";
      hs.addEventListener("click", (e) => {
        e.stopPropagation();
        s.sparkFound = true;
        state.sparks += 1;
        pulse(el.pillSparks);
        gainXP(10);
        toast(`<b>Geheimfunke!</b>`);
        setFips("excited", "Geheimfunke gefunden.");
        saveState();
        renderAll();
      });
      el.overlay.appendChild(hs);
    }
  }

  function renderAnswers(shuffled){
    el.answers.innerHTML = "";
    shuffled.forEach((wrap) => {
      const div = document.createElement("div");
      div.className = "ans";
      div.textContent = wrap.a.t;
      div.addEventListener("click", () => onAnswer(wrap.a, div));
      el.answers.appendChild(div);
    });

    const i = state.nodeIndex;
    const ok = state.completed[i] ? "erledigt" : "offen";
    el.statusLine.innerHTML = `Status: <span class="tiny">${ok}</span>`;
  }

  // ------------------------------------------------------------
  // Interact (Bonus sammeln)
  // ------------------------------------------------------------
  function onInteract(it, hsEl, cx, cy){
    const i = state.nodeIndex;
    const s = state.scene[i];
    if(state.completed[i]) return;

    if(it.once) s.collected[it.id] = true;
    burstAtHotspot(hsEl);

    if(it.type === "collect_star"){
      state.stars += (it.points || 1);
      pulse(el.pillStars);
      gainXP(3);
      setFips("happy", "Bonus: Stern.");
      flyToHUD(cx, cy, ASSETS.icons.stern, el.pillStars);
      toast(`<b>★</b> Bonus`, 1400);
    } else if(it.type === "collect_apple"){
      state.apples += (it.points || 1);
      pulse(el.pillApples);
      gainXP(2);
      setFips("happy", "Bonus: Apfel.");
      flyToHUD(cx, cy, ASSETS.interact.Apfel, el.pillApples);
      toast(`<b>🍎</b> Bonus`, 1400);
    } else if(it.type === "collect_lantern"){
      state.lanterns += (it.points || 1);
      pulse(el.pillLanterns);
      gainXP(2);
      setFips("happy", "Bonus: Laterne.");
      flyToHUD(cx, cy, ASSETS.interact.Laterne, el.pillLanterns);
      toast(`<b>🕯</b> Bonus`, 1400);
    }

    saveState();
    renderHUD();
  }

  // ------------------------------------------------------------
  // Answer logic
  // ------------------------------------------------------------
  function onAnswer(chosen, btnEl){
    const i = state.nodeIndex;
    const node = NODES[i];
    const s = state.scene[i];

    if(state.completed[i]) return;

    const cards = [...el.answers.querySelectorAll(".ans")];
    cards.forEach(c => c.classList.remove("correct","wrong"));

    s.tries += 1;

    if(chosen && chosen.correct){
      btnEl.classList.add("correct");

      // POSITIVE FEEDBACK: untouched
      showFipsCelebration("Richtig");
      setFips("excited", "Richtig.");
      vibrate(45);

      if(node.boss){
        const step = clamp(s.bossStep, 0, node.readBoss.length - 1);

        if(!s.bossXpGrantedSteps[step]){
          s.bossXpGrantedSteps[step] = true;
          gainXP(14);
        }

        if(s.bossHP > 0){
          s.bossHP = clamp(s.bossHP - 1, 0, node.boss.hpMax);
          bossHitFX(1);
        }
        renderBossUI(node, s);

        s.bossStep = clamp(s.bossStep + 1, 0, node.readBoss.length - 1);

        if(s.bossHP === 0){
          el.statusLine.innerHTML = `Status: <span class="good">Boss besiegt.</span>`;
          gainXP(40);
          markCompleted(i);
          el.gateOpen.classList.add("show");
          setTimeout(() => {
            el.gateOpen.classList.remove("show");
            openReportAndSplash();
          }, 1200);
        }else{
          el.statusLine.innerHTML = `Status: <span class="good">Treffer.</span> ${s.bossHP}/${node.boss.hpMax}`;
        }
      }else{
        const qi = clamp(s.qIndex, 0, node.readSteps.length - 1);

        if(s.correctSteps[qi]){
          saveState();
          renderAll();
          return;
        }

        s.correctSteps[qi] = true;

        if(!s.xpGrantedSteps[qi]){
          s.xpGrantedSteps[qi] = true;
          gainXP(16);
        }

        if(qi < node.readSteps.length - 1){
          s.qIndex = qi + 1;
          el.statusLine.innerHTML = `Status: <span class="good">Richtig.</span>`;
        }else{
          el.statusLine.innerHTML = `Status: <span class="good">Erledigt.</span>`;
          markCompleted(i);
          autoAdvance();
        }
      }

      saveState();
      renderAll();
    } else {
      btnEl.classList.add("wrong");
      s.perfect = false;
      state.streak = 0;

      // NEW NEGATIVE FEEDBACK (cloud + sad Fips)
      showOops("Nicht richtig");
      toast(`<b>Falsch.</b>`, 1400);

      loseHeart();
      el.statusLine.innerHTML = `Status: <span class="bad">Falsch.</span>`;
      setFips("thinking", "Nochmal lesen.");

      saveState();
      renderAll();
    }
  }

  // ------------------------------------------------------------
  // Abschlussbericht + Splash
  // ------------------------------------------------------------
  function openReportAndSplash(){
    const items = [
      ["Sterne (Bonus)", state.stars],
      ["Äpfel (Bonus)", state.apples],
      ["Laternen (Bonus)", state.lanterns],
      ["Funken (Bonus)", state.sparks],
      ["Stufe", state.level],
      ["XP", `${state.xp}/${state.xpNeed}`],
      ["Serie", state.streak],
      ["Herzen", `${state.hearts}/${state.heartsMax}`],
    ];

    el.reportGrid.innerHTML = items.map(([k,v]) => `
      <div class="rep"><div class="k">${k}</div><div class="v">${v}</div></div>
    `).join("");

    el.splash.classList.add("show");
  }

  // ------------------------------------------------------------
  // Buttons
  // ------------------------------------------------------------
  el.reReadBtn.addEventListener("click", () => {
    toast(`<b>Nochmal lesen.</b>`, 1600);
    setFips("thinking", "Lies. Dann antworte.");
  });

  el.nextBtn.addEventListener("click", () => {
    const i = state.nodeIndex;
    if(i < NODES.length - 1 && state.unlocked[i+1]){
      state.nodeIndex = i+1;
      saveState();
      renderAll();
    }
  });

  el.resetBtn.addEventListener("click", () => {
    if(!confirm("Wirklich alles zurücksetzen?")) return;
    state = defaultState();
    saveState();
    renderAll();
    toast("<b>Reset.</b> Alles zurückgesetzt.");
    setFips("idle", "Los geht’s. Lesen, dann antworten.");
  });

  el.helpBtn.addEventListener("click", () => {
    toast(`<b>So geht’s:</b> Lesen · Antworten · Weiter. Sammeln ist Bonus.`, 5200);
    setFips("idle", "Lies. Antworte. Sammeln ist Bonus.");
  });

  el.bonusCloseBtn.addEventListener("click", hideBonusModal);
  el.bonusOkBtn.addEventListener("click", hideBonusModal);
  el.bonus.addEventListener("click", (e)=>{ if(e.target===el.bonus) hideBonusModal(); });

  el.closeSplashBtn.addEventListener("click", () => {
    el.splash.classList.remove("show");
  });

  // Drawer
  function toggleDrawer(force){
    const show = (force !== undefined) ? force : !el.drawer.classList.contains("show");
    el.drawer.classList.toggle("show", !!show);
  }
  el.drawerBtn.addEventListener("click", () => toggleDrawer());
  el.drawerCloseBtn.addEventListener("click", () => toggleDrawer(false));
  el.drawer.addEventListener("click", (e)=>{ if(e.target === el.drawer) toggleDrawer(false); });

  window.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if(k === "h") el.helpBtn.click();
    if(k === "r") el.resetBtn.click();
    if(k === "escape"){ hideBonusModal(); toggleDrawer(false); }
  });

  // ------------------------------------------------------------
  // Render All
  // ------------------------------------------------------------
  async function renderAll(){
    renderHUD();
    renderPath();
    await renderScene();

    const i = state.nodeIndex;
    el.nextBtn.disabled = !(state.completed[i] && i < NODES.length-1 && state.unlocked[i+1]);
  }

  // Initial
  setFips("idle", "Lies das Pergament. Beantworte Fragen. Sammeln ist Bonus.");
  renderAll().then(saveState);
})();
</script>
</body>
</html>

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leselabyrinth – OSION Solution XR</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(17,26,51,.78);
      --panel2:rgba(15,23,48,.62);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.16);

      --txt:#eaf0ff;
      --muted:#aab6da;

      --good:#43e08b;
      --bad:#ff5a7a;

      --accent1:#ff2d55;
      --accent2:#7a3cff;

      --shadow: 0 18px 60px rgba(0,0,0,.30);
      --radius:18px;
      --radius2:16px;
    }

    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 12% 10%, rgba(122,60,255,.25), transparent 60%),
        radial-gradient(1200px 700px at 90% 18%, rgba(255,45,85,.22), transparent 60%),
        var(--bg);
    }

    header{
      position:sticky; top:0; z-index:10;
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      background:rgba(11,16,32,.85);
      backdrop-filter: blur(10px);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{ display:flex; flex-direction:column; line-height:1.12; }
    .brand b{
      font-size:14px; letter-spacing:.8px;
      background: linear-gradient(90deg,var(--accent1),var(--accent2));
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
    }
    .brand span{ font-size:12px; color:var(--muted); }

    .top-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    button{
      appearance:none;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    button:hover{ border-color:rgba(255,255,255,.20) }
    button.primary{
      border:none;
      background: linear-gradient(90deg, rgba(255,45,85,.95), rgba(122,60,255,.95));
    }

    main{
      padding:16px;
      max-width:1100px;
      margin:0 auto;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }

    /* --- Layout: Guide oben (schmal), Content unten --- */
    .layout{
      display:grid;
      grid-template-rows: auto 1fr;
      gap:14px;
    }

    /* --- Top Guide Bar --- */
    .guidebar{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1.4fr;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .guidebar{ grid-template-columns: 1fr; }
    }

    .box{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(15,23,48,.55);
      padding:12px;
    }

    .guide{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .avatar{
      width:54px; height:54px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 50%),
        linear-gradient(135deg, rgba(255,45,85,.65), rgba(122,60,255,.55));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing:.5px;
      color:rgba(255,255,255,.92);
      flex:0 0 auto;
    }
    .speech{
      flex:1;
      padding:10px 12px;
      border-radius: var(--radius2);
      border:1px solid var(--stroke);
      background: rgba(17,26,51,.60);
      line-height:1.35;
      font-size:13.5px;
      min-height:54px;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background: rgba(17,26,51,.35);
      padding:10px 12px;
      min-height:54px;
    }
    .stat b{ display:block; font-size:12.5px; letter-spacing:.2px; }
    .stat span{ color:var(--muted); font-size:12px; }

    /* Map: horizontal scroll (kein Überlappen) */
    .mapwrap{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .maphead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .maphead b{ font-size:13px; }
    .maphead span{ font-size:12px; color:var(--muted); }

    .map{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
      -webkit-overflow-scrolling: touch;
    }
    .node{
      min-width: 170px;
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background: rgba(17,26,51,.30);
      padding:10px 12px;
      cursor:pointer;
      flex:0 0 auto;
    }
    .node:hover{ border-color:rgba(255,255,255,.20) }
    .node.locked{ opacity:.45; cursor:not-allowed; }
    .node.done{
      border-color: rgba(67,224,139,.35);
      background: rgba(67,224,139,.10);
    }
    .node small{ color:var(--muted); display:block; margin-bottom:4px; }
    .node b{ display:block; font-size:13px; }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* --- Bottom Content --- */
    .content{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .titleRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .titleRow h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(15,23,48,.55);
      padding:14px;
    }

    /* Szene Kopf */
    .scene{
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .scene .meta{ display:flex; flex-direction:column; gap:2px; }
    .scene .meta small{ color:var(--muted); }
    .scene .meta b{ font-size:16px; }

    /* Lesetext: deutlich hervorgehoben */
    .readingBox{
      border-radius: var(--radius);
      border:1px solid var(--stroke2);
      background:
        radial-gradient(900px 200px at 0% 0%, rgba(122,60,255,.20), transparent 55%),
        radial-gradient(900px 200px at 100% 0%, rgba(255,45,85,.18), transparent 55%),
        rgba(255,255,255,.035);
      padding:16px 16px;
      margin:12px 0 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.20) inset;
    }
    .readingLabel{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .readingLabel b{
      font-size:12.5px;
      letter-spacing:.35px;
      text-transform:uppercase;
      color:rgba(255,255,255,.85);
    }
    .readingHint{
      color:var(--muted);
      font-size:12px;
    }
    .text{
      font-size:20px;          /* wichtiger Punkt: groß */
      line-height:1.75;        /* leicht lesbar */
      font-weight:800;         /* klare Betonung */
      letter-spacing:.15px;
    }
    @media (max-width: 520px){
      .text{ font-size:18px; }
    }

    .question{
      font-weight:900;
      margin:10px 0 10px;
      font-size:16px;
    }

    .answers{
      display:grid;
      gap:10px;
    }
    .answers button{
      width:100%;
      text-align:left;
      padding:14px 14px;
      border-radius: 16px;
      font-size:14px;
    }

    .helpers{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }
    .helpers button{
      font-size:12px;
      padding:9px 10px;
      border-radius:999px;
    }

    .hr{ height:1px; background:var(--stroke); margin:12px 0; }

    .feedback{
      padding:12px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .hidden{ display:none !important; }

    /* Diagnose */
    .dashgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      color:var(--txt);
    }
    .table td, .table th{
      border-bottom:1px solid var(--stroke);
      padding:8px 6px;
      text-align:left;
    }
    .table th{ color:var(--muted); font-weight:800; }

    .good{ color:var(--good); font-weight:900; }
    .bad{ color:var(--bad); font-weight:900; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <b>OSION Solution XR</b>
    <span>Leselabyrinth · MVP · Adventure + AdaptiV + Diagnose</span>
  </div>
  <div class="top-actions">
    <button id="btnPlay" class="primary">Adventure</button>
    <button id="btnDash">Diagnose</button>
    <button id="btnReset">Reset</button>
  </div>
</header>

<main>
  <div class="layout">

    <!-- TOP: Guidebar -->
    <section class="panel">
      <div class="guidebar">

        <div class="box">
          <div class="guide">
            <div class="avatar" id="monsterAvatar">M</div>
            <div class="speech" id="monsterSpeech"></div>
          </div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <span class="pill" id="uiHelp"></span>
            <span class="pill" id="uiProgress"></span>
          </div>
        </div>

        <div class="box">
          <div class="stats">
            <div class="stat">
              <b>Stufe</b>
              <span id="uiLevel"></span>
            </div>
            <div class="stat">
              <b>Sterne</b>
              <span id="uiStars"></span>
            </div>
            <div class="stat">
              <b>Serie</b>
              <span id="uiStreak"></span>
            </div>
            <div class="stat">
              <b>Status</b>
              <span id="uiStatus"></span>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="mapwrap">
            <div class="maphead">
              <b>Kapitel: Der Wald</b>
              <span>Tippe einen Knoten an. Neue Knoten werden freigeschaltet.</span>
            </div>
            <div class="map" id="map"></div>
          </div>
        </div>

      </div>
    </section>

    <!-- BOTTOM: Content -->
    <section class="panel">
      <div class="content">

        <!-- PLAY VIEW -->
        <div id="viewPlay">
          <div class="titleRow">
            <h2>Lesekarte</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill" id="uiFocus"></span>
              <span class="pill" id="uiNodeState"></span>
            </div>
          </div>

          <div class="card" id="card"></div>
        </div>

        <!-- COMPLETE VIEW -->
        <div id="viewComplete" class="hidden">
          <div class="titleRow">
            <h2>Kapitel abgeschlossen</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill"><span class="good">Stark</span></span>
              <span class="pill" id="completeStars"></span>
            </div>
          </div>

          <div class="card">
            <div class="feedback" id="completeText"></div>
            <div class="hr"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button id="btnGoDash">Diagnose öffnen</button>
              <button id="btnReplay" class="primary">Kapitel neu spielen</button>
            </div>
          </div>
        </div>

        <!-- DASH VIEW -->
        <div id="viewDash" class="hidden">
          <div class="titleRow">
            <h2>Diagnose-Dashboard</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill" id="dDone"></span>
              <span class="pill" id="dAcc"></span>
              <span class="pill" id="dTime"></span>
            </div>
          </div>

          <div class="card">
            <div class="dashgrid">
              <div>
                <b style="display:block;margin-bottom:8px;">Fehlmuster (Top)</b>
                <table class="table">
                  <thead><tr><th>Kategorie</th><th>Anzahl</th><th>Beispiel</th></tr></thead>
                  <tbody id="dPatterns"></tbody>
                </table>
              </div>

              <div>
                <div class="hr"></div>
                <b style="display:block;margin-bottom:8px;">Stärken & Fokus</b>
                <div class="feedback" id="dCoach"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

  </div>
</main>

<script>
/** =========================
 *  KONFIG
 *  ========================= */
const APP = {
  BRAND: "OSION Solution XR",
  APP_NAME: "Leselabyrinth",
  CHAPTER_ID: "wald_v1",
  MONSTER_NAME: "Momo",
  LEVEL_MIN: 1,
  LEVEL_MAX: 3,
  TARGET_STREAK_UP: 3,
  TARGET_MISTAKES_HOLD: 2
};

const HELP_RULES = {
  1: { syllables: true, hintButton: true, rereadButton: true },
  2: { syllables: false, hintButton: true, rereadButton: true },
  3: { syllables: false, hintButton: false, rereadButton: true }
};

const STORE_KEY = "leselabyrinth_state_v2";

/** =========================
 *  CONTENT IM CODE
 *  ========================= */
const CARDS = [
  {
    id:"n1",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Start am Waldweg",
    textByLevel:{
      1:["Momo geht in den Wald.","Ein Vogel singt."],
      2:["Momo geht in den Wald.","Ein kleiner Vogel singt laut."],
      3:["Momo geht in den Wald.","Ein kleiner Vogel singt laut im Baum."]
    },
    questionByLevel:{ 1:"Wo geht Momo hin?", 2:"Wo geht Momo hin?", 3:"Wo geht Momo hin?" },
    answersByLevel:{
      1:["In den Wald.","In die Stadt.","Ins Meer."],
      2:["In den Wald.","In die Stadt.","Ins Meer."],
      3:["In den Wald.","In die Stadt.","Ins Meer."]
    },
    correctIndex:0,
    hint:"Im Satz steht: in den Wald.",
    focus:"W-Frage"
  },
  {
    id:"n2",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Die Holzbrücke",
    textByLevel:{
      1:["Vor Momo ist eine Brücke.","Sie ist aus Holz."],
      2:["Vor Momo ist eine kleine Brücke.","Sie ist aus Holz."],
      3:["Vor Momo ist eine kleine Brücke.","Sie ist aus Holz und wackelt leicht."]
    },
    questionByLevel:{ 1:"Woraus ist die Brücke?", 2:"Woraus ist die Brücke?", 3:"Woraus ist die Brücke?" },
    answersByLevel:{
      1:["Aus Holz.","Aus Eis.","Aus Papier."],
      2:["Aus Holz.","Aus Eis.","Aus Papier."],
      3:["Aus Holz.","Aus Eis.","Aus Papier."]
    },
    correctIndex:0,
    hint:"Lies den zweiten Satz: aus Holz.",
    focus:"Detail"
  },
  {
    id:"n3",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Der Apfelbaum",
    textByLevel:{
      1:["Ein Apfel fällt runter.","Momo schaut."],
      2:["Ein grüner Apfel fällt runter.","Momo schaut nach oben."],
      3:["Ein grüner Apfel fällt runter.","Momo schaut nach oben und lacht."]
    },
    questionByLevel:{ 1:"Welche Farbe hat der Apfel?", 2:"Welche Farbe hat der Apfel?", 3:"Welche Farbe hat der Apfel?" },
    answersByLevel:{
      1:["Grün.","Blau.","Schwarz."],
      2:["Grün.","Blau.","Schwarz."],
      3:["Grün.","Blau.","Schwarz."]
    },
    correctIndex:0,
    hint:"Im Satz steht: grüner Apfel.",
    focus:"Wortverwechslung"
  },
  {
    id:"n4",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Der Schlüsselstein",
    textByLevel:{
      1:["Momo findet einen Stein.","Darauf ist ein Zeichen."],
      2:["Momo findet einen Stein.","Darauf ist ein Stern-Zeichen."],
      3:["Momo findet einen Stein.","Darauf ist ein Stern-Zeichen und es glitzert."]
    },
    questionByLevel:{ 1:"Was ist auf dem Stein?", 2:"Was ist auf dem Stein?", 3:"Was ist auf dem Stein?" },
    answersByLevel:{
      1:["Ein Stern.","Ein Auto.","Ein Haus."],
      2:["Ein Stern.","Ein Auto.","Ein Haus."],
      3:["Ein Stern.","Ein Auto.","Ein Haus."]
    },
    correctIndex:0,
    hint:"Im Satz steht: Stern-Zeichen.",
    focus:"Satzverständnis"
  },
  {
    id:"n5",
    chapter: APP.CHAPTER_ID,
    nodeTitle:"Die Boss-Tür",
    textByLevel:{
      1:["Vor Momo ist eine Tür.","Sie ist zu."],
      2:["Vor Momo ist eine große Tür.","Sie ist zu und sehr schwer."],
      3:["Vor Momo ist eine große Tür.","Sie ist zu und sehr schwer.","Momo braucht den Schlüssel."]
    },
    questionByLevel:{ 1:"Was braucht Momo?", 2:"Was braucht Momo?", 3:"Was braucht Momo?" },
    answersByLevel:{
      1:["Den Schlüssel.","Eine Leiter.","Einen Ball."],
      2:["Den Schlüssel.","Eine Leiter.","Einen Ball."],
      3:["Den Schlüssel.","Eine Leiter.","Einen Ball."]
    },
    correctIndex:0,
    hint:"Im letzten Satz steht: braucht den Schlüssel.",
    focus:"Ursache/Wirkung"
  }
];

const MAP = {
  chapterId: APP.CHAPTER_ID,
  nodes: [
    { id:"n1", unlockFrom:null },
    { id:"n2", unlockFrom:"n1" },
    { id:"n3", unlockFrom:"n2" },
    { id:"n4", unlockFrom:"n3" },
    { id:"n5", unlockFrom:"n4" }
  ],
  sidepaths: [
    "Quatsch-Tunnel",
    "Kicherweg",
    "Sackgasse",
    "Rutschweg zurück zum Satz"
  ]
};

/** =========================
 *  STATE
 *  ========================= */
const defaultState = () => ({
  level: 1,
  stars: 0,
  currentNodeId: "n1",
  done: {},
  streakCorrect: 0,
  streakWrong: 0,
  chapterComplete: false,
  logs: []
});

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    return { ...defaultState(), ...s };
  }catch(e){
    return defaultState();
  }
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
let state = loadState();

/** =========================
 *  Helpers
 *  ========================= */
const $ = (id) => document.getElementById(id);
function getCard(nodeId){ return CARDS.find(c => c.id === nodeId); }

function isUnlocked(nodeId){
  const node = MAP.nodes.find(n => n.id===nodeId);
  if(!node) return false;
  if(node.unlockFrom===null) return true;
  return !!state.done[node.unlockFrom];
}

function allNodesDone(){
  return MAP.nodes.every(n => !!state.done[n.id]);
}

function helpSummary(level){
  const h = HELP_RULES[level];
  const parts = [];
  if(h.syllables) parts.push("Silben");
  if(h.hintButton) parts.push("Hinweis");
  if(h.rereadButton) parts.push("Nochmal lesen");
  return parts.length ? parts.join(" · ") : "keine";
}

function setMonster(text, mood="neutral"){
  // Avatar bewusst schlicht. Kein UI-Overkill.
  $("monsterAvatar").textContent = (APP.MONSTER_NAME || "M").slice(0,1).toUpperCase();
  const prefix =
    mood==="good" ? "Top. " :
    mood==="bad"  ? "Stopp. " :
                    "";
  $("monsterSpeech").innerHTML = `<b>${APP.MONSTER_NAME}</b><br>${prefix}${text}`;
}

/** =========================
 *  Rendering
 *  ========================= */
function renderTop(){
  $("uiLevel").textContent = `Stufe ${state.level}`;
  $("uiStars").textContent = `${state.stars} Sterne`;

  const streakText =
    state.streakCorrect > 0 ? `${state.streakCorrect} richtig in Folge` :
    state.streakWrong > 0   ? `${state.streakWrong} falsch in Folge` :
                              "keine Serie";
  $("uiStreak").textContent = streakText;

  $("uiHelp").textContent = `Hilfen: ${helpSummary(state.level)}`;
  $("uiProgress").textContent = `Abgeschlossen: ${Object.keys(state.done).length} / ${MAP.nodes.length}`;

  $("uiStatus").textContent = state.chapterComplete ? "Kapitel abgeschlossen" : "läuft";

  const c = getCard(state.currentNodeId);
  $("uiFocus").textContent = c ? `Fokus: ${c.focus}` : "Fokus: -";
  const nodeDone = state.currentNodeId ? !!state.done[state.currentNodeId] : false;
  $("uiNodeState").textContent = nodeDone ? "Status: erledigt" : "Status: offen";
}

function renderMap(){
  const wrap = $("map");
  wrap.innerHTML = "";
  MAP.nodes.forEach(n=>{
    const card = getCard(n.id);
    const unlocked = isUnlocked(n.id);
    const done = !!state.done[n.id];

    const el = document.createElement("div");
    el.className = "node" + (unlocked ? "" : " locked") + (done ? " done":"");
    el.innerHTML = `
      <small>${done ? "erledigt" : unlocked ? "bereit" : "gesperrt"}</small>
      <b>${card?.nodeTitle ?? n.id}</b>
    `;
    el.onclick = () => {
      if(!unlocked || state.chapterComplete) return;
      state.currentNodeId = n.id;
      saveState();
      showPlay();
      renderAll();
    };
    wrap.appendChild(el);
  });
}

/** -------------------------
 *  Lesetext: Silben Demo
 *  (Platzhalter. Für echte Silbentrennung später ersetzen)
 *  ------------------------- */
function syllabifySimple(word){
  return word.replace(/([aeiouäöüy]{1,2})([^aeiouäöüy])/gi, "$1-$2");
}
function applySyllablesToText(lines){
  return lines.map(line=>{
    return line.split(" ").map(w=>{
      const clean = w.replace(/[.,!?]/g,"");
      if(clean.length >= 7){
        const s = syllabifySimple(clean);
        return w.replace(clean, s);
      }
      return w;
    }).join(" ");
  });
}

let cardStartTs = null;

function renderCard(){
  const nodeId = state.currentNodeId;
  const c = getCard(nodeId);

  if(state.chapterComplete || !c){
    $("card").innerHTML = `<div class="feedback">Kein aktiver Knoten. Öffne die Diagnose oder starte neu.</div>`;
    return;
  }

  const level = state.level;
  let lines = c.textByLevel[level] || c.textByLevel[1];
  const question = c.questionByLevel[level] || c.questionByLevel[1];
  const answers = c.answersByLevel[level] || c.answersByLevel[1];

  const helps = HELP_RULES[level];
  let renderedLines = lines;
  if(helps.syllables) renderedLines = applySyllablesToText(lines);

  $("card").innerHTML = `
    <div class="scene">
      <div class="meta">
        <small>Szene</small>
        <b>${c.nodeTitle}</b>
      </div>
      <div class="pill">Knoten: ${c.id.toUpperCase()}</div>
    </div>

    <div class="readingBox" id="readingBox">
      <div class="readingLabel">
        <b>Lesetext</b>
        <div class="readingHint">Lies zuerst den Text. Dann beantworte die Frage.</div>
      </div>
      <div class="text" id="cardText">
        ${renderedLines.map(x=>`<div>${x}</div>`).join("")}
      </div>
    </div>

    <div class="question">${question}</div>

    <div class="answers" id="answers"></div>

    <div class="helpers">
      ${helps.rereadButton ? `<button id="btnReread">Nochmal lesen</button>` : ""}
      ${helps.hintButton ? `<button id="btnHint">Hinweis</button>` : ""}
      <span class="pill">Fokus: <b style="color:var(--txt)">${c.focus}</b></span>
    </div>

    <div class="hr"></div>
    <div class="feedback" id="feedback">Wähle eine Antwort.</div>
  `;

  const ansWrap = $("answers");
  answers.forEach((txt, idx)=>{
    const b = document.createElement("button");
    b.textContent = txt;
    b.onclick = () => submitAnswer(idx);
    ansWrap.appendChild(b);
  });

  if(helps.rereadButton){
    $("btnReread").onclick = () => {
      setMonster("Lies den Text noch einmal. Die Lösung steht im Satz.");
      $("feedback").textContent = "Nochmal lesen aktiviert.";
      // Lesetext optisch kurz anheben
      const box = $("readingBox");
      box.style.borderColor = "rgba(255,255,255,.28)";
      setTimeout(()=> box.style.borderColor = "var(--stroke2)", 450);
    };
  }
  if(helps.hintButton){
    $("btnHint").onclick = () => {
      setMonster(`Tipp: ${c.hint}`);
      $("feedback").textContent = `Hinweis: ${c.hint}`;
    };
  }

  cardStartTs = performance.now();
}

/** =========================
 *  Adaptive Regeln
 *  ========================= */
function adaptAfterAnswer(correct){
  if(correct){
    state.streakCorrect += 1;
    state.streakWrong = 0;

    if(state.streakCorrect >= APP.TARGET_STREAK_UP && state.level < APP.LEVEL_MAX){
      state.level += 1;
      state.streakCorrect = 0;
      setMonster(`Stufe erhöht: ${state.level}.`);
    } else {
      setMonster("Richtig. Weiter.");
    }
  }else{
    state.streakWrong += 1;
    state.streakCorrect = 0;

    const side = MAP.sidepaths[Math.floor(Math.random()*MAP.sidepaths.length)];
    setMonster(`Das war der ${side}. Lies den Satz noch einmal.`, "bad");
  }
}

/** =========================
 *  Submit + Kapitel-Ende Fix
 *  ========================= */
function nextUnlockedUndoneNode(){
  for(const n of MAP.nodes){
    if(isUnlocked(n.id) && !state.done[n.id]) return n.id;
  }
  return null;
}

function submitAnswer(chosenIndex){
  const nodeId = state.currentNodeId;
  const c = getCard(nodeId);
  if(!c || state.chapterComplete) return;

  const timeMs = Math.max(1, Math.round(performance.now() - (cardStartTs ?? performance.now())));
  const correct = chosenIndex === c.correctIndex;

  state.logs.push({
    ts: Date.now(),
    nodeId,
    level: state.level,
    correct,
    timeMs,
    focus: c.focus,
    chosenIndex,
    correctIndex: c.correctIndex
  });

  if(correct){
    state.stars += 1;
    state.done[nodeId] = true;

    adaptAfterAnswer(true);

    if(allNodesDone()){
      // FIX: Kein Zurück auf Karte 1, sondern Abschluss-Screen
      state.chapterComplete = true;
      state.currentNodeId = null;
      saveState();
      showComplete();
      renderAll();
      return;
    }

    state.currentNodeId = nextUnlockedUndoneNode();
    $("feedback").innerHTML = `<span class="good">Richtig.</span> 1 Stern.`;
  } else {
    adaptAfterAnswer(false);
    $("feedback").innerHTML = `<span class="bad">Noch nicht.</span> Tipp: ${c.hint}`;
  }

  saveState();
  renderAll();
}

/** =========================
 *  Diagnose
 *  ========================= */
function renderDashboard(){
  const logs = state.logs;
  const doneCount = Object.keys(state.done).length;

  const total = logs.length;
  const correct = logs.filter(x=>x.correct).length;
  const acc = total ? Math.round((correct/total)*100) : 0;

  const avgTime = total ? Math.round(logs.reduce((a,b)=>a+b.timeMs,0)/total) : 0;

  $("dDone").textContent = `Abgeschlossen: ${doneCount} / ${MAP.nodes.length}`;
  $("dAcc").innerHTML = `Trefferquote: ${acc}%`;
  $("dTime").textContent = `Ø Zeit: ${Math.round(avgTime/1000)} s`;

  const wrong = logs.filter(x=>!x.correct);
  const byFocus = {};
  wrong.forEach(x=>{
    byFocus[x.focus] = byFocus[x.focus] || { count:0, exampleNodeId:x.nodeId };
    byFocus[x.focus].count++;
  });

  const rows = Object.entries(byFocus)
    .sort((a,b)=>b[1].count - a[1].count)
    .slice(0,5);

  const tbody = $("dPatterns");
  tbody.innerHTML = "";
  if(rows.length===0){
    tbody.innerHTML = `<tr><td colspan="3" style="color:var(--muted)">Noch keine Fehlmuster.</td></tr>`;
  }else{
    rows.forEach(([focus, data])=>{
      const card = getCard(data.exampleNodeId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${focus}</td>
        <td>${data.count}</td>
        <td>${card ? card.nodeTitle : data.exampleNodeId}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  const strengths = [];
  if(acc >= 80) strengths.push("Trefferquote ist hoch.");
  if(avgTime && avgTime < 6000) strengths.push("Entscheidungen wirken sicher (Tempo).");
  if(doneCount >= 3) strengths.push("Gute Ausdauer.");

  if(strengths.length===0) strengths.push("Startphase: weiter spielen, dann wird die Diagnose präziser.");

  const focus = rows.length ? rows[0][0] : "Aufmerksamkeit";
  const mission = acc >= 80 ? "8 Minuten pro Tag. Schwierigkeit stabil halten." :
                 acc >= 60 ? "8 Minuten pro Tag. Hinweis nur bei Bedarf." :
                             "8 Minuten pro Tag. Text zuerst, dann Frage. Hinweis nutzen.";

  $("dCoach").innerHTML = `
    <b>Stärken</b>
    <ul style="margin:6px 0 12px 18px;">
      ${strengths.slice(0,3).map(s=>`<li>${s}</li>`).join("")}
    </ul>
    <b>Fokus</b>
    <div style="margin-top:6px;">
      <span class="pill">Top-Fokus: <b style="color:var(--txt)">${focus}</b></span>
    </div>
    <div style="margin-top:12px;"><b>Empfohlene Mission</b></div>
    <div style="margin-top:6px;color:var(--muted)">${mission}</div>
  `;
}

/** =========================
 *  Views
 *  ========================= */
function showPlay(){
  $("viewPlay").classList.remove("hidden");
  $("viewDash").classList.add("hidden");
  $("viewComplete").classList.add("hidden");
  $("btnPlay").classList.add("primary");
  $("btnDash").classList.remove("primary");
}

function showDash(){
  $("viewDash").classList.remove("hidden");
  $("viewPlay").classList.add("hidden");
  $("viewComplete").classList.add("hidden");
  $("btnDash").classList.add("primary");
  $("btnPlay").classList.remove("primary");
  renderDashboard();
}

function showComplete(){
  $("viewComplete").classList.remove("hidden");
  $("viewPlay").classList.add("hidden");
  $("viewDash").classList.add("hidden");
  $("btnPlay").classList.remove("primary");
  $("btnDash").classList.remove("primary");
}

/** =========================
 *  Complete Screen
 *  ========================= */
function renderComplete(){
  $("completeStars").textContent = `Sterne: ${state.stars}`;
  $("completeText").innerHTML = `
    Kapitel abgeschlossen.<br>
    Abgeschlossene Knoten: <b>${Object.keys(state.done).length}</b> / <b>${MAP.nodes.length}</b><br>
    Stufe am Ende: <b>${state.level}</b><br>
    Öffne die Diagnose, um Fehlmuster und Fokus zu sehen.
  `;
}

/** =========================
 *  Render All
 *  ========================= */
function renderAll(){
  renderTop();
  renderMap();

  if(state.chapterComplete){
    setMonster("Kapitel ist abgeschlossen. Diagnose zeigt die Auswertung.");
    renderComplete();
    return;
  }

  renderCard();

  // Default Guide Text (nicht überschreiben, wenn gerade Feedback gesetzt wurde)
  if(!state.logs.length){
    setMonster("Willkommen im Wald. Lies den Text. Beantworte die Frage. Weiter geht es über richtige Antworten.");
  }
}

/** =========================
 *  Buttons
 *  ========================= */
$("btnPlay").onclick = () => { showPlay(); renderAll(); };
$("btnDash").onclick = () => { showDash(); };
$("btnReset").onclick = () => {
  const ok = confirm("Alles zurücksetzen? Sterne, Fortschritt und Diagnose werden gelöscht.");
  if(!ok) return;
  state = defaultState();
  saveState();
  showPlay();
  setMonster("Reset durchgeführt. Starte neu.");
  renderAll();
};

$("btnReplay").onclick = () => {
  state = defaultState();
  saveState();
  showPlay();
  setMonster("Neu gestartet. Los geht es.");
  renderAll();
};
$("btnGoDash").onclick = () => showDash();

/** Init */
showPlay();
renderAll();
</script>
</body>
</html>
